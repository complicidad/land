<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Clases para el sidebar colapsable */
        .sidebar-expanded {
            width: 16rem; /* 64 * 0.25rem = 256px */
            padding: 1.5rem; /* 6 * 0.25rem = 24px */
            transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
            overflow: hidden;
        }
        .sidebar-collapsed {
            width: 0;
            padding: 0;
            opacity: 0;
            transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        .content-full {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }
        .content-shifted {
            margin-left: 16rem; /* 256px */
            transition: margin-left 0.3s ease;
        }
        /* Ocultar scrollbar pero permitir scroll */
        #product-search-results::-webkit-scrollbar { display: none; }
        #product-search-results { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-full">
    
    <!-- NUEVO: Contenedor de Autenticación -->
    <div id="auth-container" class="flex min-h-full flex-col justify-center items-center px-6 py-12 lg:px-8 bg-gray-100">
        <div class="sm:mx-auto sm:w-full sm:max-w-sm">
            <svg class="mx-auto h-10 w-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-orange-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0H21m-12 6.75h.008v.008H9v-.008zM12 15h.008v.008H12v-.008zM15 15h.008v.008H15v-.008zM9 15h.008v.008H9v-.008zm0-3.75h.008v.008H9v-.008zm3 0h.008v.008H12v-.008zm3 0h.008v.008H15v-.008zm3 0h.008v.008H18v-.008zm-9 7.5h.008v.008H9v-.008zm3 0h.008v.008H12v-.008zm3 0h.008v.008H15v-.008zm3 0h.008v.008H18v-.008z" />
            </svg>
            <h2 class="mt-4 text-center text-2xl font-bold leading-9 tracking-tight text-gray-900">Gestor de Negocio</h2>
        </div>

        <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
            <!-- Formulario de Login -->
            <form id="form-login" class="space-y-6">
                <h3 class="text-xl font-semibold text-gray-800">Iniciar Sesión</h3>
                <div>
                    <label for="login-email" class="block text-sm font-medium leading-6 text-gray-900">Correo Electrónico</label>
                    <div class="mt-2">
                        <input id="login-email" name="email" type="email" autocomplete="email" required class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                    </div>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium leading-6 text-gray-900">Contraseña</label>
                    <div class="mt-2">
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                    </div>
                </div>
                <div>
                    <button type="submit" class="flex w-full justify-center rounded-md bg-orange-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-orange-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600">Iniciar Sesión</button>
                </div>
            </form>

            <!-- Formulario de Registro -->
            <form id="form-register" class="space-y-6 mt-10 border-t border-gray-200 pt-10">
                <h3 class="text-xl font-semibold text-gray-800">¿Eres nuevo? Regístrate</h3>
                <div>
                    <label for="register-email" class="block text-sm font-medium leading-6 text-gray-900">Correo Electrónico</label>
                    <div class="mt-2">
                        <input id="register-email" name="email" type="email" autocomplete="email" required class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                    </div>
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium leading-6 text-gray-900">Contraseña (mínimo 6 caracteres)</label>
                    <div class="mt-2">
                        <input id="register-password" name="password" type="password" required class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-orange-600 sm:text-sm sm:leading-6">
                    </div>
                </div>
                <div>
                    <button type="submit" class="flex w-full justify-center rounded-md bg-gray-800 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-gray-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-800">Registrarse</button>
                </div>
            </form>
        </div>
    </div>


    <!-- NUEVO: Contenedor Principal de la App (oculto por defecto) -->
    <div id="app-container" class="h-full hidden">
        <!-- Barra Lateral Oscura (Sidebar) - Solo en Escritorio -->
        <aside id="sidebar" class="hidden sm:block fixed top-0 left-0 h-full bg-gray-800 text-white transition-all duration-300 ease-in-out sidebar-expanded z-20">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-white">Mi Negocio</h1>
            </div>
            <nav>
                <a href="#page-resumen" class="nav-link block py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                    Resumen
                </a>
                <a href="#page-productos" class="nav-link block py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0H21m-12 6.75h.008v.008H9v-.008zM12 15h.008v.008H12v-.008zM15 15h.008v.008H15v-.008zM9 15h.008v.008H9v-.008zm0-3.75h.008v.008H9v-.008zm3 0h.008v.008H12v-.008zm3 0h.008v.008H15v-.008zm3 0h.008v.008H18v-.008zm-9 7.5h.008v.008H9v-.008zm3 0h.008v.008H12v-.008zm3 0h.008v.008H15v-.008zm3 0h.008v.008H18v-.008z" /></svg>
                    Productos
                </a>
                <a href="#page-registrar-venta" class="nav-link block py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Registrar Venta
                </a>
                <a href="#page-registrar-compra" class="nav-link block py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Registrar Compra
                </a>
                <a href="#page-historial-ventas" class="nav-link block py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                    Historial de Ventas
                </a>
                <a href="#page-historial-compras" class="nav-link block py-3 px-6 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md">
                    <svg class="inline-block w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10.5 11.25h3M12 15V7.5" /></svg>
                    Historial de Compras
                </a>
            </nav>
        </aside>

        <!-- Contenedor Principal (Derecha) -->
        <div id="content" class="relative min-h-full sm:pb-0 pb-20 transition-all duration-300 ease-in-out content-shifted">
            
            <!-- Header Naranja -->
            <header class="sticky top-0 bg-orange-600 shadow-md text-white p-4 z-10">
                <div class="flex items-center justify-between">
                    <!-- Botón de Menú (Hamburguesa) - Solo Escritorio -->
                    <button id="sidebar-toggle" class="hidden sm:block p-2 rounded-md hover:bg-orange-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                    <!-- Título de la Página (se actualiza con JS) -->
                    <h1 id="header-title" class="text-xl font-bold">Resumen</h1>
                    <!-- Info de Usuario -->
                    <div class="flex items-center space-x-4">
                        <span id="user-display" class="text-sm hidden sm:block"></span>
                        <button id="logout-button" title="Cerrar Sesión" class="p-2 rounded-md hover:bg-orange-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Contenido de las Páginas -->
            <main class="p-6">
                <!-- Página: Resumen -->
                <section id="page-resumen" class="page active">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Resumen</h1>
                    <!-- Tarjetas de Métricas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Ingresos Totales -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-sm font-medium text-gray-500 mb-2">Ingresos Totales (Ventas)</h2>
                            <p id="total-ingresos" class="text-3xl font-bold text-green-600">S/ 0.00</p>
                        </div>
                        <!-- Costos Totales -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-sm font-medium text-gray-500 mb-2">Costos Totales (Compras)</h2>
                            <p id="total-costos" class="text-3xl font-bold text-red-600">S/ 0.00</p>
                        </div>
                        <!-- Ganancia Bruta -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-sm font-medium text-gray-500 mb-2">Ganancia Bruta</h2>
                            <p id="total-ganancia" class="text-3xl font-bold text-blue-600">S/ 0.00</p>
                        </div>
                    </div>
                    
                    <!-- Alerta de Stock Bajo -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Alerta de Stock Bajo (5 o menos)</h2>
                        <ul id="low-stock-list" class="space-y-2">
                            <li id="low-stock-empty" class="text-gray-500">¡Todo bien! No hay productos con stock bajo.</li>
                        </ul>
                    </div>
                    
                    <!-- NUEVO: Botón de Datos de Prueba -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Datos de Prueba</h2>
                        <p class="text-gray-600 mb-4">Usa este botón solo una vez (con tu cuenta nueva) para añadir datos de ejemplo y probar la app.</p>
                        <button id="mock-data-button" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600 transition-colors">
                            Añadir Datos de Prueba
                        </button>
                    </div>
                </section>

                <!-- Página: Productos -->
                <section id="page-productos" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Productos</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Inventario Actual</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <!-- NUEVO: Columna de SKU -->
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código (SKU)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Actual</th>
                                    </tr>
                                </thead>
                                <tbody id="inventario-list-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Los productos se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Página: Registrar Venta -->
                <section id="page-registrar-venta" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Registrar Venta</h1>
                    <form id="form-ventas" class="bg-white p-6 rounded-lg shadow-md space-y-4 max-w-xl mx-auto">
                        <!-- MODIFICADO: Buscador de Productos -->
                        <div class="relative">
                            <label for="venta-producto-search" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="venta-producto-search" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Escribe para buscar un producto..." autocomplete="off">
                            <input type="hidden" id="venta-sku-hidden">
                            
                            <!-- NUEVO: Contenedor de resultados del desplegable -->
                            <div id="product-search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden mt-1">
                                <!-- Los resultados se insertarán aquí -->
                            </div>
                        </div>
                        <div>
                            <label for="venta-cantidad" class="block text-sm font-medium text-gray-700">Cantidad Vendida</label>
                            <input type="number" id="venta-cantidad" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="venta-precio" class="block text-sm font-medium text-gray-700">Precio Total de Venta (S/)</label>
                            <input type="number" id="venta-precio" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 50.00">
                        </div>
                        <div>
                            <label for="venta-cliente-ws" class="block text-sm font-medium text-gray-700">WhatsApp del Cliente (Opcional)</label>
                            <input type="tel" id="venta-cliente-ws" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 987654321">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">Registrar Venta</button>
                    </form>
                </section>

                <!-- Página: Registrar Compra -->
                <section id="page-registrar-compra" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Registrar Compra</h1>
                    <form id="form-compras" class="bg-white p-6 rounded-lg shadow-md space-y-4 max-w-xl mx-auto">
                        <div>
                            <label for="compra-nombre" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="compra-nombre" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: Polo Negro Talla M">
                        </div>
                        <div>
                            <label for="compra-cantidad" class="block text-sm font-medium text-gray-700">Cantidad Comprada</S/)</label>
                            <input type="number" id="compra-cantidad" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="compra-costo" class="block text-sm font-medium text-gray-700">Costo Total de Compra (S/)</label>
                            <input type="number" id="compra-costo" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 200.00">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">Añadir al Inventario</button>
                    </form>
                </section>

                <!-- Página: Historial de Ventas -->
                <section id="page-historial-ventas" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Historial de Ventas</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Todas las Ventas</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <!-- NUEVO: Columna SKU -->
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <!-- NUEVO: Columna Cliente -->
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente (WhatsApp)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Total</th>
                                    </tr>
                                </thead>
                                <tbody id="historial-ventas-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Historial se insertará aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Página: Historial de Compras -->
                <section id="page-historial-compras" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Historial de Compras</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Todas las Compras</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Total</th>
                                    </tr>
                                </thead>
                                <tbody id="historial-compras-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Historial se insertará aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Menú de Navegación Inferior (Solo Móvil) -->
            <nav class="sm:hidden fixed bottom-0 left-0 w-full bg-gray-800 text-white flex justify-around p-2 shadow-lg z-20">
                <a href="#page-resumen" class="nav-link flex flex-col items-center p-2 text-gray-300 hover:text-white">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                    <span class="text-xs mt-1">Resumen</span>
                </a>
                <a href="#page-productos" class="nav-link flex flex-col items-center p-2 text-gray-300 hover:text-white">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0H21m-12 6.75h.008v.008H9v-.008zM12 15h.008v.008H12v-.008zM15 15h.008v.008H15v-.008zM9 15h.008v.008H9v-.008zm0-3.75h.008v.008H9v-.008zm3 0h.008v.008H12v-.008zm3 0h.008v.008H15v-.008zm3 0h.008v.008H18v-.008zm-9 7.5h.008v.008H9v-.008zm3 0h.008v.008H12v-.008zm3 0h.008v.008H15v-.008zm3 0h.008v.008H18v-.008z" /></svg>
                    <span class="text-xs mt-1">Stock</span>
                </a>
                <a href="#page-registrar-venta" class="nav-link flex flex-col items-center p-2 text-gray-300 hover:text-white">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="text-xs mt-1">Venta</span>
                </a>
                <a href="#page-registrar-compra" class="nav-link flex flex-col items-center p-2 text-gray-300 hover:text-white">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="text-xs mt-1">Compra</span>
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Modal de Mensajes -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
            <h3 id="message-title" class="text-xl font-bold mb-4"></h3>
            <p id="message-body" class="text-gray-700 mb-6"></p>
            <button id="message-close" class="w-full bg-orange-600 text-white font-bold py-2 px-4 rounded-md hover:bg-orange-700 transition-colors">Entendido</button>
        </div>
    </div>


    <!-- Scripts de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            getDoc,
            getDocs,
            updateDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            increment,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variables Globales de Firebase ---
        let app, db, auth;
        let userId; // El ID del usuario que ha iniciado sesión
        let inventarioCollection, ventasCollection, comprasCollection; // Colecciones de Firestore

        // --- Variables de Estado de la App ---
        let totalIngresos = 0;
        let totalCostos = 0;
        let inventarioCache = []; // Caché para la búsqueda de productos
        
        // --- Helper para formatear moneda ---
        const formatCurrency = (val) => `S/ ${(val || 0).toFixed(2)}`;
        
        // --- Helper para formatear fecha ---
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Fecha desconocida';
            return timestamp.toDate().toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        };

        // 1. Inicialización Principal al Cargar la Página
        document.addEventListener('DOMContentLoaded', () => {
            // Configuración de Firebase (usando variables de Canvas)
            const firebaseConfig = {
            apiKey: "AIzaSyBe_H0VfS-8K-n3Ihu-Io2q4SYDZAwbKoQ",
            authDomain: "compliventas-fc79c.firebaseapp.com",
            projectId: "compliventas-fc79c",
            storageBucket: "compliventas-fc79c.firebasestorage.app",
            messagingSenderId: "734491005717",
            appId: "1:734491005717:web:85f0be05bc345cfd6bcf1c"
            };
            const appId = 'mi-gestor-personal'; // O cualquier nombre simple

            // Inicializar Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Para ver logs detallados en la consola

            // Configurar listeners de autenticación (Login/Registro)
            setupAuthListeners();

            // Función clave: Escuchar cambios de estado de autenticación
            onAuthStateChanged(auth, (user) => {
                const authContainer = document.getElementById('auth-container');
                const appContainer = document.getElementById('app-container');

                if (user) {
                    // --- Usuario HA INICIADO SESIÓN ---
                    userId = user.uid;
                    console.log("Usuario autenticado:", userId);
                    document.getElementById('user-display').textContent = `Usuario: ${user.email}`;

                    // Definir las colecciones con el path de seguridad correcto
                    const basePath = `/artifacts/${appId}/users/${userId}`;
                    inventarioCollection = collection(db, `${basePath}/inventario`);
                    ventasCollection = collection(db, `${basePath}/ventas`);
                    comprasCollection = collection(db, `${basePath}/compras`);

                    // Mostrar la app y ocultar el login
                    authContainer.style.display = 'none';
                    appContainer.classList.remove('hidden');

                    // Inicializar la lógica principal de la app
                    initializeAppLogic();

                } else {
                    // --- Usuario NO HA INICIADO SESIÓN ---
                    console.log("Usuario no autenticado.");
                    userId = null;
                    
                    // Mostrar el login y ocultar la app
                    authContainer.style.display = 'flex';
                    appContainer.classList.add('hidden');
                }
            });
        });

        // 2. Lógica de Autenticación (Login, Registro, Logout)
        function setupAuthListeners() {
            const formLogin = document.getElementById('form-login');
            const formRegister = document.getElementById('form-register');
            const logoutButton = document.getElementById('logout-button');

            formLogin.addEventListener('submit', handleLogin);
            formRegister.addEventListener('submit', handleRegister);
            logoutButton.addEventListener('click', handleSignOut);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target['login-email'].value;
            const password = e.target['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará del resto
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                showMessage("Error de Login", getFirebaseErrorMessage(error));
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = e.target['register-email'].value;
            const password = e.target['register-password'].value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará del resto
            } catch (error) {
                console.error("Error al registrarse:", error);
                showMessage("Error de Registro", getFirebaseErrorMessage(error));
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                // onAuthStateChanged se encargará de mostrar el login
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage("Error", "No se pudo cerrar la sesión.");
            }
        }
        
        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'El correo electrónico no es válido.';
                case 'auth/user-not-found':
                    return 'No se encontró un usuario con ese correo.';
                case 'auth/wrong-password':
                    return 'La contraseña es incorrecta.';
                case 'auth/email-already-in-use':
                    return 'Ese correo electrónico ya está registrado.';
                case 'auth/weak-password':
                    return 'La contraseña debe tener al menos 6 caracteres.';
                default:
                    return 'Ocurrió un error. Revisa la consola para más detalles.';
            }
        }


        // 3. Lógica Principal de la App (Se llama DESPUÉS del login)
        function initializeAppLogic() {
            setupNavigation();
            setupSidebarToggle();
            setupForms();
            setupModal();
            setupMockDataButton(); // Configurar el botón de datos de prueba

            // Iniciar los listeners de la base de datos
            listenToInventario();
            listenToVentas();
            listenToCompras();

            // Mostrar la página de resumen por defecto
            showPage('page-resumen');
        }

        // 4. Configuración de Navegación (Menús y Páginas)
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const headerTitle = document.getElementById('header-title');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    showPage(targetId);
                    
                    // Actualizar título del header
                    const linkText = link.innerText.trim();
                    headerTitle.textContent = linkText;
                });
            });
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // 5. Configuración del Sidebar Colapsable
        function setupSidebarToggle() {
            const toggleButton = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');

            toggleButton.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-expanded');
                sidebar.classList.toggle('sidebar-collapsed');
                content.classList.toggle('content-shifted');
                content.classList.toggle('content-full');
            });
        }
        
        // 6. Configuración de Formularios
        function setupForms() {
            const formCompras = document.getElementById('form-compras');
            const formVentas = document.getElementById('form-ventas');

            formCompras.addEventListener('submit', handleCompra);
            formVentas.addEventListener('submit', handleVenta);
            
            setupProductSearch(); // Inicializar el buscador
        }

        // 7. Manejar Compra (Añadir a Stock)
        async function handleCompra(e) {
            e.preventDefault();
            const form = e.target;
            const nombre = form['compra-nombre'].value.trim();
            const cantidad = parseInt(form['compra-cantidad'].value);
            const costo = parseFloat(form['compra-costo'].value);

            if (!nombre || cantidad <= 0 || costo < 0) {
                showMessage("Datos incompletos", "Por favor, ingresa nombre, cantidad y costo válidos.");
                return;
            }

            try {
                // Buscar si el producto ya existe (por nombre)
                const productRef = await findProductByName(nombre);
                let stockFinal = 0;

                if (productRef) {
                    // Producto existe, actualizar stock
                    await updateDoc(productRef, { stock: increment(cantidad) });
                    const updatedDoc = await getDoc(productRef);
                    stockFinal = updatedDoc.data().stock;
                } else {
                    // Producto nuevo, generar SKU y crearlo
                    const newProductRef = await addDoc(inventarioCollection, { 
                        nombre: nombre, 
                        stock: cantidad, 
                        sku: 'generando...' // SKU temporal
                    });
                    const sku = newProductRef.id.substring(0, 8).toUpperCase();
                    await updateDoc(newProductRef, { sku: sku }); // Actualizar con el SKU real
                    stockFinal = cantidad;
                }

                await addDoc(comprasCollection, {
                    producto: nombre,
                    cantidad: cantidad,
                    costo: costo,
                    fecha: serverTimestamp()
                });

                showMessage("Éxito", `¡Compra registrada! Stock actual de "${nombre}": ${stockFinal} unidades.`);
                form.reset();
                showPage('page-productos'); // <-- Redirige a Productos
            
            } catch (error) {
                console.error("Error al registrar compra:", error);
                showMessage("Error", "No se pudo registrar la compra. Revisa la consola.");
            }
        }

        // 8. Manejar Venta (Descontar de Stock)
        async function handleVenta(e) {
            e.preventDefault();
            const form = e.target;
            // Obtener SKU del campo oculto
            const sku = form['venta-sku-hidden'].value.trim().toUpperCase(); 
            const nombreInput = form['venta-producto-search'].value; // Para validación
            const cantidad = parseInt(form['venta-cantidad'].value);
            const precio = parseFloat(form['venta-precio'].value);
            const clienteWs = form['venta-cliente-ws'].value.trim();

            if (!sku || !nombreInput || cantidad <= 0 || precio < 0) { 
                showMessage("Datos incompletos", "Por favor, busca y selecciona un producto válido, luego ingresa cantidad y precio.");
                return;
            }

            try {
                const productRef = await findProductBySku(sku); // Sigue buscando por SKU (más preciso)
                if (!productRef) {
                    showMessage("Error", `El producto seleccionado ya no existe.`);
                    return;
                }

                const productSnap = await getDoc(productRef);
                const currentStock = productSnap.data().stock;
                const nombre = productSnap.data().nombre; // Obtener nombre para mensajes

                if (currentStock < cantidad) {
                    showMessage("Stock Insuficiente", `No puedes vender ${cantidad} unidades de "${nombre}". Solo quedan ${currentStock}.`);
                    return;
                }

                await updateDoc(productRef, { stock: increment(-cantidad) });

                await addDoc(ventasCollection, {
                    producto: nombre,
                    sku: sku, // Guardar SKU en la venta
                    cantidad: cantidad,
                    precio: precio,
                    clienteWhatsApp: clienteWs, // Guardar en DB
                    fecha: serverTimestamp()
                });

                showMessage("Éxito", `¡Venta registrada! Stock restante de "${nombre}": ${currentStock - cantidad} unidades.`);
                form.reset();
                form['venta-producto-search'].value = ''; // Limpiar campos manualmente
                form['venta-sku-hidden'].value = '';
                showPage('page-resumen'); // <-- Redirige al Resumen

            } catch (error) {
                console.error("Error al registrar venta:", error);
                showMessage("Error", "No se pudo registrar la venta. Revisa la consola.");
            }
        }
        
        // 9. Funciones de Ayuda (Buscar Producto)
        async function findProductByName(nombre) {
            if (!inventarioCollection) return null;
            const q = query(inventarioCollection, where("nombre", "==", nombre));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                return null; // No encontrado
            } else {
                return querySnapshot.docs[0].ref; // Devuelve la referencia al documento
            }
        }

        async function findProductBySku(sku) {
            if (!inventarioCollection) return null;
            const q = query(inventarioCollection, where("sku", "==", sku));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                return null; // No encontrado
            } else {
                return querySnapshot.docs[0].ref; // Devuelve la referencia al documento
            }
        }

        // 10. Lógica para Buscador de Productos (Autocompletado)
        function setupProductSearch() {
            const searchInput = document.getElementById('venta-producto-search');
            const resultsContainer = document.getElementById('product-search-results');
            const hiddenSkuInput = document.getElementById('venta-sku-hidden');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                hiddenSkuInput.value = ''; // Limpiar SKU si el usuario edita el nombre

                if (searchTerm.length === 0) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                const filtered = inventarioCache.filter(p => 
                    p.nombre.toLowerCase().includes(searchTerm) || 
                    p.sku.toLowerCase().includes(searchTerm)
                );
                
                showSearchResults(filtered, searchInput, resultsContainer, hiddenSkuInput);
            });
            
            searchInput.addEventListener('focus', () => {
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm.length > 0) {
                     const filtered = inventarioCache.filter(p => 
                        p.nombre.toLowerCase().includes(searchTerm) || 
                        p.sku.toLowerCase().includes(searchTerm)
                    );
                    showSearchResults(filtered, searchInput, resultsContainer, hiddenSkuInput);
                }
            });

            // Ocultar resultados si se hace clic fuera
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    resultsContainer.classList.add('hidden');
                }, 200); // Pequeño retraso para permitir el clic en un resultado
            });
        }

        function showSearchResults(results, searchInput, resultsContainer, hiddenSkuInput) {
            resultsContainer.innerHTML = ''; // Limpiar resultados anteriores
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="p-3 text-sm text-gray-500">No hay coincidencias.</div>`;
                resultsContainer.classList.remove('hidden');
                return;
            }

            results.forEach(product => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                resultDiv.innerHTML = `
                    <div class="font-medium text-gray-800">${product.nombre}</div>
                    <div class="text-sm text-gray-500">
                        SKU: ${product.sku} - Stock: <span class="font-bold ${product.stock <= 5 ? 'text-red-500' : 'text-gray-700'}">${product.stock}</span>
                    </div>
                `;
                
                // Evento al hacer clic en un resultado
                resultDiv.addEventListener('mousedown', () => {
                    searchInput.value = product.nombre; // Poner nombre en el input
                    hiddenSkuInput.value = product.sku;  // Guardar SKU en el campo oculto
                    resultsContainer.classList.add('hidden'); // Ocultar desplegable
                });
                
                resultsContainer.appendChild(resultDiv);
            });

            resultsContainer.classList.remove('hidden');
        }

        // 11. Listeners de Firestore (Actualización en Tiempo Real)
        function listenToInventario() {
            if (!inventarioCollection) return;
            onSnapshot(inventarioCollection, (snapshot) => {
                const tableBody = document.getElementById('inventario-list-table');
                const lowStockList = document.getElementById('low-stock-list');
                const emptyMsg = document.getElementById('low-stock-empty');
                
                tableBody.innerHTML = '';
                lowStockList.innerHTML = '';
                emptyMsg.style.display = 'none';
                
                inventarioCache = []; // Limpiar caché antes de rellenar

                const docs = snapshot.docs;
                docs.sort((a, b) => a.data().nombre.localeCompare(b.data().nombre));

                if (docs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-gray-500 text-center">No hay productos en tu inventario.</td></tr>';
                }

                let lowStockCount = 0;

                docs.forEach(doc => {
                    const item = doc.data();
                    const stockClass = item.stock <= 5 ? 'text-red-600 font-bold' : 'text-gray-900';
                    
                    // Llenar caché para búsqueda
                    inventarioCache.push({ id: doc.id, ...item });

                    // 1.1: Llenar la tabla de Productos
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">${item.sku}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${item.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${stockClass}">${item.stock} unidades</td>
                    `;
                    tableBody.appendChild(row);

                    // 1.2: Llenar la lista de Stock Bajo (en Resumen)
                    if (item.stock <= 5) {
                        lowStockCount++;
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center text-sm';
                        li.innerHTML = `
                            <span class="font-medium text-gray-800">${item.nombre} (SKU: ${item.sku})</span>
                            <span class="font-bold text-red-600">${item.stock} unidades</span>
                        `;
                        lowStockList.appendChild(li);
                    }
                });

                if (lowStockCount > 0) {
                    emptyMsg.style.display = 'none';
                } else {
                    lowStockList.appendChild(emptyMsg);
                    emptyMsg.style.display = 'block';
                }
            });
        }

        function listenToVentas() {
            if (!ventasCollection) return;
            onSnapshot(ventasCollection, (snapshot) => {
                const tableBody = document.getElementById('historial-ventas-list');
                const totalIngresosEl = document.getElementById('total-ingresos');
                
                tableBody.innerHTML = '';
                totalIngresos = 0; // Reiniciar
                
                const docs = snapshot.docs;
                docs.sort((a, b) => b.data().fecha - a.data().fecha); // Más recientes primero

                if (docs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-gray-500 text-center">No has registrado ninguna venta.</td></tr>';
                }
                
                docs.forEach(doc => {
                    const venta = doc.data();
                    totalIngresos += venta.precio || 0;
                    const clienteDisplay = venta.clienteWhatsApp || 'N/A'; 
                    const skuDisplay = venta.sku || 'N/A'; 
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(venta.fecha)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">${skuDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${venta.producto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${clienteDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${venta.cantidad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrency(venta.precio)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                totalIngresosEl.textContent = formatCurrency(totalIngresos);
                updateGanancia();
            });
        }
        
        function listenToCompras() {
            if (!comprasCollection) return;
            onSnapshot(comprasCollection, (snapshot) => {
                const tableBody = document.getElementById('historial-compras-list');
                const totalCostosEl = document.getElementById('total-costos');
                
                tableBody.innerHTML = '';
                totalCostos = 0; // Reiniciar

                const docs = snapshot.docs;
                docs.sort((a, b) => b.data().fecha - a.data().fecha); // Más recientes primero
                
                if (docs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-gray-500 text-center">No has registrado ninguna compra.</td></tr>';
                }

                docs.forEach(doc => {
                    const compra = doc.data();
                    totalCostos += compra.costo || 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(compra.fecha)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${compra.producto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${compra.cantidad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">${formatCurrency(compra.costo)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                totalCostosEl.textContent = formatCurrency(totalCostos);
                updateGanancia();
            });
        }
        
        function updateGanancia() {
            const totalGananciaEl = document.getElementById('total-ganancia');
            const ganancia = totalIngresos - totalCostos;
            totalGananciaEl.textContent = formatCurrency(ganancia);
            
            if (ganancia > 0) {
                totalGananciaEl.className = 'text-3xl font-bold text-blue-600';
            } else {
                totalGananciaEl.className = 'text-3xl font-bold text-red-600';
            }
        }

        // 12. Modal de Mensajes
        function setupModal() {
            const modal = document.getElementById('message-modal');
            const closeButton = document.getElementById('message-close');
            closeButton.onclick = () => {
                modal.style.display = 'none';
            };
        }
        
        function showMessage(title, body) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-modal').style.display = 'flex';
        }

        // 13. Lógica para Datos de Prueba
        function setupMockDataButton() {
            const mockButton = document.getElementById('mock-data-button');
            mockButton.addEventListener('click', addMockData);
        }

        async function addMockData() {
            if (!inventarioCollection) return;
            
            // Comprobar si ya hay datos para no duplicar
            const checkSnap = await getDocs(query(inventarioCollection));
            if (!checkSnap.empty) {
                showMessage("Datos de Prueba", "Parece que ya tienes productos en tu inventario. No se añadirán más datos.");
                return;
            }
            
            try {
                showMessage("Procesando...", "Añadiendo datos de prueba. Esto puede tardar un momento.");

                // 1. Añadir Productos (a través de Compras)
                // Producto 1: Polos
                let poloRef = await addDoc(inventarioCollection, { nombre: "Polo Negro", stock: 20, sku: '...' });
                let poloSku = poloRef.id.substring(0, 8).toUpperCase();
                await updateDoc(poloRef, { sku: poloSku });
                await addDoc(comprasCollection, {
                    producto: "Polo Negro",
                    cantidad: 20,
                    costo: 200, // 10 c/u
                    fecha: serverTimestamp()
                });

                // Producto 2: Gorras
                let gorraRef = await addDoc(inventarioCollection, { nombre: "Gorra Roja", stock: 15, sku: '...' });
                let gorraSku = gorraRef.id.substring(0, 8).toUpperCase();
                await updateDoc(gorraRef, { sku: gorraSku });
                await addDoc(comprasCollection, {
                    producto: "Gorra Roja",
                    cantidad: 15,
                    costo: 150, // 10 c/u
                    fecha: serverTimestamp()
                });

                // Producto 3: Tote Bag
                let toteRef = await addDoc(inventarioCollection, { nombre: "Tote Bag", stock: 30, sku: '...' });
                let toteSku = toteRef.id.substring(0, 8).toUpperCase();
                await updateDoc(toteRef, { sku: toteSku });
                await addDoc(comprasCollection, {
                    producto: "Tote Bag",
                    cantidad: 30,
                    costo: 180, // 6 c/u
                    fecha: serverTimestamp()
                });
                
                // Producto 4: Polo Blanco (Stock bajo)
                let poloBRef = await addDoc(inventarioCollection, { nombre: "Polo Blanco", stock: 5, sku: '...' });
                let poloBSku = poloBRef.id.substring(0, 8).toUpperCase();
                await updateDoc(poloBRef, { sku: poloBSku });
                await addDoc(comprasCollection, {
                    producto: "Polo Blanco",
                    cantidad: 5,
                    costo: 50, // 10 c/u
                    fecha: serverTimestamp()
                });

                // 2. Añadir Ventas (y descontar stock)
                // Venta 1: 2 Polos Negros
                await updateDoc(poloRef, { stock: increment(-2) });
                await addDoc(ventasCollection, {
                    producto: "Polo Negro",
                    sku: poloSku, 
                    cantidad: 2,
                    precio: 60, // 30 c/u
                    clienteWhatsApp: '987654321',
                    fecha: serverTimestamp()
                });
                
                // Venta 2: 1 Gorra Roja
                await updateDoc(gorraRef, { stock: increment(-1) });
                await addDoc(ventasCollection, {
                    producto: "Gorra Roja",
                    sku: gorraSku, 
                    cantidad: 1,
                    precio: 20,
                    clienteWhatsApp: '',
                    fecha: serverTimestamp()
                });
                
                // Venta 3: 5 Tote Bags
                await updateDoc(toteRef, { stock: increment(-5) });
                await addDoc(ventasCollection, {
                    producto: "Tote Bag",
                    sku: toteSku,
                    cantidad: 5,
                    precio: 75, // 15 c/u
                    clienteWhatsApp: '999888777',
                    fecha: serverTimestamp()
                });
                
                showMessage("¡Éxito!", "Se añadieron 4 productos, 3 ventas y 4 compras de ejemplo.");
            
            } catch (error) {
                console.error("Error al añadir datos de prueba:", error);
                showMessage("Error", "No se pudieron añadir los datos de prueba. Revisa la consola.");
            }
        }

    </script>
</body>
</html>

