<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agenda tu env√≠o</title>

    <!-- Meta Tags OGP y Twitter (se mantienen sin cambios) -->
    <meta property="og:title" content="Agenda tu env√≠o" />
    <meta property="og:description" content="Agenda tu env√≠o de manera simple, r√°pida y segura." />
    <meta property="og:image" content="https://complicidad.github.io/form/Spin.png" />
    <meta property="og:url" content="https://complicidad.github.io/form" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Agenda tu env√≠o" />
    <meta name="twitter:description" content="Agenda tu env√≠o de manera simple, r√°pida y segura." />
    <meta name="twitter:image" content="https://complicidad.github.io/form/Spin.png" />

    <!-- SDKs de Firebase (CORREGIDOS A VERSI√ìN 8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- A√ëADIDO: SDK de App Check -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app-check.js"></script>

    <!-- jQuery (se mantiene para la l√≥gica existente) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Fuente Quicksand (Alineada con tu landing page) -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraci√≥n de Tailwind para usar la fuente Quicksand y colores de marca */
        @layer base {
            body {
                font-family: 'Quicksand', sans-serif;
            }
        }
        
        /* Definici√≥n de colores de marca para su uso en clases personalizadas */
        :root {
            --brand-accent: #D96B4F;
            --brand-accent-alt: #FF8B6A;
            --danger-color: #d93025; 
        }
        
        /* Estilos personalizados para manejo de estados (Tailwind no permite `!important` en focus/invalid sin config extendida) */
        .is-invalid {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 3px rgba(217, 48, 37, 0.15) !important;
        }

        /* Keyframes para el spinner */
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
          animation: spin 1s linear infinite;
        }

    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#fffaf6',
                        'brand-card': '#ffffff',
                        'brand-text': '#2b2b2b',
                        'brand-muted': '#6b6b6b',
                        'brand-accent': '#D96B4F', // Terracota principal
                        'brand-accent-alt': '#FF8B6A', // Terracota claro para hover/sombra
                        danger: '#d93025',
                    },
                    borderRadius: {
                        'xl': '12px',
                    },
                    fontFamily: {
                        'quicksand': ['Quicksand', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body class="flex flex-col bg-brand-bg text-brand-text">

    <!-- Contenedor principal del formulario (main) -->
    <main class="flex-grow p-5 max-w-xl mx-auto font-quicksand w-full">

        <!-- La tarjeta usa el fondo blanco (brand-card) -->
        <div class="bg-brand-card p-6 md:p-8 rounded-xl shadow-2xl">

        <!-- Logo -->
        <div class="text-center p-4">
            <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Logo Complicidad" class="max-w-[225px] h-auto inline-block">
        </div>      
            
            
            <form id="formulario" novalidate>

                <h2 class="mt-[0px] mb-2 text-center text-2xl font-bold text-brand-text">Agenda tu env√≠o</h2>

                <!-- Campo 1: WhatsApp usado -->
                <!-- UX: Se usa type="tel" para facilitar el input en m√≥vil y se a√±ade asterisco -->
                <label for="telefonoUsado" class="block mt-4 font-semibold text-sm text-brand-text">WhatsApp con el que compraste <span class="text-danger">*</span></label>
                <input
                    type="tel"
                    id="telefonoUsado"
                    name="telefonoUsado"
                    required
                    placeholder="Ej. 9XXXXXXXX"
                    pattern="^9\d{8}$"
                    title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos (debe empezar con 9)"
                    class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"
                />

                <!-- Campo 2: Tipo de servicio -->
                <label for="tipoAccion" class="block mt-4 font-semibold text-sm text-brand-text">Selecciona el tipo de servicio <span class="text-danger">*</span></label>
                <select id="tipoAccion" name="tipoAccion" required
                    class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text">
                    <option value="" disabled selected>Elige una opci√≥n</option>
                    <option value="delivery">Env√≠o a domicilio/trabajo (Delivery)</option>
                    <option value="shalom">Retiro en agencia Shalom</option>
                    <!-- <option value="recoger">Recoger en almac√©n</option> -->
                    <option value="usado">Usar mi direcci√≥n registrada</option>
                </select>

                <!-- Fieldset: Delivery -->
                <fieldset id="camposDelivery" class="mt-8 border-none p-0" hidden>
                    <legend class="text-xl font-bold mb-1 text-brand-text">üì¶ Delivery</legend>
                    <p class="text-sm text-brand-muted mb-3">Datos de la persona que recibir√° el pedido.</p>

                    <label for="nombreDelivery" class="block mt-4 font-semibold text-sm text-brand-text">Nombre: <span class="text-danger">*</span></label>
                    <input type="text" id="nombreDelivery" name="nombre" required
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                    <label for="telefonoDelivery" class="block mt-4 font-semibold text-sm text-brand-text">Tel√©fono: <span class="text-danger">*</span></label>
                    <input
                        type="tel"
                        id="telefonoDelivery"
                        name="telefono"
                        required
                        pattern="^9\d{8}$"
                        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"
                    />
                    
                    <!-- UX: Checkbox para usar el n√∫mero de WhatsApp principal -->
                    <div class="mt-1 flex items-center">
                        <input type="checkbox" id="usarMismoTelefonoDelivery" class="h-4 w-4 text-brand-accent rounded border-gray-300 focus:ring-brand-accent-alt" />
                        <label for="usarMismoTelefonoDelivery" class="ml-2 block text-sm text-brand-muted cursor-pointer">Usar mi n√∫mero de WhatsApp (<span id="telefonoDisplayDelivery" class="font-semibold"></span>)</label>
                    </div>

                    <label for="distrito" class="block mt-4 font-semibold text-sm text-brand-text">Distrito: <span class="text-danger">*</span></label>
                    <input type="text" id="distrito" name="distrito" required readonly
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 cursor-pointer text-brand-text" />

                    <label for="direccion" class="block mt-4 font-semibold text-sm text-brand-text">Direcci√≥n: <span class="text-danger">*</span></label>
                    <input type="text" id="direccion" name="direccion" required
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                    <label for="referencia" class="block mt-4 font-semibold text-sm text-brand-text">Referencia: <span class="text-danger">*</span></label>
                    <input type="text" id="referencia" name="referencia" required
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />
                    
                    <!-- Modal oculto para Distritos -->
                    <div class="modal hidden fixed inset-0 bg-brand-text bg-opacity-50 z-50 flex justify-center items-start pt-5 pb-5" id="modalDistrito">
                        <!-- CAMBIOS: Se quit√≥ 'overflow-y-auto', se a√±adi√≥ 'flex flex-col overflow-hidden' -->
                        <div class="modal-content bg-brand-card p-5 rounded-xl w-[350px] max-h-[95vh] shadow-2xl flex flex-col overflow-hidden">
                            <input type="text" id="buscadorDistrito" placeholder="Buscar distrito..."
                                class="w-full p-2 mb-3 rounded-lg border border-gray-300 focus:border-brand-accent focus:ring-2 focus:ring-brand-accent-alt/40 text-brand-text" />
                            <!-- CAMBIOS: Se quit√≥ 'max-h-80vh', se a√±adi√≥ 'overflow-y-auto' para que esta lista sea la que scrollee -->
                            <div id="listaDistritos" class="list list-none p-0 m-0 text-brand-text overflow-y-auto"></div>
                        </div>
                    </div>
                </fieldset>

                <!-- Fieldset: Shalom -->
                <fieldset id="camposShalom" class="mt-8 border-none p-0" hidden>
                    <legend class="text-xl font-bold mb-1 text-brand-text">üì¶ Shalom</legend>
                    <p class="text-sm text-brand-muted mb-3">Datos para retiro en agencia Shalom.</p>

                    <label for="nombreShalom" class="block mt-4 font-semibold text-sm text-brand-text">Nombre completo: <span class="text-danger">*</span></label>
                    <input type="text" id="nombreShalom" name="nombre" required
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                    <label for="telefonoShalom" class="block mt-4 font-semibold text-sm text-brand-text">Tel√©fono: <span class="text-danger">*</span></label>
                    <input
                        type="tel"
                        id="telefonoShalom"
                        name="telefono"
                        required
                        pattern="^9\d{8}$"
                        title="Ingresa un n√∫mero de tel√©fono v√°lido de 9 d√≠gitos"
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"
                    />
                    
                    <!-- UX: Checkbox para usar el n√∫mero de WhatsApp principal -->
                    <div class="mt-1 flex items-center">
                        <input type="checkbox" id="usarMismoTelefonoShalom" class="h-4 w-4 text-brand-accent rounded border-gray-300 focus:ring-brand-accent-alt" />
                        <label for="usarMismoTelefonoShalom" class="ml-2 block text-sm text-brand-muted cursor-pointer">Usar mi n√∫mero de WhatsApp (<span id="telefonoDisplayShalom" class="font-semibold"></span>)</label>
                    </div>

                    <label for="DNI" class="block mt-4 font-semibold text-sm text-brand-text">DNI/CE: <span class="text-danger">*</span></label>
                    <!-- UX: Se a√±ade pattern para DNI (8 d√≠gitos) o CE (5-15 alfanum√©ricos) -->
                    <input type="text" id="DNI" name="DNI" required pattern="[A-Za-z0-9]{5,15}" title="Ingresa un DNI (8 d√≠gitos) o CE v√°lido (5-15 caracteres)"
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text" />

                    <label for="agencia" class="block mt-4 font-semibold text-sm text-brand-text">Agencia: <span class="text-danger">*</span></label>
                    <input type="text" id="agencia" name="agencia" required readonly
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 cursor-pointer text-brand-text" />
                    
                    <!-- Modal oculto para Agencias -->
                    <div class="modal hidden fixed inset-0 bg-brand-text bg-opacity-50 z-50 flex justify-center items-start pt-5 pb-5" id="modalAgencia">
                        <!-- CAMBIOS: Se quit√≥ 'overflow-y-auto', se a√±adi√≥ 'flex flex-col overflow-hidden' -->
                        <div class="modal-content bg-brand-card p-5 rounded-xl w-[350px] max-h-[95vh] shadow-2xl flex flex-col overflow-hidden">
                            <input type="text" id="buscadorAgencia" placeholder="Buscar agencia..."
                                class="w-full p-2 mb-3 rounded-lg border border-gray-300 focus:border-brand-accent focus:ring-2 focus:ring-brand-accent-alt/40 text-brand-text" />
                            <!-- CAMBIOS: Se quit√≥ 'max-h-80vh', se a√±adi√≥ 'overflow-y-auto' -->
                            <div id="listaAgencias" class="list list-none p-0 m-0 text-brand-text overflow-y-auto"></div>
                        </div>
                    </div>
                </fieldset>

                <!-- Fieldset: Usado -->
                <fieldset id="camposUsados" class="mt-8 border-none p-0" hidden>
                    <legend class="text-xl font-bold mb-1 text-brand-text">üì¶ Direcci√≥n registrada</legend>
                    <p class="text-sm text-brand-muted mb-3">Usaremos tu direcci√≥n guardada.</p>
                </fieldset>

                <!-- Campo de fecha reutilizable -->
                <div id="contenedorFecha" class="mt-4" style="display: none;">
                    <label for="fecha" class="block font-semibold text-sm text-brand-text">Fecha de env√≠o: <span class="text-danger">*</span></label>
                    <select id="fecha" name="fecha" required
                        class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white outline-none transition duration-150 ease-in-out focus:border-brand-accent focus:ring-4 focus:ring-brand-accent-alt/40 text-brand-text"></select>
                </div>

                <!-- Bot√≥n de env√≠o, con el nuevo color de acento -->
                <div class="flex justify-center w-full mt-6">
                    <button type="submit"
                        class="p-3 text-lg cursor-pointer bg-brand-accent text-white font-semibold border-none rounded-xl w-full transition duration-150 ease-in-out hover:bg-brand-accent-alt shadow-lg">
                        Confirmar y agendar env√≠o
                    </button>
                </div>

                <!-- Texto de privacidad -->
                <div class="mt-4 text-sm text-brand-muted text-center">
                    Usaremos tus datos solo para procesar y entregar tu pedido.
                    <a href="https://complicidad.github.io/privacy/" target="_blank" class="text-brand-accent hover:text-brand-accent-alt underline">Ver pol√≠tica de privacidad</a>
                </div>

            </form>

            <!-- =========== NUEVO BLOQUE DE √âXITO - INICIO =========== -->
            <div id="successMessage" class="hidden flex-col items-center justify-center p-4 text-center">
                <!-- Icono de Check (SVG) -->
                <svg class="w-16 h-16 text-brand-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <h2 class="mt-4 text-2xl font-bold text-brand-text">¬°Env√≠o agendado con √©xito!</h2>
                <p class="mt-2 text-brand-muted">Tu pedido ha sido registrado. Gracias por tu confianza.</p>

                <!-- Redes sociales (MOVIDAS AQU√ç) -->
                <p class="mt-6 font-semibold text-brand-text">Mientras esperas, ¬°s√≠guenos!</p>
                <div class="mt-4 flex justify-center gap-4">
                    <a href="https://wa.me/51981391159" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:opacity-80 transition">
                        <img src="https://raw.githubusercontent.com/complicidad/form/main/whatsapp.png" alt="WhatsApp" width="28" height="28">
                    </a>
                    <a href="https://www.tiktok.com/@complicidadboutique" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:opacity-80 transition">
                        <img src="https://raw.githubusercontent.com/complicidad/form/main/tik-tok.png" alt="TikTok" width="28" height="28">
                    </a>
                    <a href="https://www.instagram.com/complicidadboutique" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:opacity-80 transition">
                        <img src="https://raw.githubusercontent.com/complicidad/form/main/instagram.png" alt="Instagram" width="28" height="28">
                    </a>
                </div>

            </div>
            <!-- =========== NUEVO BLOQUE DE √âXITO - FIN =========== -->

        </div>
    </main>

        <footer class="mt-0 mb-5 text-center text-gray-500 text-xs">
            <!-- La atribuci√≥n a la herramienta ahora se omite en la vista del usuario final. -->
            <p>Hecho con ‚ù§Ô∏è para tu emprendimiento.</p>
        </footer>

    <!-- Toast de Notificaci√≥n (Nuevo estilo) -->
    <div class="toast fixed right-5 top-5 text-white p-3 rounded-xl shadow-xl shadow-brand-accent/25 opacity-0 translate-y-2 transition-all duration-300 z-50 max-w-sm" id="toast">Acci√≥n aplicada</div>


    <!-- SPINNER DE CARGA CORREGIDO -->
    <!-- Se a√±adieron 'inset-0' para cubrir toda la pantalla y 'justify-center items-center' para centrar el contenido. -->
    <div id="spinner" class="fixed inset-0 bg-brand-bg bg-opacity-85 z-50 flex justify-center items-center flex-col hidden">
        <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Cargando..." class="w-[150px] h-auto animate-spin-custom">
        <p class="mt-4 text-lg text-brand-text">Cargando...</p>
    </div>
    
    <!-- Script para los modales de lista. -->
    <script>

        // Se elimina la funci√≥n updateMessageClasses antigua.
        
        // --- L√≥gica del modal de Distritos (Vanilla JS) ---
        const campoDistrito = document.getElementById("distrito");
        const overlay = document.getElementById("modalDistrito");
        const buscador = document.getElementById("buscadorDistrito");
        const listaDistritos = document.getElementById("listaDistritos");
        let distritos = [];
        
        // Abrir popup al hacer click en el campo
        campoDistrito.addEventListener("click", () => {
          overlay.style.display = "flex";
          buscador.value = "";
          mostrarDistritos(distritos);
          buscador.focus();
        });
        
        // Cerrar popup si clic fuera de la caja
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            overlay.style.display = "none";
          }
        });
        
        // Buscar distritos
        buscador.addEventListener("input", () => {
          const filtro = buscador.value.toLowerCase();
          const filtrados = distritos.filter(d => d.toLowerCase().includes(filtro));
          mostrarDistritos(filtrados);
        });
        
        // Mostrar lista en el popup
        function mostrarDistritos(lista) {
          listaDistritos.innerHTML = "";
          lista.forEach(d => {
            const div = document.createElement("div");
            // Clases de Tailwind para el item de la lista
            div.className = "p-2 cursor-pointer border-b border-gray-100 hover:bg-gray-100 transition list-item";
            div.textContent = d;
            div.addEventListener("click", () => {
              campoDistrito.value = d;
              overlay.style.display = "none";
            });
            listaDistritos.appendChild(div);
          });
        }
        
        // Cargar JSON de distritos
        fetch("https://raw.githubusercontent.com/complicidad/form/main/lstDistritos.json")
          .then(res => res.json())
          .then(data => {
            distritos = data.map(item => typeof item === "string" ? item : item.Distrito || item.nombre || "");
            mostrarDistritos(distritos);
          })
          .catch(err => {
            console.error("Error cargando distritos:", err);
          });
        
        // --- L√≥gica del modal de Agencias (Vanilla JS) ---
        const campoAgencia = document.getElementById("agencia");
        const overlayAgencia = document.getElementById("modalAgencia");
        const buscadorAgencia = document.getElementById("buscadorAgencia");
        const listaAgencias = document.getElementById("listaAgencias");
        let agencias = [];
        
        // Abrir popup al hacer click en el campo
        campoAgencia.addEventListener("click", () => {
          overlayAgencia.style.display = "flex";
          buscadorAgencia.value = "";
          mostrarAgencias(agencias);
          buscadorAgencia.focus();
        });
        
        // Cerrar popup si clic fuera de la caja
        overlayAgencia.addEventListener("click", (e) => {
          if (e.target === overlayAgencia) {
            overlayAgencia.style.display = "none";
          }
        });
        
        // Buscar agencias
        buscadorAgencia.addEventListener("input", () => {
          const filtro = buscadorAgencia.value.toLowerCase();
          const filtrados = agencias.filter(a => a.toLowerCase().includes(filtro));
          mostrarAgencias(filtrados);
        });
        
        // Mostrar lista en el popup
        function mostrarAgencias(lista) {
          listaAgencias.innerHTML = "";
          lista.forEach(a => {
            const [titulo, ...resto] = a.split("\n"); // Separar en partes
            const div = document.createElement("div");
            // Clases de Tailwind para el item de la lista
            div.className = "p-2 cursor-pointer border-b border-gray-100 hover:bg-gray-100 transition list-item";
            // Armamos el HTML con la primera l√≠nea en negrita
            div.innerHTML = `<span class="font-semibold">${titulo}</span>${resto.length ? "<br><span class='text-sm text-gray-600'>" + resto.join("<br>") + "</span>" : ""}`;
            div.addEventListener("click", () => {
              campoAgencia.value = titulo; // Mantener el valor original con \n
              overlayAgencia.style.display = "none";
            });
            listaAgencias.appendChild(div);
          });
        }
        
        // Cargar JSON de agencias
        fetch("https://raw.githubusercontent.com/complicidad/form/main/lstShalom.json")
          .then(res => res.json())
          .then(data => {
            agencias = data.map(item => typeof item === "string" ? item : item.Shalom || item.nombre || "");
            mostrarAgencias(agencias);
          })
          .catch(err => {
            console.error("Error cargando agencias:", err);
          });


            // --- INICIALIZACI√ìN DE FIREBASE ---

            // 1. Pega tu objeto de configuraci√≥n de Firebase aqu√≠
            const firebaseConfig = {
            apiKey: "AIzaSyBrajHuHwjIASJA7Ar9ViprWw8ZUmXH6wc",
            authDomain: "complicidad-envios.firebaseapp.com",
            projectId: "complicidad-envios",
            storageBucket: "complicidad-envios.firebasestorage.app",
            messagingSenderId: "418888054311",
            appId: "1:418888054311:web:2a08b637b7b96b2b6b4002"
            };

            // 2. Inicializar Firebase y los servicios
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // 3. Iniciar sesi√≥n an√≥nimamente para cumplir las reglas de seguridad
            auth.signInAnonymously().catch((error) => {
            console.error("Error al iniciar sesi√≥n an√≥nimamente:", error);
            // Opcional: Mostrar un error al usuario si la autenticaci√≥n falla
            // mostrarMensajeTelefono("Error de conexi√≥n. Recarga la p√°gina.", "error");
            });

            // --- INICIALIZACI√ìN DE APP CHECK (NUEVO) ---
            try {
              const appCheck = firebase.appCheck(app);
              appCheck.activate(
                '6LcZafsrAAAAAHnnL-2pH8Ji7iBvJpbXG1jclFcb', // <-- Pega tu "Clave del sitio" del Paso 1 aqu√≠
                true // true = isTokenAutoRefreshEnabled
              );
              console.log("Firebase App Check activado.");
            } catch (err) {
              console.error("Error al activar App Check:", err);
            }
            
            // --- FIN DE APP CHECK ---
            

            // --- L√≥gica principal del formulario (jQuery) ---
            $(document).ready(function () {
            

            function obtenerFechasEnvio() {
                const ahora = new Date();
                const opciones = [];
                const diasPermitidos = [2, 5]; // martes = 2, viernes = 5
                const horaCorte = 10; // 10:00 a.m.
                const limite = new Date();
                limite.setDate(ahora.getDate() + 14);

                let fecha = new Date();
                fecha.setHours(0, 0, 0, 0);

                while (fecha <= limite) {
                    const diaSemana = fecha.getDay();

                    if (diasPermitidos.includes(diaSemana)) {
                        const fechaCorte = new Date(fecha);
                        fechaCorte.setDate(fecha.getDate() - 1);
                        fechaCorte.setHours(horaCorte, 0, 0, 0);

                        if (ahora < fechaCorte) {
                            opciones.push(new Date(fecha));
                        }
                    }
                    fecha.setDate(fecha.getDate() + 1);
                }
                return opciones;
            }

            function formatearFecha(fecha) {
                return fecha.toLocaleDateString("es-ES", {
                    weekday: "long",
                    day: "2-digit",
                    month: "long",
                    year: "numeric",
                });
            }

            // Carga las fechas en el select #fecha
            const $selectFecha = $("#fecha");

            // --- A√ëADIR ESTE BLOQUE - INICIO ---
            // 1. A√±adir la opci√≥n placeholder
            $selectFecha.append(
                $("<option>")
                    .val("") // Valor vac√≠o para la validaci√≥n 'required'
                    .text("Elige una fecha de env√≠o...")
                    .prop("disabled", true) // No se puede seleccionar
                    .prop("selected", true) // Es la opci√≥n por defecto
            );
            // --- A√ëADIR ESTE BLOQUE - FIN ---

            const fechas = obtenerFechasEnvio();
            fechas.forEach((f) => {
                const option = $("<option>")
                    .val(f.toISOString().split("T")[0])
                    .text(formatearFecha(f));
                $selectFecha.append(option);
            });

            function limpiarCampos(idContenedor) {
                const selector = `#${idContenedor} input, #${idContenedor} select`;
                document.querySelectorAll(selector).forEach((campo) => {
                    if (campo.tagName === "SELECT") {
                        $(campo).val(null).trigger("change");
                    } else {
                        campo.value = "";
                    }
                    $(campo).removeClass("is-invalid"); // Limpia el estado de error
                    
                    // UX: Asegurar que los campos de tel√©fono est√©n habilitados/no readonly al limpiar
                    if(campo.id === 'telefonoDelivery' || campo.id === 'telefonoShalom') {
                        $(campo).prop('readonly', false).removeClass('bg-gray-100');
                    }
                });
                
                // UX: Desmarcar los checkboxes al limpiar
                $usarMismoTelefonoDelivery.prop('checked', false);
                $usarMismoTelefonoShalom.prop('checked', false);
            }
            
            // FUNCI√ìN ACTUALIZADA PARA USAR EL TOAST CON ESTILO GRADIENTE
            function mostrarMensajeTelefono(mensaje, tipo = "success") {
                const $toast = $("#toast");
                
                // Limpiar clases de gradiente y visibilidad
                $toast.removeClass("bg-gradient-to-r from-brand-accent to-brand-accent-alt from-red-500 to-red-600 opacity-100 translate-y-0");
                
                // 1. Aplicar clases de color seg√∫n el tipo (Terracota para √©xito, Rojo para error)
                if (tipo === "success") {
                    $toast.addClass("bg-gradient-to-r from-brand-accent to-brand-accent-alt shadow-brand-accent/25");
                } else {
                    $toast.addClass("bg-gradient-to-r from-red-500 to-red-600 shadow-red-500/25");
                }

                // 2. Setear el texto
                $toast.text(mensaje);
                
                // 3. Mostrar el toast (aplica la transici√≥n)
                // Se hace en el siguiente tick del ciclo de eventos para asegurar la transici√≥n
                setTimeout(() => {
                    $toast.addClass("opacity-100 translate-y-0");
                }, 50);

                // 4. Set timeout para ocultar el toast despu√©s de 5 segundos
                clearTimeout($toast.data('timer'));
                const timer = setTimeout(() => {
                    $toast.removeClass("opacity-100 translate-y-0").addClass("opacity-0 translate-y-2");
                    // Limpia las clases de color despu√©s de la animaci√≥n de salida
                    setTimeout(() => {
                        $toast.removeClass("from-brand-accent to-brand-accent-alt from-red-500 to-red-600 shadow-brand-accent/25 shadow-red-500/25");
                    }, 300); // 300ms es la duraci√≥n de la transici√≥n
                }, 5000); 

                $toast.data('timer', timer);
            }

            // UX: Funciones y eventos para reutilizar el n√∫mero de tel√©fono principal
            function updateTelefonoDisplay() {
                const val = $telefonoUsado.val() || 'N/A';
                $telefonoDisplayDelivery.text(val);
                $telefonoDisplayShalom.text(val);
            }
            
            // Inicializar la visualizaci√≥n y actualizar en cada input del tel√©fono principal
            updateTelefonoDisplay();
            $telefonoUsado.on('input', function() {
                updateTelefonoDisplay();
                // Si el checkbox est√° marcado, tambi√©n actualiza el campo de destino
                if ($usarMismoTelefonoDelivery.is(':checked')) {
                    $telefonoDelivery.val($(this).val());
                }
                if ($usarMismoTelefonoShalom.is(':checked')) {
                    $telefonoShalom.val($(this).val());
                }
            });


            // Toggle logic for Delivery phone number
            $usarMismoTelefonoDelivery.on('change', function() {
                const checked = $(this).is(':checked');
                if (checked) {
                    $telefonoDelivery.val($telefonoUsado.val());
                    $telefonoDelivery.prop('readonly', true).removeClass('cursor-pointer').addClass('bg-gray-100');
                    $telefonoDelivery.removeClass('is-invalid'); // Limpia estado de error
                } else {
                    $telefonoDelivery.val('');
                    $telefonoDelivery.prop('readonly', false).removeClass('bg-gray-100').focus();
                }
            });

            // Toggle logic for Shalom phone number
            $usarMismoTelefonoShalom.on('change', function() {
                const checked = $(this).is(':checked');
                if (checked) {
                    $telefonoShalom.val($telefonoUsado.val());
                    $telefonoShalom.prop('readonly', true).removeClass('cursor-pointer').addClass('bg-gray-100');
                    $telefonoShalom.removeClass('is-invalid'); // Limpia estado de error
                } else {
                    $telefonoShalom.val('');
                    $telefonoShalom.prop('readonly', false).removeClass('bg-gray-100').focus();
                }
            });

            // Muestra/oculta bloques de campos seg√∫n la opci√≥n seleccionada
            $("#tipoAccion").on("change", function () {
                limpiarCampos("camposDelivery");
                limpiarCampos("camposShalom");
                limpiarCampos("camposUsados");

                // Oculta todos los bloques y deshabilita inputs/selects dentro
                $("#camposDelivery, #camposShalom, #camposUsados")
                    .attr("hidden", true)
                    .find("input, select")
                    .prop("disabled", true);
                
                // UX: Asegurar que los checkboxes est√©n desmarcados
                $usarMismoTelefonoDelivery.prop('checked', false);
                $usarMismoTelefonoShalom.prop('checked', false);


                const valor = $(this).val();

                // Mostrar y habilitar bloque correspondiente
                if (valor === "delivery") {
                    $("#camposDelivery").attr("hidden", false).find("input, select").prop("disabled", false);
                } else if (valor === "shalom") {
                    $("#camposShalom").attr("hidden", false).find("input, select").prop("disabled", false);
                } else if (valor === "recoger") {
                    // Recoger en almac√©n no requiere campos extra ni fecha de env√≠o
                } else if (valor === "usado") {
                    $("#camposUsados").attr("hidden", false).find("input, select").prop("disabled", false);
                }

                // Mover y mostrar campo fecha en el bloque correspondiente
                const $contenedorFecha = $("#contenedorFecha");
                $contenedorFecha.hide();

                if (["delivery", "shalom", "usado"].includes(valor)) {
                    if (valor === "delivery") {
                        $("#camposDelivery").append($contenedorFecha);
                    } else if (valor === "shalom") {
                        $("#camposShalom").append($contenedorFecha);
                    } else {
                        $("#camposUsados").append($contenedorFecha);
                    }
                    $contenedorFecha.show();
                    $("#fecha").prop("disabled", false);
                } else {
                    $("#fecha").prop("disabled", true);
                }

                // --- A√ëADIR ESTE BLOQUE - INICIO ---
                // UX: Mover el foco y el scroll al primer campo de la secci√≥n
                
                // La variable 'valor' ya existe en esta funci√≥n, as√≠ que la reusamos.
                let targetId = null; 
                
                if (valor === "delivery") {
                    targetId = "nombreDelivery"; // ID del primer input en Delivery
                } else if (valor === "shalom") {
                    targetId = "nombreShalom"; // ID del primer input en Shalom
                } else if (valor === "usado") {
                    targetId = "fecha"; // ID del primer (y √∫nico) input en Usado
                }

                if (targetId) {
                    // Se usa un peque√±o retardo (100ms) para dar tiempo al navegador
                    // a renderizar la secci√≥n antes de mover el foco.
                    setTimeout(() => {
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Opcional: Si focus() no es suficiente, puedes forzar un scroll m√°s suave
                            // targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100); 
                }
                // --- A√ëADIR ESTE BLOQUE - FIN ---
            });

            // Env√≠o del formulario con validaci√≥n y l√≥gica de Firestore
            $("#formulario").on("submit", async function (e) {
                e.preventDefault();

                // Oculta el mensaje previo inmediatamente
                $("#toast").removeClass("opacity-100 translate-y-0").addClass("opacity-0 translate-y-2");

                function mostrarMensaje(mensaje, tipo = "success") {
                    mostrarMensajeTelefono(mensaje, tipo);
                }

                const tipoAccion = $("#tipoAccion").val();

                // Funci√≥n para aplicar clase de error (se mantiene igual)
                function aplicarClaseError(id) {
                    $(`#${id}`).addClass('is-invalid');
                    $(`#${id}`).on('input change', function() {
                        $(this).removeClass('is-invalid');
                    });
                }

                // Validaciones manuales para 'readonly' (se mantienen igual)
                if (tipoAccion === "delivery") {
                    if (!$("#distrito").val()) {
                        mostrarMensaje("Por favor, selecciona un distrito de la lista", "error");
                        aplicarClaseError("distrito");
                        return;
                    }
                }
                if (tipoAccion === "shalom") {
                    if (!$("#agencia").val()) {
                        mostrarMensaje("Por favor, selecciona una agencia de la lista", "error");
                        aplicarClaseError("agencia");
                        return;
                    }
                }

                // Validaci√≥n nativa HTML5 (se mantiene igual)
                if (!this.checkValidity()) {
                    $(this).find(':invalid').each(function() {
                        aplicarClaseError(this.id);
                    });
                    this.reportValidity();
                    return;
                }

                const spinnerOverlay = document.getElementById('spinner');
                spinnerOverlay.classList.remove('hidden');
                spinnerOverlay.classList.add('flex');

                // --- INICIO DE LA NUEVA L√ìGica DE FIRESTORE ---
                try {
                    // 1. Preparar el documento base
                    const docData = {
                        fechaRegistro: new Date(), // Firestore usa objetos Date
                        cliente: $("#telefonoUsado").val(),
                        courier: tipoAccion.toUpperCase(),
                        fechaEnvio: $("#fecha").val(),
                        estado: "PENDIENTE",
                    };

                    // 2. A√±adir datos espec√≠ficos
                    if (tipoAccion === "delivery") {
                        docData.nombre = $("#nombreDelivery").val();
                        docData.telefono = $("#telefonoDelivery").val();
                        docData.distrito = $("#distrito").val();
                        docData.direccion = $("#direccion").val();
                        docData.referencia = $("#referencia").val();

                    } else if (tipoAccion === "shalom") {
                        docData.nombre = $("#nombreShalom").val();
                        docData.telefono = $("#telefonoShalom").val();
                        docData.DNI = $("#DNI").val();
                        docData.agencia = $("#agencia").val();

                    } else if (tipoAccion === "usado") {
                        const telefonoIngresado = $("#telefonoUsado").val().replace(/\D/g, "");

                        // 2a. (checkPhone) Verificar si el tel√©fono existe
                        console.log(`Verificando tel√©fono: ${telefonoIngresado}`);
                        const qCheck = db.collection("envios")
                            .where("cliente", "==", telefonoIngresado)
                            .limit(1);

                        const checkSnapshot = await qCheck.get();

                        if (checkSnapshot.empty) {
                            mostrarMensaje("El n√∫mero ingresado no est√° registrado.", "error");
                            aplicarClaseError("telefonoUsado");
                            $("#telefonoUsado").focus();
                            spinnerOverlay.classList.remove('flex');
                            spinnerOverlay.classList.add('hidden');
                            return; // Detener
                        }

                        // 2b. (getLastRecord) Si existe, buscar el √∫ltimo registro
                        console.log("Tel√©fono verificado. Buscando √∫ltimo registro...");
                        const qRecord = db.collection("envios")
                            .where("cliente", "==", telefonoIngresado)
                            .orderBy("fechaRegistro", "desc") // 'desc' para el m√°s reciente
                            .limit(1);

                        const recordSnapshot = await qRecord.get();

                        if (!recordSnapshot.empty) {
                            const ultimoRegistro = recordSnapshot.docs[0].data();
                            console.log("√öltimo registro encontrado:", ultimoRegistro);

                            // 2c. Mapear y a√±adir los datos
                            docData.courier = ultimoRegistro.courier || tipoAccion.toUpperCase(); // Copia el courier
                            docData.nombre = ultimoRegistro.nombre || "";
                            docData.telefono = ultimoRegistro.telefono || "";
                            docData.distrito = ultimoRegistro.distrito || "";
                            docData.direccion = ultimoRegistro.direccion || "";
                            docData.referencia = ultimoRegistro.referencia || "";
                            docData.DNI = ultimoRegistro.DNI || "";
                            docData.agencia = ultimoRegistro.agencia || "";
                        } else {
                            console.warn("Tel√©fono v√°lido, pero no se encontr√≥ √∫ltimo registro.");
                        }
                    }

                    // 3. Guardar el documento en Firestore
                    console.log("Guardando documento:", docData);
                    await db.collection("envios").add(docData);

                    // 4. L√≥gica de √âxito (se mantiene igual)
                    $("#formulario").hide();
                    $("#successMessage").removeClass('hidden').addClass('flex');
                    $("#formulario")[0].reset();
                    // ... (resto del c√≥digo de reseteo) ...
                    $("#camposDelivery, #camposShalom, #camposUsados")
                        .attr("hidden", true)
                        .find("input, select")
                        .prop("disabled", true);
                    $("#contenedorFecha").hide();
                    $("#fecha").empty();

                    // --- RE-A√ëADIR PLACEHOLDER A FECHA ---
                    $("#fecha").append(
                        $("<option>")
                            .val("") 
                            .text("Elige una fecha de env√≠o...")
                            .prop("disabled", true)
                            .prop("selected", true)
                    );
                    const nuevasFechas = obtenerFechasEnvio();
                    nuevasFechas.forEach(f => {
                        $("#fecha").append(
                            $("<option>").val(f.toISOString().split("T")[0]).text(formatearFecha(f))
                        );
                    });
                    $usarMismoTelefonoDelivery.prop('checked', false);
                    $usarMismoTelefonoShalom.prop('checked', false);
                    $telefonoDelivery.prop('readonly', false).removeClass('bg-gray-100');
                    $telefonoShalom.prop('readonly', false).removeClass('bg-gray-100');

                } catch (err) {
                    // 5. Manejo de Errores
                    console.error("Error al guardar en Firestore:", err);
                    mostrarMensaje("Ocurri√≥ un error al guardar tus datos", "error");
                } finally {
                    // 6. Ocultar el spinner
                    spinnerOverlay.classList.remove('flex');
                    spinnerOverlay.classList.add('hidden');
                }
                // --- FIN DE LA NUEVA L√ìGica DE FIRESTORE ---
            });
        });
    </script>
</body>
</html>



