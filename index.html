<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Negocio</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Fuentes (Inter) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ocultar páginas por defecto */
        .page {
            display: none;
        }
        /* Mostrar la página activa */
        .page.active {
            display: block;
        }

        /* Estilos para los botones de navegación de la barra lateral (desktop) */
        .sidebar-nav .nav-button {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem; /* 12px 16px */
            border-radius: 0.5rem; /* 8px */
            color: #D1D5DB; /* text-gray-300 */
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap; /* Evita que el texto se parta al colapsar */
        }
        .sidebar-nav .nav-button:hover {
            background-color: #374151; /* bg-gray-700 */
            color: white;
        }
        .sidebar-nav .nav-button.active {
            background-color: #F97316; /* bg-orange-500 */
            color: white;
            font-weight: 600;
        }

        /* Estilos para los botones de navegación inferiores (móvil) */
        .mobile-nav .nav-button {
            color: #D1D5DB; /* text-gray-300 */
        }
        .mobile-nav .nav-button.active {
            color: #F97316; /* text-orange-500 */
        }

        /* Asegurar que el contenido principal tenga padding inferior en móvil */
        @media (max-width: 639px) {
            body {
                padding-bottom: 72px; /* Altura de la barra de navegación móvil */
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="flex h-screen">
        <!-- Barra Lateral (Sidebar) - Oculta en móvil -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-6 hidden sm:flex flex-col flex-shrink-0 transition-all duration-300 ease-in-out">
            <!-- Título del Gestor (Se oculta al colapsar) -->
            <span class="text-2xl font-bold text-white mb-8 sidebar-content">Mi Gestor</span>
            
            <!-- Navegación de la Sidebar -->
            <nav class="flex flex-col space-y-2 sidebar-nav sidebar-content">
                <!-- NUEVO: Resumen -->
                <button data-page="page-resumen" data-title="Resumen" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    Resumen
                </button>
                <!-- RENOMBRADO: Productos (antes Inventario) -->
                <button data-page="page-productos" data-title="Productos" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M5 8a1 1 0 011-1h1V6a1 1 0 011-1h4a1 1 0 011 1v1h1a1 1 0 011 1v2h1.172a1 1 0 01.707 1.707l-4.172 4.172a1 1 0 01-1.414 0L4.293 11.707A1 1 0 015 10.172V8z" /><path d="M15 11.172V16a1 1 0 01-1 1H6a1 1 0 01-1-1v-4.828l-1.707 1.707A1 1 0 012 11.707V10a1 1 0 011-1h2V8a1 1 0 011-1h6a1 1 0 011 1v1h2a1 1 0 011 1v1.707a1 1 0 01-.293.707L15 11.172zM7 6v1h6V6H7z" /></svg>
                    Productos
                </button>
                <!-- RENOMBRADO: Registrar Venta (antes Ventas) -->
                <button data-page="page-registrar-venta" data-title="Registrar Venta" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm-2 5V6a2 2 0 114 0v1H8zm2 3a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Registrar Venta
                </button>
                <!-- RENOMBRADO: Registrar Compra (antes Compras) -->
                <button data-page="page-registrar-compra" data-title="Registrar Compra" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg>
                    Registrar Compra
                </button>
                 <!-- NUEVO: Historial de Ventas -->
                <button data-page="page-historial-ventas" data-title="Historial de Ventas" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 6a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2v-4a2 2 0 00-2-2H4z" clip-rule="evenodd" /></svg>
                    Historial Ventas
                </button>
                <!-- NUEVO: Historial de Compras -->
                <button data-page="page-historial-compras" data-title="Historial de Compras" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13z" clip-rule="evenodd" /></svg>
                    Historial Compras
                </button>
            </nav>

            <!-- ID de Usuario al final (Se oculta al colapsar) -->
            <div class="mt-auto text-xs text-gray-400 sidebar-content" id="user-id-display">Cargando...</div>
        </aside>

        <!-- Contenido Principal (Wrapper) -->
        <div class="flex-1 flex flex-col overflow-y-auto">
            
            <!-- Barra Superior (Header) - Naranja como en la imagen -->
            <header class="bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center">
                    <!-- Botón para colapsar/expandir sidebar (visible en desktop) -->
                    <button id="sidebar-toggle" class="text-white p-2 rounded-md hover:bg-orange-600 hidden sm:block mr-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                    <h1 id="page-title" class="text-xl font-bold">Resumen</h1>
                </div>
                <div class="flex items-center">
                    <span class="hidden sm:inline text-sm">Bienvenido</span>
                    <!-- Icono de usuario simple -->
                    <div class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-white text-orange-600 font-bold ml-2 shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                          </svg>
                    </div>
                </div>
            </header>

            <!-- Contenido de la Página -->
            <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 w-full">

                <!-- NUEVO: Página de Resumen (Dashboard) -->
                <section id="page-resumen" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Resumen</h1>
                    
                    <!-- NUEVO: Botón de Datos de Prueba -->
                    <div class="mb-6">
                        <button id="mock-data-btn" class="bg-yellow-400 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-yellow-500 transition duration-150 ease-in-out">
                            Añadir Datos de Prueba
                        </button>
                    </div>

                    <!-- Tarjetas de Estadísticas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <!-- Ingresos Totales -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-sm font-medium text-gray-500">Ingresos Totales (Ventas)</h2>
                            <p id="ingresos-stat" class="text-3xl font-bold text-green-600 mt-2">S/ 0.00</p>
                        </div>
                        <!-- Costos Totales -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-sm font-medium text-gray-500">Costos Totales (Compras)</h2>
                            <p id="costos-stat" class="text-3xl font-bold text-red-600 mt-2">S/ 0.00</p>
                        </div>
                        <!-- Ganancia Bruta -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-sm font-medium text-gray-500">Ganancia Bruta</h2>
                            <p id="ganancias-stat" class="text-3xl font-bold text-blue-600 mt-2">S/ 0.00</p>
                        </div>
                    </div>
                    
                    <!-- Alerta de Stock Bajo -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Alerta de Stock Bajo (5 o menos)</h2>
                        <div id="low-stock-list" class="space-y-3">
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                </section>

                <!-- Página: Productos (antes Inventario) -->
                <section id="page-productos" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Productos</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Actual</th>
                                    </tr>
                                </thead>
                                <tbody id="inventario-list-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Filas de productos se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        <div id="inventario-list-empty" class="hidden text-center py-8 text-gray-500">
                            No hay productos en tu inventario. Agrega una compra para comenzar.
                        </div>
                    </div>
                </section>

                <!-- Página: Registrar Venta -->
                <section id="page-registrar-venta" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Registrar Venta</h1>
                    <form id="form-ventas" class="bg-white p-6 rounded-lg shadow-md space-y-4 max-w-xl mx-auto">
                        <div>
                            <label for="venta-producto" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="venta-producto" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="venta-cantidad" class="block text-sm font-medium text-gray-700">Cantidad Vendida</label>
                            <input type="number" id="venta-cantidad" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="venta-precio" class="block text-sm font-medium text-gray-700">Precio de Venta (Total)</label>
                            <input type="number" id="venta-precio" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <!-- NUEVO: Campo para WhatsApp del Cliente -->
                        <div>
                            <label for="venta-cliente-ws" class="block text-sm font-medium text-gray-700">WhatsApp del Cliente (Opcional)</label>
                            <input type="tel" id="venta-cliente-ws" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ej: 987654321">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Registrar Venta
                        </button>
                    </form>
                </section>

                <!-- Página: Registrar Compra -->
                <section id="page-registrar-compra" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Registrar Compra</h1>
                    <form id="form-compras" class="bg-white p-6 rounded-lg shadow-md space-y-4 max-w-xl mx-auto">
                        <div>
                            <label for="compra-producto" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="compra-producto" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="compra-cantidad" class="block text-sm font-medium text-gray-700">Cantidad Comprada</label>
                            <input type="number" id="compra-cantidad" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="compra-costo" class="block text-sm font-medium text-gray-700">Costo de Compra (Total)</Dlabel>
                            <input type="number" id="compra-costo" min="0" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                            Añadir al Inventario
                        </button>
                    </form>
                </section>
                
                <!-- NUEVO: Página Historial Ventas -->
                <section id="page-historial-ventas" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Historial de Ventas</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <!-- NUEVO: Columna Cliente -->
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente (WhatsApp)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Total</th>
                                    </tr>
                                </thead>
                                <tbody id="historial-ventas-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Filas de ventas se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        <div id="historial-ventas-empty" class="hidden text-center py-8 text-gray-500">
                            No has registrado ninguna venta.
                        </div>
                    </div>
                </section>

                <!-- NUEVO: Página Historial Compras -->
                <section id="page-historial-compras" class="page">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6 sm:hidden">Historial de Compras</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Total</th>
                                    </tr>
                                </thead>
                                <tbody id="historial-compras-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Filas de compras se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        <div id="historial-compras-empty" class="hidden text-center py-8 text-gray-500">
                            No has registrado ninguna compra.
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Navegación Móvil (Barra Inferior) - Visible solo en móvil -->
    <nav class="sm:hidden fixed bottom-0 left-0 right-0 bg-gray-800 text-white grid grid-cols-5 p-2 border-t border-gray-700 shadow-lg mobile-nav">
        <button data-page="page-resumen" data-title="Resumen" class="nav-button flex flex-col items-center p-2 rounded-md text-xs font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
            Resumen
        </button>
        <button data-page="page-productos" data-title="Productos" class="nav-button flex flex-col items-center p-2 rounded-md text-xs font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" viewBox="0 0 20 20" fill="currentColor"><path d="M5 8a1 1 0 011-1h1V6a1 1 0 011-1h4a1 1 0 011 1v1h1a1 1 0 011 1v2h1.172a1 1 0 01.707 1.707l-4.172 4.172a1 1 0 01-1.414 0L4.293 11.707A1 1 0 015 10.172V8z" /><path d="M15 11.172V16a1 1 0 01-1 1H6a1 1 0 01-1-1v-4.828l-1.707 1.707A1 1 0 012 11.707V10a1 1 0 011-1h2V8a1 1 0 011-1h6a1 1 0 011 1v1h2a1 1 0 011 1v1.707a1 1 0 01-.293.707L15 11.172zM7 6v1h6V6H7z" /></svg>
            Productos
        </button>
        <button data-page="page-registrar-venta" data-title="Registrar Venta" class="nav-button flex flex-col items-center p-2 rounded-md text-xs font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm-2 5V6a2 2 0 114 0v1H8zm2 3a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z" clip-rule="evenodd" /></svg>
            Venta
        </button>
        <button data-page="page-registrar-compra" data-title="Registrar Compra" class="nav-button flex flex-col items-center p-2 rounded-md text-xs font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg>
            Compra
        </button>
        <!-- Historial (combinado en móvil) -->
        <button data-page="page-historial-ventas" data-title="Historial de Ventas" class="nav-button flex flex-col items-center p-2 rounded-md text-xs font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 6a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2v-4a2 2 0 00-2-2H4z" clip-rule="evenodd" /></svg>
            Historial
        </button>
    </nav>


    <!-- Modal de Mensajes (Sin cambios) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 50;">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm mx-auto">
            <h3 id="message-title" class="text-lg font-medium leading-6 text-gray-900">Mensaje</h3>
            <div class="mt-2">
                <p id="message-body" class="text-sm text-gray-500">...</p>
            </div>
            <div class="mt-4">
                <button id="message-close-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:text-sm">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <!-- Scripts de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            getDoc,
            getDocs,
            updateDoc, 
            onSnapshot, 
            collection, 
            query, 
            where,
            increment,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        const appId = 'mi-gestor-personal';
        const firebaseConfig = {
        apiKey: "AIzaSyBe_H0VfS-8K-n3Ihu-Io2q4SYDZAwbKoQ",
        authDomain: "compliventas-fc79c.firebaseapp.com",
        projectId: "compliventas-fc79c",
        storageBucket: "compliventas-fc79c.firebasestorage.app",
        messagingSenderId: "734491005717",
        appId: "1:734491005717:web:85f0be05bc345cfd6bcf1c"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let inventarioCollection, ventasCollection, comprasCollection;
        
        // NUEVO: Variables para estadísticas
        let totalIngresos = 0;
        let totalCostos = 0;
        
        // NUEVO: Helper para formatear moneda
        const formatCurrency = (val) => `S/ ${(val || 0).toFixed(2)}`;
        // NUEVO: Helper para formatear fecha
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return timestamp.toDate().toLocaleString('es-ES', {
                year: '2-digit',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        setLogLevel('Debug');

        // --- Inicialización ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            console.log("Firebase inicializado correctamente.");

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Usuario autenticado:", user.uid);
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `ID: ${userId.substring(0, 8)}...`;
                    
                    const userPath = `artifacts/${appId}/users/${userId}`;
                    inventarioCollection = collection(db, userPath, 'inventario');
                    ventasCollection = collection(db, userPath, 'ventas');
                    comprasCollection = collection(db, userPath, 'compras');
                    
                    initializeAppLogic();

                } else {
                    console.log("Usuario no autenticado, intentando login...");
                    document.getElementById('user-id-display').textContent = "Autenticando...";
                    try {

                            await signInAnonymously(auth);

                    } catch (error) {
                        console.error("Error en la autenticación:", error);
                        showMessage("Error de Autenticación", "No se pudo conectar. Recarga la página.");
                    }
                }
            });

        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            showMessage("Error Crítico", "No se pudo inicializar la aplicación. Revisa la configuración.");
        }

        // --- Lógica de la Aplicación ---
        function initializeAppLogic() {
            setupNavigation();
            setupSidebarToggle();
            setupForms();
            setupModal();
            setupMockDataButton(); // <-- NUEVO: Activar el botón de prueba
            
            // NUEVO: Iniciar los listeners para todas las colecciones
            listenToInventario();
            listenToVentas();
            listenToCompras();
        }

        // --- Lógica de Navegación (Actualizada) ---
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-button');
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    showPage(pageId); 
                });
            });

            // Establecer estado inicial (NUEVO: Resumen)
            showPage('page-resumen');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.add('active');

            const pageTitleElement = document.getElementById('page-title');
            const navButtons = document.querySelectorAll('.nav-button');
            let newTitle = 'Resumen'; // Título por defecto

            navButtons.forEach(btn => btn.classList.remove('active'));
            
            const activeButtons = document.querySelectorAll(`.nav-button[data-page="${pageId}"]`);
            activeButtons.forEach(b => b.classList.add('active'));

            if (activeButtons.length > 0) {
                newTitle = activeButtons[0].dataset.title;
            }
            if (pageTitleElement) pageTitleElement.textContent = newTitle;
        }

        // --- Lógica para colapsar Sidebar (Modificada) ---
        function setupSidebarToggle() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarContent = document.querySelectorAll('.sidebar-content'); // Contenido que se oculta
            let isSidebarOpen = true;

            if (!sidebar || !sidebarToggle) return;

            sidebarToggle.addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                if (isSidebarOpen) {
                    sidebar.classList.remove('w-0', 'p-0', 'overflow-hidden');
                    sidebar.classList.add('w-64', 'p-6');
                    sidebarContent.forEach(el => el.classList.remove('hidden'));
                } else {
                    sidebar.classList.add('w-0', 'p-0', 'overflow-hidden');
                    sidebar.classList.remove('w-64', 'p-6');
                    sidebarContent.forEach(el => el.classList.add('hidden'));
                }
            });
        }

        // --- Lógica del Modal de Mensajes (Sin cambios) ---
        function setupModal() {
            const modal = document.getElementById('message-modal');
            const closeBtn = document.getElementById('message-close-btn');
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
        }

        function showMessage(title, body) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-modal').style.display = 'flex';
        }

        // --- Lógica de Firestore (ACTUALIZADA) ---

        // 1. Escuchar y mostrar inventario (MODIFICADO)
        function listenToInventario() {
            if (!inventarioCollection) return;

            onSnapshot(inventarioCollection, (snapshot) => {
                const tableBody = document.getElementById('inventario-list-table');
                const emptyMsg = document.getElementById('inventario-list-empty');
                const lowStockList = document.getElementById('low-stock-list');
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '';
                    emptyMsg.style.display = 'block';
                    lowStockList.innerHTML = '<p class="text-gray-500">No hay productos.</p>';
                    return;
                }

                tableBody.innerHTML = ''; 
                lowStockList.innerHTML = '';
                emptyMsg.style.display = 'none';

                const docs = snapshot.docs;
                docs.sort((a, b) => a.data().nombre.localeCompare(b.data().nombre));
                
                let lowStockCount = 0;

                docs.forEach(doc => {
                    const item = doc.data();
                    const stockClass = item.stock <= 5 ? 'text-red-600 font-bold' : 'text-gray-900';

                    // 1.1: Llenar la tabla de Productos
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${item.nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${stockClass}">${item.stock} unidades</td>
                    `;
                    tableBody.appendChild(row);

                    // 1.2: Llenar la lista de Stock Bajo en el Resumen
                    if (item.stock <= 5) {
                        lowStockCount++;
                        const lowItem = document.createElement('div');
                        lowItem.className = 'flex justify-between items-center p-2 rounded';
                        lowItem.innerHTML = `
                            <span class="font-medium text-gray-700">${item.nombre}</span>
                            <span class="font-bold text-red-600">${item.stock} unidades</span>
                        `;
                        lowStockList.appendChild(lowItem);
                    }
                });

                if (lowStockCount === 0) {
                     lowStockList.innerHTML = '<p class="text-gray-500">¡Todo bien! No hay productos con stock bajo.</p>';
                }

            }, (error) => {
                console.error("Error al escuchar inventario: ", error);
                showMessage("Error de Conexión", "No se pudo cargar el inventario.");
            });
        }
        
        // 2. NUEVO: Escuchar historial de ventas y calcular ingresos
        function listenToVentas() {
            if (!ventasCollection) return;

            onSnapshot(ventasCollection, (snapshot) => {
                const tableBody = document.getElementById('historial-ventas-table');
                const emptyMsg = document.getElementById('historial-ventas-empty');
                
                totalIngresos = 0;
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '';
                    emptyMsg.style.display = 'block';
                    updateDashboardStats();
                    return;
                }

                tableBody.innerHTML = '';
                emptyMsg.style.display = 'none';

                const docs = snapshot.docs;
                docs.sort((a, b) => (b.data().fecha || 0) - (a.data().fecha || 0)); // Más nuevas primero

                docs.forEach(doc => {
                    const venta = doc.data();
                    totalIngresos += venta.precio || 0;
                    // NUEVO: Obtener el WhatsApp o mostrar N/A
                    const clienteDisplay = venta.clienteWhatsApp || 'N/A'; 
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(venta.fecha)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${venta.producto}</td>
                        <!-- NUEVO: Celda Cliente -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${clienteDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${venta.cantidad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrency(venta.precio)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                updateDashboardStats();
            });
        }
        
        // 3. NUEVO: Escuchar historial de compras y calcular costos
        function listenToCompras() {
            if (!comprasCollection) return;

            onSnapshot(comprasCollection, (snapshot) => {
                const tableBody = document.getElementById('historial-compras-table');
                const emptyMsg = document.getElementById('historial-compras-empty');
                
                totalCostos = 0;
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '';
                    emptyMsg.style.display = 'block';
                    updateDashboardStats();
                    return;
                }

                tableBody.innerHTML = '';
                emptyMsg.style.display = 'none';

                const docs = snapshot.docs;
                docs.sort((a, b) => (b.data().fecha || 0) - (a.data().fecha || 0)); // Más nuevas primero

                docs.forEach(doc => {
                    const compra = doc.data();
                    totalCostos += compra.costo || 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(compra.fecha)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${compra.producto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${compra.cantidad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600">${formatCurrency(compra.costo)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                updateDashboardStats();
            });
        }
        
        // 4. NUEVO: Actualizar tarjetas del dashboard
        function updateDashboardStats() {
            const ingresosStat = document.getElementById('ingresos-stat');
            const costosStat = document.getElementById('costos-stat');
            const gananciasStat = document.getElementById('ganancias-stat');
            
            const ganancia = totalIngresos - totalCostos;
            
            if(ingresosStat) ingresosStat.textContent = formatCurrency(totalIngresos);
            if(costosStat) costosStat.textContent = formatCurrency(totalCostos);
            if(gananciasStat) {
                gananciasStat.textContent = formatCurrency(ganancia);
                gananciasStat.classList.toggle('text-green-600', ganancia >= 0);
                gananciasStat.classList.toggle('text-red-600', ganancia < 0);
            }
        }

        // 5. Configurar formularios
        function setupForms() {
            const formCompras = document.getElementById('form-compras');
            const formVentas = document.getElementById('form-ventas');

            formCompras.addEventListener('submit', handleCompra);
            formVentas.addEventListener('submit', handleVenta);
        }

        // 6. Manejar Compra (Añadir a Stock)
        async function handleCompra(e) {
            e.preventDefault();
            const form = e.target;
            const nombre = form['compra-producto'].value.trim();
            const cantidad = parseInt(form['compra-cantidad'].value);
            const costo = parseFloat(form['compra-costo'].value);

            if (!nombre || cantidad <= 0 || costo < 0) {
                showMessage("Datos incompletos", "Por favor, ingresa nombre, cantidad y costo válidos.");
                return;
            }

            try {
                const productRef = await findProductByName(nombre);
                let stockFinal;

                if (productRef) {
                    await updateDoc(productRef, { stock: increment(cantidad) });
                    const updatedDoc = await getDoc(productRef);
                    stockFinal = updatedDoc.data().stock;
                } else {
                    await addDoc(inventarioCollection, { nombre: nombre, stock: cantidad });
                    stockFinal = cantidad;
                }

                await addDoc(comprasCollection, {
                    producto: nombre,
                    cantidad: cantidad,
                    costo: costo,
                    fecha: serverTimestamp()
                });

                showMessage("Éxito", `¡Compra registrada! Nuevo stock de "${nombre}": ${stockFinal} unidades.`);
                form.reset();
                showPage('page-resumen'); // <-- Redirige al Resumen

            } catch (error) {
                console.error("Error al registrar compra: ", error);
                showMessage("Error", "No se pudo registrar la compra.");
            }
        }

        // 7. Manejar Venta (Descontar de Stock)
        async function handleVenta(e) {
            e.preventDefault();
            const form = e.target;
            const nombre = form['venta-producto'].value.trim();
            const cantidad = parseInt(form['venta-cantidad'].value);
            const precio = parseFloat(form['venta-precio'].value);
            // NUEVO: Capturar el WhatsApp
            const clienteWs = form['venta-cliente-ws'].value.trim();

            if (!nombre || cantidad <= 0 || precio < 0) {
                showMessage("Datos incompletos", "Por favor, ingresa nombre, cantidad y precio válidos.");
                return;
            }

            try {
                const productRef = await findProductByName(nombre);
                if (!productRef) {
                    showMessage("Error", `El producto "${nombre}" no existe en el inventario.`);
                    return;
                }

                const productSnap = await getDoc(productRef);
                const currentStock = productSnap.data().stock;

                if (currentStock < cantidad) {
                    showMessage("Stock Insuficiente", `No puedes vender ${cantidad} unidades de "${nombre}". Solo quedan ${currentStock}.`);
                    return;
                }

                await updateDoc(productRef, { stock: increment(-cantidad) });

                await addDoc(ventasCollection, {
                    producto: nombre,
                    cantidad: cantidad,
                    precio: precio,
                    clienteWhatsApp: clienteWs, // NUEVO: Guardar en DB
                    fecha: serverTimestamp()
                });

                showMessage("Éxito", `¡Venta registrada! Stock restante de "${nombre}": ${currentStock - cantidad} unidades.`);
                form.reset();
                showPage('page-resumen'); // <-- Redirige al Resumen

            } catch (error) {
                console.error("Error al registrar venta: ", error);
                showMessage("Error", "No se pudo registrar la venta.");
            }
        }

        // 8. Función de ayuda: Buscar un producto por su nombre
        async function findProductByName(nombre) {
            const q = query(inventarioCollection, where("nombre", "==", nombre));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                return null; // No encontrado
            } else {
                return querySnapshot.docs[0].ref; // Devuelve la referencia al documento
            }
        }

        // --- NUEVO: Lógica para Datos de Prueba ---

        function setupMockDataButton() {
            const mockDataBtn = document.getElementById('mock-data-btn');
            if (mockDataBtn) {
                mockDataBtn.addEventListener('click', addMockData);
            }
        }

        async function addMockData() {
            const btn = document.getElementById('mock-data-btn');
            btn.textContent = 'Cargando datos...';
            btn.disabled = true;

            try {
                // 0. Comprobar si ya hay datos
                const inventarioSnap = await getDocs(inventarioCollection);
                if (!inventarioSnap.empty) {
                    showMessage("Datos de Prueba", "La base de datos ya tiene productos. No se añadieron datos de prueba.");
                    btn.textContent = 'Datos ya existen';
                    return;
                }

                console.log("Añadiendo datos de prueba...");

                // 1. Añadir Productos (a través de Compras)
                // Producto 1: Polos
                await addDoc(inventarioCollection, { nombre: "Polo Negro", stock: 20 });
                await addDoc(comprasCollection, {
                    producto: "Polo Negro",
                    cantidad: 20,
                    costo: 300, // 20 * 15
                    fecha: serverTimestamp()
                });

                // Producto 2: Gorras
                await addDoc(inventarioCollection, { nombre: "Gorra Roja", stock: 15 });
                await addDoc(comprasCollection, {
                    producto: "Gorra Roja",
                    cantidad: 15,
                    costo: 150, // 15 * 10
                    fecha: serverTimestamp()
                });

                // Producto 3: Tote Bag
                await addDoc(inventarioCollection, { nombre: "Tote Bag", stock: 30 });
                await addDoc(comprasCollection, {
                    producto: "Tote Bag",
                    cantidad: 30,
                    costo: 240, // 30 * 8
                    fecha: serverTimestamp()
                });
                
                // Producto 4: Polo Blanco (Stock bajo)
                await addDoc(inventarioCollection, { nombre: "Polo Blanco", stock: 5 });
                await addDoc(comprasCollection, {
                    producto: "Polo Blanco",
                    cantidad: 5,
                    costo: 75, // 5 * 15
                    fecha: serverTimestamp()
                });

                // 2. Añadir Ventas (y descontar stock)
                // Venta 1: 2 Polos Negros
                const poloRef = await findProductByName("Polo Negro");
                if(poloRef) await updateDoc(poloRef, { stock: increment(-2) });
                await addDoc(ventasCollection, {
                    producto: "Polo Negro",
                    cantidad: 2,
                    precio: 60, // 2 * 30
                    clienteWhatsApp: "987654321",
                    fecha: serverTimestamp()
                });

                // Venta 2: 1 Gorra Roja
                const gorraRef = await findProductByName("Gorra Roja");
                if(gorraRef) await updateDoc(gorraRef, { stock: increment(-1) });
                await addDoc(ventasCollection, {
                    producto: "Gorra Roja",
                    cantidad: 1,
                    precio: 20,
                    clienteWhatsApp: "912345678",
                    fecha: serverTimestamp()
                });
                
                // Venta 3: 5 Tote Bags
                const toteRef = await findProductByName("Tote Bag");
                if(toteRef) await updateDoc(toteRef, { stock: increment(-5) });
                await addDoc(ventasCollection, {
                    producto: "Tote Bag",
                    cantidad: 5,
                    precio: 75, // 5 * 15
                    clienteWhatsApp: "987654321", // Cliente recurrente
                    fecha: serverTimestamp()
                });

                showMessage("Éxito", "¡Datos de prueba cargados! El dashboard se actualizará en segundos.");
                btn.textContent = '¡Datos Cargados!';

            } catch (error) {
                console.error("Error al añadir datos de prueba:", error);
                showMessage("Error", "No se pudieron cargar los datos de prueba.");
                btn.textContent = 'Error al cargar';
            }
        }

    </script>

</body>
</html>



