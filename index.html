<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latam5S — Organiza tus envíos con calma</title>
    <meta name="description" content="Organiza tus envíos sin direcciones confusas ni mensajes perdidos. Latam5S es la herramienta para emprendedores que buscan calma y eficiencia.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for Dark Mode Toggle (though not strictly used in this panel, good practice) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Estilos base y para la fuente personalizada */
        body {
            font-family: "Quicksand", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        }
        [hidden] { display: none; }
        select:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        
        /* Estilo para cliente seleccionado, usando los nuevos colores de marca */
        .client-item.selected {
            background-color: #f7e0d6; /* Ligero brand-accent */
            border-left-width: 4px;
            border-color: #D96B4F; /* brand-accent */
        }
        .dark .client-item.selected {
            background-color: #374151; /* gray-700 en dark mode */
            border-color: #FF8B6A; /* brand-accent-alt en dark mode */
        }

        /* Ocultar flechas en inputs de tipo número */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
    </style>

    <script>
        // Configuración personalizada para Tailwind CSS
        tailwind.config = {
            darkMode: 'class', // Habilitar modo oscuro basado en clase
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#fffaf6',
                        'brand-card': '#ffffff',
                        'brand-text': '#2b2b2b',
                        'brand-muted': '#6b6b6b',
                        'brand-accent': '#D96B4F', // Color principal para botones y acentos
                        'brand-accent-alt': '#FF8B6A', // Color de hover y acentos secundarios
                    },
                    fontFamily: {
                        'quicksand': ['Quicksand', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-bg font-quicksand antialiased text-brand-text dark:bg-gray-900 dark:text-brand-bg">

    <!-- Contenedor principal -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <!-- Encabezado -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-brand-text dark:text-brand-bg">Panel de Gestión Latam5S</h1>
            <p class="text-sm text-brand-muted dark:text-gray-400">Tu ID de usuario: <span id="userIdDisplay" class="font-medium text-brand-text dark:text-brand-bg">Cargando...</span></p>
            
            <!-- Botón de Modo Oscuro -->
            <button id="darkModeToggle" class="mt-2 text-sm text-brand-muted dark:text-gray-400 hover:text-brand-accent dark:hover:text-brand-accent-alt transition duration-150">
                <i data-feather="moon" class="w-5 h-5 inline-block align-middle dark:hidden"></i>
                <i data-feather="sun" class="w-5 h-5 inline-block align-middle hidden dark:inline-block"></i>
                Cambiar Tema
            </button>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs" id="tabs">
                    <!-- Clientes y Envíos -->
                    <button data-tab="clients" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm text-brand-accent border-brand-accent dark:text-brand-accent-alt dark:border-brand-accent-alt">
                        Clientes y Envíos
                    </button>
                    <!-- Ventas -->
                    <button data-tab="sales" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-brand-muted border-transparent hover:text-brand-accent dark:hover:text-brand-accent-alt hover:border-brand-accent">
                        Ventas
                    </button>
                    <!-- Productos -->
                    <button data-tab="products" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-brand-muted border-transparent hover:text-brand-accent dark:hover:text-brand-accent-alt hover:border-brand-accent">
                        Productos
                    </button>
                </nav>
            </div>
        </div>

        <!-- Paneles de Contenido -->

        <!-- Panel de Clientes y Envíos -->
        <div id="clients-panel" class="tab-panel">
            <div class="flex justify-end mb-4">
                <!-- BOTÓN ELIMINADO - Ya no se agrega cliente desde aquí -->
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna 1: Lista de Clientes Seleccionable -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Lista de Clientes</h2>
                    <div id="clients-list-selectable" class="space-y-2">
                        <!-- Clientes se cargarán aquí -->
                        <p class="text-brand-muted dark:text-gray-400 text-sm">Cargando clientes...</p>
                    </div>
                </div>
                
                <!-- Columna 2: Detalle de Cliente y Envíos -->
                <div id="client-detail-panel" class="lg:col-span-2 space-y-6" hidden>
                    <!-- Detalles del Cliente -->
                    <div class="bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 id="client-detail-name" class="text-2xl font-semibold text-brand-text dark:text-brand-bg">Seleccione un cliente</h2>
                        <p id="client-detail-phone" class="text-sm text-brand-muted dark:text-gray-400"></p>
                        <button id="client-detail-summary-btn" data-id="" data-name="" data-phone="" class="mt-2 text-sm text-green-600 dark:text-green-400 hover:text-green-800 font-medium" hidden>
                            Generar Resumen WhatsApp (Todas las ventas)
                        </button>
                    </div>

                    <!-- Ventas Pendientes de Envío -->
                    <div class="bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Ventas Pendientes de Envío</h3>
                        <div id="pending-sales-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Ventas pendientes se cargarán aquí -->
                        </div>
                        <div class="mt-6 border-t pt-4 space-y-3 dark:border-gray-700">
                            <h4 class="text-md font-medium text-brand-text dark:text-brand-bg">Agrupar en nuevo envío</h4>
                            <div>
                                <label for="shipment-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Envío</label>
                                <input type="date" id="shipment-date" required class="mt-1 block w-full sm:w-1/2 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                            </div>
                            <button id="create-shipment-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:ring-green-500">
                                Crear Envío con Ventas Seleccionadas
                            </button>
                        </div>
                    </div>

                    <!-- Historial de Envíos -->
                    <div class="bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Historial de Envíos</h3>
                        <div id="shipment-history-list" class="space-y-3">
                            <!-- Historial se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Ventas -->
        <div id="sales-panel" class="tab-panel" hidden>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna 1: Formulario de Venta -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Registrar Nueva Venta</h2>
                    <form id="add-sale-form" class="space-y-4">
                        <div>
                            <label for="sale-client" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Cliente</label>
                            <select id="sale-client" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                <option value="">Seleccione un cliente...</option>
                                <!-- Se llenará con JS -->
                            </select>
                        </div>
                        
                        <!-- NUEVO: Campos para nuevo cliente (ocultos por defecto) -->
                        <div id="new-client-fields" class="space-y-2 border-t border-gray-200 dark:border-gray-700 pt-3 mt-3" hidden>
                            <label class="block text-sm font-semibold text-brand-text dark:text-brand-bg">Datos del Nuevo Cliente</label>
                            <input type="text" id="new-client-name" placeholder="Nombre del Nuevo Cliente" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm focus:border-brand-accent focus:ring-brand-accent">
                            <input type="tel" id="new-client-phone" placeholder="Teléfono (WhatsApp)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm focus:border-brand-accent focus:ring-brand-accent">
                        </div>
                        
                        <!-- Sección de items modificada -->
                        <div class="border border-gray-200 dark:border-gray-600 rounded-md p-4 space-y-3">
                            <h3 class="text-md font-semibold text-brand-text dark:text-brand-bg">Items de la Venta</h3>
                            <div class="space-y-2">
                                <select id="sale-product-select" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <option value="">Seleccione un producto...</option>
                                </select>

                                <!-- ELIMINADO: Campos para nuevo producto -->
                                <!-- 
                                <div id="new-product-fields" ...>
                                    ...
                                </div>
                                -->

                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="sale-item-qty" placeholder="Cantidad" min="1" value="1" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <input type="number" id="sale-item-price" placeholder="Precio de Venta (c/u)" min="0" step="0.01" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="sale-item-color" placeholder="Color (Opcional)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <input type="text" id="sale-item-talla" placeholder="Talla (Opcional)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                </div>
                                <button type="button" id="add-sale-item-btn" class="w-full text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt py-2 focus:ring-brand-accent">
                                    Agregar Item a la Venta
                                </button>
                            </div>
                            <ul id="current-sale-items" class="text-sm space-y-1 text-brand-text dark:text-brand-bg">
                                <!-- Items agregados temporalmente -->
                            </ul>
                            <div class="text-right font-bold text-lg text-brand-accent dark:text-brand-accent-alt">
                                Total Venta: S/ <span id="current-sale-total">0.00</span>
                            </div>
                        </div>
                        <!-- Fin del cambio -->

                        <div>
                            <label for="sale-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Venta</label>
                            <input type="date" id="sale-date" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>

                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                            Guardar Venta y Actualizar Stock
                        </button>
                    </form>
                </div>
                
                <!-- Columna 2: Historial de Ventas (MODIFICADO) -->
                <div class="lg:col-span-2 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Historial de Items Vendidos</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- CABECERA DE TABLA MODIFICADA -->
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cant.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Total Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Items vendidos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Productos -->
        <div id="products-panel" class="tab-panel" hidden>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna 1: Formulario de Productos -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Agregar/Actualizar Inventario</h2>
                    <form id="add-product-form" class="space-y-4">
                        
                        <!-- CAMBIO: De Input a Select -->
                        <div>
                            <label for="product-select-inventory" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Producto</label>
                            <select id="product-select-inventory" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                <option value="">Seleccione un producto...</option>
                                <option value="--NEW-PRODUCT--" class="font-bold text-brand-accent dark:text-brand-accent-alt">** + Agregar Nuevo Producto **</option>
                                <!-- Se llenará con JS -->
                            </select>
                        </div>
                        
                        <!-- NUEVO: Campo para el nombre del nuevo producto (oculto) -->
                        <div id="new-product-name-field" class="space-y-1" hidden>
                            <label for="product-name-new" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Nombre del Nuevo Producto</label>
                            <input type="text" id="product-name-new" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        
                        <div>
                            <!-- CAMBIO DE ETIQUETA -->
                            <label for="product-stock" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Stock (Cantidad a Agregar)</label>
                            <input type="number" id="product-stock" min="0" value="1" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        <div>
                            <!-- Costo (Obligatorio) -->
                            <label for="product-cost" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Costo (Por unidad)</label>
                            <input type="number" id="product-cost" required min="0" step="0.01" placeholder="Lo que te costó" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                            Guardar Producto
                        </button>
                    </form>
                </div>
                
                <!-- Columna 2: Inventario -->
                <div class="lg:col-span-2 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Inventario de Productos</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Costo (c/u)</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="products-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Productos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin del cambio -->

    </div>

    <!-- Modal para mensajes -->
    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 dark:bg-gray-800 dark:bg-opacity-75" hidden>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-brand-card dark:bg-gray-700 rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-lg font-semibold text-brand-text dark:text-brand-bg">Cargando...</h3>
                <div class="mt-2">
                    <p id="modal-message" class="text-sm text-brand-muted dark:text-gray-300">Por favor, espere.</p>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-brand-accent hover:bg-brand-accent-alt border border-transparent rounded-md" hidden>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Cliente (NUEVO) -->
    <!-- ESTE MODAL COMPLETO HA SIDO ELIMINADO -->
    


    <!-- Firebase SDKs -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANEJO DE MODO OSCURO (DE LA CONFIGURACIÓN PROPORCIONADA) ---
        function setupDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }

            toggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isNowDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isNowDark);
                // Vuelve a renderizar los íconos de Feather para asegurar que se muestren correctamente
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });
            
            // Reemplazar íconos de Feather al cargar
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
        document.addEventListener('DOMContentLoaded', setupDarkMode);


        // --- VARIABLES GLOBALES ---
        let db, auth, app;
        let userId;
        let isAuthReady = false;
        
        // Colecciones de Firestore
        let clientsCollection, salesCollection, productsCollection, shipmentsCollection;
        let saleItemsCollection; // <-- NUEVO

        // Estado temporal
        let currentSaleItems = [];
        let currentSaleTotal = 0;
        let productsCache = {}; // Cache para stock y costos
        let selectedClientId = null; // Para panel de envíos
        
        // Listeners de OnSnapshot (para poder desvincularlos al cambiar de cliente)
        let pendingSalesListener = null;
        let shipmentHistoryListener = null;


        // --- CONFIGURACIÓN DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // --- INICIALIZACIÓN ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // Autenticación
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    
                    // Definir rutas de las colecciones
                    clientsCollection = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                    salesCollection = collection(db, `artifacts/${appId}/users/${userId}/sales`);
                    productsCollection = collection(db, `artifacts/${appId}/users/${userId}/products`);
                    shipmentsCollection = collection(db, `artifacts/${appId}/users/${userId}/shipments`); // NUEVA
                    saleItemsCollection = collection(db, `artifacts/${appId}/users/${userId}/saleItems`); // <-- NUEVO

                    isAuthReady = true;
                    // Cargar datos iniciales
                    loadClients();
                    loadSales(); // MODIFICADO: Ahora carga items
                    loadProducts();

                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Error de autenticación:", authError);
                        showModal("Error de Autenticación", "No se pudo iniciar sesión. Por favor, recargue la página.");
                    }
                }
            });

        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            showModal("Error de Conexión", "No se pudo conectar a Firebase. Verifique la configuración.");
        }

        // --- MANEJO DE PESTAÑAS ---
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');

        // Función para resetear clases de tabs
        function resetTabStyles() {
            tabs.forEach(t => {
                t.classList.remove('text-brand-accent', 'border-brand-accent', 'dark:text-brand-accent-alt', 'dark:border-brand-accent-alt');
                t.classList.add('text-brand-muted', 'border-transparent', 'hover:text-brand-accent', 'dark:hover:text-brand-accent-alt', 'hover:border-brand-accent');
                t.classList.remove('font-semibold');
                t.classList.add('font-medium');
            });
        }
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                resetTabStyles();
                panels.forEach(p => p.setAttribute('hidden', true));
                
                // Aplicar estilos de pestaña activa
                tab.classList.remove('text-brand-muted', 'border-transparent', 'hover:text-brand-accent', 'dark:hover:text-brand-accent-alt', 'hover:border-brand-accent');
                tab.classList.add('text-brand-accent', 'border-brand-accent', 'dark:text-brand-accent-alt', 'dark:border-brand-accent-alt', 'font-semibold');

                const panelId = tab.getAttribute('data-tab') + '-panel';
                document.getElementById(panelId).removeAttribute('hidden');
            });
        });
        
        // Inicializar la primera pestaña como activa
        document.querySelector('.tab-btn[data-tab="clients"]').click();


        // --- MANEJO DE MODAL (Mensajes) ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        modalCloseBtn.addEventListener('click', () => modal.setAttribute('hidden', true));

        function showModal(title, message, showClose = true) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCloseBtn.style.display = showClose ? 'inline-flex' : 'none';
            modal.removeAttribute('hidden');
        }

        function hideModal() {
            modal.setAttribute('hidden', true);
        }

        // --- MANEJO DE MODAL (Agregar Cliente) ---
        // ESTA SECCIÓN HA SIDO ELIMINADA

        // --- Formateador de moneda (ej. S/ para Soles) ---
        const currencyFormatter = new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN',
            minimumFractionDigits: 2
        });


        // --- LÓGICA DE CLIENTES y ENVÍOS (MUY MODIFICADO) ---
        const clientsListSelectable = document.getElementById('clients-list-selectable');
        const saleClientSelect = document.getElementById('sale-client');
        const clientDetailPanel = document.getElementById('client-detail-panel');
        const clientDetailName = document.getElementById('client-detail-name');
        const clientDetailPhone = document.getElementById('client-detail-phone');
        const clientDetailSummaryBtn = document.getElementById('client-detail-summary-btn');

        // ELIMINADO: El 'clientForm' (del modal) ya no se usa para agregar clientes

        function loadClients() {
            if (!isAuthReady) return;

            onSnapshot(clientsCollection, (snapshot) => {
                clientsListSelectable.innerHTML = '';
                saleClientSelect.innerHTML = '<option value="">Seleccione un cliente...</option>';
                // NUEVO: Añadir la opción de crear nuevo cliente
                saleClientSelect.innerHTML += '<option value="--NEW--" class="font-bold text-brand-accent dark:text-brand-accent-alt">** + Agregar Nuevo Cliente **</option>';
                
                if (snapshot.empty) {
                    clientsListSelectable.innerHTML = '<p class="text-brand-muted dark:text-gray-500 text-sm">No hay clientes. ¡Agrega uno!</p>';
                    // No hay 'return' aquí para que la opción de "Nuevo Cliente" siempre aparezca
                }
                
                snapshot.forEach(doc => {
                    const client = doc.data();
                    const clientId = doc.id;

                    // Añadir a la lista seleccionable (Panel Clientes)
                    const div = document.createElement('div');
                    div.className = 'client-item p-3 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700';
                    div.setAttribute('data-id', clientId);
                    div.setAttribute('data-name', client.name);
                    div.setAttribute('data-phone', client.phone);
                    div.innerHTML = `
                        <p class="font-medium text-brand-text dark:text-brand-bg">${client.name}</p>
                        <p class="text-sm text-brand-muted dark:text-gray-400">${client.phone}</p>
                    `;
                    div.addEventListener('click', () => handleClientSelect(clientId, client.name, client.phone));
                    clientsListSelectable.appendChild(div);

                    // Añadir al select (Panel Ventas)
                    const option = document.createElement('option');
                    option.value = clientId;
                    option.textContent = client.name;
                    option.setAttribute('data-phone', client.phone);
                    option.setAttribute('data-name', client.name);
                    saleClientSelect.appendChild(option);
                });
                
                // Si había un cliente seleccionado, re-seleccionar para mantener el estado
                if (selectedClientId) {
                    const clientElement = document.querySelector(`.client-item[data-id="${selectedClientId}"]`);
                    if (clientElement) {
                        clientElement.click(); // Esto llama a handleClientSelect
                    } else {
                        selectedClientId = null; // Si el cliente fue borrado
                        clientDetailPanel.setAttribute('hidden', true);
                    }
                }
            }, (error) => {
                console.error("Error al cargar clientes:", error);
            });
        }
        
        // Manejador al seleccionar un cliente de la lista
        function handleClientSelect(clientId, name, phone) {
            selectedClientId = clientId; // Guardar ID globalmente
            
            // Resaltar cliente seleccionado
            document.querySelectorAll('.client-item').forEach(item => item.classList.remove('selected'));
            document.querySelector(`.client-item[data-id="${clientId}"]`).classList.add('selected');
            
            // Mostrar panel de detalle
            clientDetailPanel.removeAttribute('hidden');
            clientDetailName.textContent = name;
            clientDetailPhone.textContent = phone;
            
            // Configurar botón de resumen WhatsApp
            clientDetailSummaryBtn.removeAttribute('hidden');
            clientDetailSummaryBtn.setAttribute('data-id', clientId);
            clientDetailSummaryBtn.setAttribute('data-name', name);
            clientDetailSummaryBtn.setAttribute('data-phone', phone);
            
            // Cargar datos de ventas y envíos
            loadPendingSales(clientId);
            loadShipmentHistory(clientId);
        }
        
        // Cargar ventas pendientes para el cliente seleccionado
        const pendingSalesList = document.getElementById('pending-sales-list');
        function loadPendingSales(clientId) {
            if (pendingSalesListener) pendingSalesListener(); // Desvincular listener anterior
            
            // MODIFICADO: Consultar 'saleItemsCollection' en lugar de 'salesCollection'
            const q = query(saleItemsCollection, where("clientId", "==", clientId), where("enviado", "==", false));
            
            pendingSalesListener = onSnapshot(q, (snapshot) => {
                pendingSalesList.innerHTML = '';
                if (snapshot.empty) {
                    pendingSalesList.innerHTML = '<p class="text-sm text-brand-muted dark:text-gray-500">Este cliente no tiene items pendientes de envío.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const itemId = doc.id;
                    
                    // MODIFICADO: Mostrar item individual en lugar de venta agrupada
                    const div = document.createElement('div');
                    div.className = 'border-b pb-3 dark:border-gray-700';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <input id="item-${itemId}" data-item-id="${itemId}" type="checkbox" class="h-4 w-4 text-brand-accent border-gray-300 dark:border-gray-600 rounded focus:ring-brand-accent">
                            <label for="item-${itemId}" class="ml-3 block text-sm font-medium text-brand-text dark:text-brand-bg">
                                ${item.qty} x ${item.desc} ${item.color ? `(${item.color})` : ''} ${item.talla ? `[${item.talla}]` : ''}
                            </label>
                        </div>
                        <p class="ml-7 text-xs text-brand-muted dark:text-gray-400">
                            (De la venta del ${item.date} - Total Item: ${currencyFormatter.format(item.total)})
                        </p>
                    `;
                    pendingSalesList.appendChild(div);
                });
            }, (error) => console.error("Error al cargar items pendientes:", error));
        }

        // Cargar historial de envíos para el cliente seleccionado
        const shipmentHistoryList = document.getElementById('shipment-history-list');
        function loadShipmentHistory(clientId) {
            if (shipmentHistoryListener) shipmentHistoryListener(); // Desvincular listener
            
            const q = query(shipmentsCollection, where("clientId", "==", clientId));
            
            shipmentHistoryListener = onSnapshot(q, (snapshot) => {
                shipmentHistoryList.innerHTML = '';
                if (snapshot.empty) {
                    shipmentHistoryList.innerHTML = '<p class="text-sm text-brand-muted dark:text-gray-500">No hay historial de envíos para este cliente.</p>';
                    return;
                }
                
                // Capturar los detalles del cliente desde el panel
                const clientNameForButton = clientDetailName.textContent;
                const clientPhoneForButton = clientDetailPhone.textContent;

                snapshot.forEach(doc => {
                    const shipment = doc.data();
                    // Preparar datos para el botón
                    const itemsJson = JSON.stringify(shipment.items); 
                    
                    // MODIFICADO: Mapear 'items' en lugar de 'sales'
                    let itemsHtml = shipment.items.map(item => `
                        <li class="text-xs text-brand-muted dark:text-gray-400 ml-4">${item.description} (ID: ...${item.itemId.slice(-6)})</li>
                    `).join('');
                    
                    const div = document.createElement('div');
                    div.className = 'border-b pb-2 dark:border-gray-700';
                    // MODIFICADO: Añadir botón de WhatsApp con data-attributes
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-brand-text dark:text-brand-bg">Envío del ${shipment.fechaEnvio}</p>
                            <button 
                              class="btn-whatsapp-shipment text-xs text-green-600 dark:text-green-400 hover:text-green-800 font-medium"
                              data-shipment-date="${shipment.fechaEnvio}"
                              data-client-name="${clientNameForButton}"
                              data-client-phone="${clientPhoneForButton}"
                              data-items="${encodeURIComponent(itemsJson)}"
                            >
                              Resumen Wpp
                            </button>
                        </div>
                        <ul class="mt-1 list-disc list-inside">${itemsHtml}</ul>
                    `;
                    shipmentHistoryList.appendChild(div);
                });

            }, (error) => console.error("Error al cargar historial de envíos:", error));
        }

        // --- AÑADE ESTE NUEVO BLOQUE ---
        shipmentHistoryList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-whatsapp-shipment')) {
                const button = e.target;
                try {
                    const clientName = button.getAttribute('data-client-name');
                    const clientPhone = button.getAttribute('data-client-phone');
                    const shipmentDate = button.getAttribute('data-shipment-date');
                    const items = JSON.parse(decodeURIComponent(button.getAttribute('data-items')));
                    
                    generateShipmentWhatsAppSummary(clientName, clientPhone, shipmentDate, items);
                } catch (error) {
                    console.error("Error al parsear datos del envío:", error);
                    showModal("Error", "No se pudieron cargar los datos para el resumen.");
                }
            }
        });
        // --- FIN DEL NUEVO BLOQUE ---

        // Botón de Crear Envío
        const createShipmentBtn = document.getElementById('create-shipment-btn');
        createShipmentBtn.addEventListener('click', async () => {
            if (!selectedClientId) return;
            
            const fechaEnvio = document.getElementById('shipment-date').value;
            if (!fechaEnvio) {
                showModal("Falta la fecha", "Por favor, seleccione una fecha de envío.");
                return;
            }
            
            // MODIFICADO: Seleccionar items individuales
            const selectedItemsCheckboxes = pendingSalesList.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedItemsCheckboxes.length === 0) {
                showModal("Sin items", "Seleccione al menos un item para incluir en el envío.");
                return;
            }
            
            showModal("Procesando Envío", "Creando envío y actualizando items...", false);
            
            try {
                // MODIFICADO: Listas para items y ventas padres
                const itemsToShip = []; // Para guardar en el doc de envío
                const itemRefsToUpdate = []; // Para actualizar los items
                const parentSaleIds = new Set(); // Para verificar si la venta padre se completó

                // Recolectar info de los items seleccionados
                for (const checkbox of selectedItemsCheckboxes) {
                    const itemId = checkbox.getAttribute('data-item-id');
                    const itemRef = doc(saleItemsCollection, itemId);
                    const itemDoc = await getDoc(itemRef);
                    if (itemDoc.exists()) {
                        const itemData = itemDoc.data();
                        itemsToShip.push({
                            itemId: itemId,
                            description: `${itemData.qty} x ${itemData.desc} ${itemData.color || ''} ${itemData.talla || ''}`,
                            total: itemData.total
                        });
                        itemRefsToUpdate.push(itemRef);
                        parentSaleIds.add(itemData.saleId); // Guardar el ID de la venta padre
                    }
                }
                
                // 1. Crear el documento de Envío (con 'items' en lugar de 'sales')
                await addDoc(shipmentsCollection, {
                    clientId: selectedClientId,
                    clienteName: clientDetailName.textContent,
                    fechaEnvio: fechaEnvio,
                    items: itemsToShip, // Array de objetos de items
                    createdAt: new Date().toISOString()
                });
                
                // 2. Actualizar todos los items a "enviado: true"
                for (const itemRef of itemRefsToUpdate) {
                    await updateDoc(itemRef, { enviado: true });
                }

                // 3. (NUEVO) Verificar y actualizar las ventas padre
                for (const saleId of parentSaleIds) {
                    const q = query(saleItemsCollection, where("saleId", "==", saleId), where("enviado", "==", false));
                    const remainingItemsSnap = await getDocs(q);
                    
                    // Si no quedan items pendientes, marcar la VENTA padre como enviada
                    if (remainingItemsSnap.empty) {
                        await updateDoc(doc(salesCollection, saleId), { enviado: true });
                    }
                }
                
                document.getElementById('shipment-date').value = '';
                hideModal();
                showModal("Éxito", "El envío se ha registrado y los items se han actualizado.");
                
            } catch (error) {
                console.error("Error al crear envío:", error);
                hideModal();
                showModal("Error", "No se pudo crear el envío. " + error.message);
            }
        });
        
        // Botón Resumen WhatsApp
        clientDetailSummaryBtn.addEventListener('click', (e) => {
             const id = e.target.getAttribute('data-id');
             const name = e.target.getAttribute('data-name');
             const phone = e.target.getAttribute('data-phone');
             generateWhatsAppSummary(id, name, phone);
        });


        // --- LÓGICA DE VENTAS (MODIFICADA) ---
        const saleForm = document.getElementById('add-sale-form');
        const salesList = document.getElementById('sales-list');
        const addSaleItemBtn = document.getElementById('add-sale-item-btn');
        const currentSaleItemsList = document.getElementById('current-sale-items');
        const currentSaleTotalEl = document.getElementById('current-sale-total');
        const saleProductSelect = document.getElementById('sale-product-select');
        // NUEVO: Referencia a los campos de nuevo cliente
        const newClientFields = document.getElementById('new-client-fields');
        // ELIMINADO: Referencia a los campos de nuevo producto
        // const newProductFields = document.getElementById('new-product-fields');

        // NUEVO: Referencia a los campos del formulario de productos
        const productSelectInventory = document.getElementById('product-select-inventory');
        const newProductNameField = document.getElementById('new-product-name-field');

        // NUEVO: Listener para mostrar/ocultar los campos de nuevo cliente
        saleClientSelect.addEventListener('change', () => {
            if (saleClientSelect.value === '--NEW--') {
                newClientFields.removeAttribute('hidden');
            } else {
                newClientFields.setAttribute('hidden', true);
            }
        });

        // ELIMINADO: Listener para mostrar/ocultar los campos de nuevo producto
        /*
        saleProductSelect.addEventListener('change', () => {
            if (saleProductSelect.value === '--NEW-PRODUCT--') {
                newProductFields.removeAttribute('hidden');
            } else {
                newProductFields.setAttribute('hidden', true);
            }
        });
        */

        // NUEVO: Listener para el selector de productos en el inventario
        productSelectInventory.addEventListener('change', () => {
            if (productSelectInventory.value === '--NEW-PRODUCT--') {
                newProductNameField.removeAttribute('hidden');
            } else {
                newProductNameField.setAttribute('hidden', true);
            }
        });


        function updateSaleTotal() {
            currentSaleTotal = currentSaleItems.reduce((acc, item) => acc + item.total, 0);
            currentSaleTotalEl.textContent = currentSaleTotal.toFixed(2);
        }

        function renderCurrentSaleItems() {
            currentSaleItemsList.innerHTML = '';
            currentSaleItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center text-xs";
                li.innerHTML = `
                    <span>${item.qty} x ${item.desc} ${item.color || ''} ${item.talla || ''} (S/ ${item.price.toFixed(2)} c/u)</span>
                    <button type="button" data-index="${index}" class="btn-remove-item text-red-500 font-bold px-1 hover:text-red-700">X</button>
                `;
                currentSaleItemsList.appendChild(li);
            });
            updateSaleTotal();
        }

        currentSaleItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove-item')) {
                const index = parseInt(e.target.getAttribute('data-index'), 10);
                currentSaleItems.splice(index, 1);
                renderCurrentSaleItems();
            }
        });

        addSaleItemBtn.addEventListener('click', async () => {
            const qty = parseInt(document.getElementById('sale-item-qty').value, 10);
            const price = parseFloat(document.getElementById('sale-item-price').value);
            const color = document.getElementById('sale-item-color').value;
            const talla = document.getElementById('sale-item-talla').value;
            const selectedOption = saleProductSelect.options[saleProductSelect.selectedIndex];

            let productId, productName, productCost, productStock;

            // --- Lógica para manejar producto nuevo vs. existente ---
            // ELIMINADO: Bloque "if (selectedOption.value === '--NEW-PRODUCT--')"
            
            if (selectedOption.value) {
                // --- PRODUCTO EXISTENTE ---
                productId = selectedOption.value;
                const product = productsCache[productId];
                if (!product) {
                     showModal("Error", "No se encontró el producto en cache.");
                     return;
                }
                if (qty > product.stock) {
                    showModal("Stock insuficiente", `Solo quedan ${product.stock} unidades de ${product.name}.`);
                    return;
                }
                productName = product.name;
                productCost = product.cost;
                productStock = product.stock;

            } else {
                // No se seleccionó nada
                showModal("Datos incompletos", "Seleccione un producto, cantidad y un precio de venta válido.");
                return;
            }

            // --- Lógica común para agregar el item ---
            if (qty <= 0 || !price || price <= 0) {
                showModal("Datos incompletos", "La cantidad y el precio de venta deben ser mayores a 0.");
                return;
            }
            
            const existingItem = currentSaleItems.find(item => item.productId === productId && item.color === color && item.talla === talla);
            if(existingItem) {
                showModal("Item duplicado", "Ese producto (con mismo color y talla) ya está en la lista. Bórrelo para agregar una nueva cantidad.");
                return;
            }

            currentSaleItems.push({
                productId,
                desc: productName,
                qty,
                price, // Precio de venta (del input)
                costo: productCost, // Costo (del producto)
                total: qty * price,
                totalCosto: qty * productCost,
                color: color || '',
                talla: talla || ''
            });
            renderCurrentSaleItems();
            
            // Limpiar inputs
            saleProductSelect.selectedIndex = 0;
            document.getElementById('sale-item-qty').value = '1';
            document.getElementById('sale-item-price').value = '';
            document.getElementById('sale-item-color').value = '';
            document.getElementById('sale-item-talla').value = '';
            // ELIMINADO: Limpiar y ocultar campos de nuevo producto
            // newProductFields.setAttribute('hidden', true);
            // document.getElementById('new-product-name').value = '';
            // document.getElementById('new-product-stock').value = '1';
            // document.getElementById('new-product-cost').value = '';
        });

        saleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;

            const selectedOption = saleClientSelect.options[saleClientSelect.selectedIndex];
            const clientId = selectedOption.value;
            const date = document.getElementById('sale-date').value;

            // NUEVO: Lógica para manejar cliente nuevo vs. existente
            let finalClientId, clientName, clientPhone;

            if (clientId === '--NEW--') {
                // --- CREAR NUEVO CLIENTE ---
                clientName = document.getElementById('new-client-name').value;
                clientPhone = document.getElementById('new-client-phone').value;
                
                if (!clientName || !clientPhone) {
                    showModal("Datos incompletos", "Debe ingresar el nombre y teléfono del nuevo cliente.");
                    return;
                }
                
                showModal("Creando Cliente", "Guardando nuevo cliente...", false);
                
                try {
                    // Guardar el nuevo cliente
                    const newClientRef = await addDoc(clientsCollection, {
                        name: clientName,
                        phone: clientPhone,
                        email: '' // Email es opcional
                    });
                    finalClientId = newClientRef.id;
                    
                    // Seleccionar automáticamente el nuevo cliente en el dropdown
                    // (El listener de loadClients() lo añadirá, pero lo forzamos aquí)
                    const option = document.createElement('option');
                    option.value = finalClientId;
                    option.textContent = clientName;
                    option.setAttribute('data-phone', clientPhone);
                    option.setAttribute('data-name', clientName);
                    option.selected = true;
                    saleClientSelect.appendChild(option);

                } catch (error) {
                    console.error("Error al crear nuevo cliente:", error);
                    showModal("Error", "No se pudo guardar el nuevo cliente.");
                    return;
                }

            } else if (clientId) {
                // --- CLIENTE EXISTENTE ---
                finalClientId = clientId;
                clientName = selectedOption.getAttribute('data-name');
                clientPhone = selectedOption.getAttribute('data-phone');
            } else {
                // No se seleccionó nada
                showModal("Venta incompleta", "Seleccione un cliente o agregue uno nuevo.");
                return;
            }

            // --- VALIDACIÓN DE ITEMS Y FECHA ---
            if (currentSaleItems.length === 0 || !date) {
                showModal("Venta incompleta", "Agregue al menos un item y elija una fecha.");
                return;
            }
            
            const totalCostoVenta = currentSaleItems.reduce((acc, item) => acc + item.totalCosto, 0);

            showModal("Procesando Venta", "Guardando y actualizando stock...", false);

            try {
                // 1. Guardar la venta (AHORA CON EL ID CORRECTO)
                const newSaleRef = await addDoc(salesCollection, { // <-- Capturar la referencia
                    clientId: finalClientId, // Usar el ID final (nuevo o existente)
                    clientName,
                    clientPhone,
                    date,
                    items: currentSaleItems,
                    total: currentSaleTotal,
                    totalCosto: totalCostoVenta, // Guardamos el costo total
                    enviado: false // NUEVO
                });

                // --- NUEVO: 2. Generar registro único por producto ---
                for (const item of currentSaleItems) {
                    await addDoc(saleItemsCollection, {
                        saleId: newSaleRef.id, // Vínculo a la venta principal
                        clientId: finalClientId,
                        clientName: clientName,
                        date: date,
                        enviado: false, // Estado inicial
                        
                        // Datos del item
                        productId: item.productId,
                        desc: item.desc,
                        qty: item.qty,
                        price: item.price,
                        costo: item.costo,
                        total: item.total,
                        totalCosto: item.totalCosto,
                        color: item.color,
                        talla: item.talla
                    });
                }
                // --- FIN NUEVO ---

                // 3. Actualizar el stock (Antes era el 2)
                for (const item of currentSaleItems) {
                    const productRef = doc(productsCollection, item.productId);
                    const product = productsCache[item.productId];
                    if (product) {
                        const newStock = product.stock - item.qty;
                        await updateDoc(productRef, { stock: newStock });
                    }
                }

                // Resetear formulario
                saleForm.reset();
                currentSaleItems = [];
                renderCurrentSaleItems();
                document.getElementById('sale-date').valueAsDate = new Date();
                newClientFields.setAttribute('hidden', true); // Ocultar campos de nuevo cliente
                
                hideModal();
                showModal("Venta Exitosa", "La venta se guardó y el stock se actualizó.");
                
            } catch (error) {
                console.error("Error al guardar venta:", error);
                hideModal();
                showModal("Error", "No se pudo guardar la venta o actualizar el stock.");
            }
        });

        // --- LÓGICA DE VENTAS MODIFICADA ---
        function loadSales() {
            if (!isAuthReady) return;

            // MODIFICADO: Escuchar 'saleItemsCollection' en lugar de 'salesCollection'
            onSnapshot(saleItemsCollection, (snapshot) => {
                salesList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data(); // Ahora 'item' es un item de venta individual
                    const tr = document.createElement('tr');
                    
                    // Definir estado
                    let estadoHtml = item.enviado 
                        ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-700 text-green-800 dark:text-green-200">Enviado</span>'
                        : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-200">Pendiente</span>';
                    
                    // Construir descripción del producto (con color y talla si existen)
                    let productDesc = item.desc;
                    if (item.color) productDesc += ` (${item.color})`;
                    if (item.talla) productDesc += ` [${item.talla}]`;

                    // MODIFICADO: Generar fila de tabla con datos del item
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${item.clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${productDesc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.qty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${currencyFormatter.format(item.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${estadoHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <!-- MODIFICADO: El botón ahora usa 'data-sale-id' y elimina la VENTA COMPLETA -->
                            <button data-sale-id="${item.saleId}" class="btn-delete-sale text-red-600 hover:text-red-900">Eliminar Venta</button>
                        </td>
                    `;
                    salesList.appendChild(tr);
                });
            }, (error) => console.error("Error al cargar items de ventas:", error));
        }
        
        salesList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-delete-sale')) {
                // MODIFICADO: Obtener 'data-sale-id' en lugar de 'data-id'
                const saleId = e.target.getAttribute('data-sale-id');
                
                // TODO: Agregar lógica para restaurar stock si se borra una venta
                if (confirm("¿Estás seguro de que deseas eliminar la VENTA COMPLETA asociada a este item? (El stock NO se restaurará automáticamente). Esta acción eliminará todos los items de esa venta.")) {
                    try {
                        // 1. Eliminar la venta principal
                        await deleteDoc(doc(salesCollection, saleId)); // Usar saleId
                        
                        // --- 2. Eliminar los items de venta asociados (lógica existente es correcta) ---
                        const qItems = query(saleItemsCollection, where("saleId", "==", saleId)); // Usar saleId
                        const itemsSnapshot = await getDocs(qItems);
                        for (const itemDoc of itemsSnapshot.docs) {
                            await deleteDoc(itemDoc.ref);
                        }
                        // --- FIN ---
                        
                    } catch (error) {
                        showModal("Error", "No se pudo eliminar la venta.");
                    }
                }
            }
        });
        // --- FIN DE MODIFICACIÓN DE LÓGICA DE VENTAS ---


        // --- LÓGICA DE PRODUCTOS (MODIFICADA) ---
        const productForm = document.getElementById('add-product-form');
        const productsList = document.getElementById('products-list');

        // NUEVO: Función extraída para crear o actualizar productos (reutilizable)
        async function createOrUpdateProduct(name, stockToAdd, newCost) {
            if (stockToAdd < 0 || newCost <= 0 || !name) {
                throw new Error("Datos de producto inválidos. Se requiere nombre, stock positivo y costo positivo.");
            }
            
            // 1. Buscar si el producto ya existe (por nombre exacto)
            const q = query(productsCollection, where("name", "==", name));
            const querySnapshot = await getDocs(q);

            let productId;

            if (querySnapshot.empty) {
                // --- PRODUCTO NUEVO ---
                const newDocRef = await addDoc(productsCollection, { 
                    name: name, 
                    stock: stockToAdd, 
                    cost: newCost 
                });
                productId = newDocRef.id;

            } else {
                // --- PRODUCTO EXISTENTE ---
                const productDoc = querySnapshot.docs[0];
                const productRef = productDoc.ref;
                productId = productDoc.id;
                const productData = productDoc.data();

                const oldStock = productData.stock || 0;
                const oldCost = productData.cost || 0;

                // Calcular nuevo stock total
                const newTotalStock = oldStock + stockToAdd;

                // Calcular nuevo costo promedio ponderado
                let newAverageCost = newCost; // Por defecto, el nuevo costo
                if (newTotalStock > 0) { // Evitar división por cero
                    const oldTotalValue = oldStock * oldCost;
                    const newTotalValue = stockToAdd * newCost;
                    newAverageCost = (oldTotalValue + newTotalValue) / newTotalStock;
                }

                // Actualizar el documento
                await updateDoc(productRef, {
                    stock: newTotalStock,
                    cost: newAverageCost
                });
            }
            return productId; // Devuelve el ID del producto creado o actualizado
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;

            // --- Lógica de Submit Modificada ---
            const selectedProductId = productSelectInventory.value;
            const stockToAdd = parseInt(document.getElementById('product-stock').value, 10);
            const newCost = parseFloat(document.getElementById('product-cost').value);
            
            let name;

            if (selectedProductId === '--NEW-PRODUCT--') {
                name = document.getElementById('product-name-new').value.trim();
                if (!name) {
                    showModal("Datos incompletos", "Debe ingresar un nombre para el nuevo producto.");
                    return;
                }
            } else if (selectedProductId) {
                name = productSelectInventory.options[productSelectInventory.selectedIndex].text;
            } else {
                showModal("Datos incompletos", "Seleccione un producto o cree uno nuevo.");
                return;
            }
            // --- Fin Lógica de Submit Modificada ---


            showModal("Actualizando Inventario", "Guardando producto...", false);

            try {
                await createOrUpdateProduct(name, stockToAdd, newCost);
                
                hideModal();
                showModal("Éxito", `Inventario de "${name}" actualizado.`);
                productForm.reset();
                newProductNameField.setAttribute('hidden', true); // Ocultar el campo de nuevo nombre

            } catch (error) {
                console.error("Error al guardar/actualizar producto:", error);
                hideModal();
                showModal("Error", "No se pudo actualizar el inventario. " + error.message);
            }
        });

        function loadProducts() {
            if (!isAuthReady) return;

            onSnapshot(productsCollection, (snapshot) => {
                productsList.innerHTML = '';
                saleProductSelect.innerHTML = '<option value="">Seleccione un producto...</option>';
                // NUEVO: Limpiar y re-poblar el select del inventario
                productSelectInventory.innerHTML = '<option value="">Seleccione un producto...</option>';
                productSelectInventory.innerHTML += '<option value="--NEW-PRODUCT--" class="font-bold text-brand-accent dark:text-brand-accent-alt">** + Agregar Nuevo Producto **</option>';

                // ELIMINADO: Opción de crear nuevo producto
                // saleProductSelect.innerHTML += '<option value="--NEW-PRODUCT--" ... </option>';
                
                productsCache = {};

                snapshot.forEach(doc => {
                    const product = doc.data();
                    const productId = doc.id;
                    
                    productsCache[productId] = { ...product, id: productId }; // Llenar cache

                    // Llenar la tabla de productos
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${currencyFormatter.format(product.cost)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${productId}" class="btn-delete-product text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    `;
                    productsList.appendChild(tr);

                    // Llenar el select en el panel de Ventas
                    const option = document.createElement('option');
                    option.value = productId;
                    if (product.stock > 0) {
                        option.textContent = `${product.name} (Stock: ${product.stock})`;
                        option.disabled = false;
                    } else {
                        option.textContent = `${product.name} (SIN STOCK)`;
                        option.disabled = true;
                    }
                    saleProductSelect.appendChild(option);
                    
                    // NUEVO: Llenar el select en el panel de Productos (Inventario)
                    const optionInventory = document.createElement('option');
                    optionInventory.value = productId;
                    optionInventory.textContent = product.name;
                    productSelectInventory.appendChild(optionInventory);
                });
            }, (error) => console.error("Error al cargar productos:", error));
        }
        
        productsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-delete-product')) {
                const id = e.target.getAttribute('data-id');
                if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                    try {
                        await deleteDoc(doc(productsCollection, id));
                    } catch (error) {
                        showModal("Error", "No se pudo eliminar el producto.");
                    }
                }
            }
        });

        // --- LÓGICA DEL RESUMEN DE WHATSAPP ---
        async function generateWhatsAppSummary(clientId, clientName, clientPhone) {
            if (!isAuthReady) return;
            showModal("Generando Resumen", "Buscando todas las ventas del cliente...", false);
            try {
                const q = query(salesCollection, where("clientId", "==", clientId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showModal("Sin Ventas", "Este cliente no tiene ventas registradas.");
                    return;
                }

                let message = `¡Hola ${clientName}! 😃\n\nEste es un resumen de *todas* tus compras:\n\n`;
                let grandTotal = 0;
                
                const sales = [];
                querySnapshot.forEach(doc => sales.push(doc.data()));
                sales.sort((a, b) => new Date(a.date) - new Date(b.date));

                sales.forEach(sale => {
                    message += `*Fecha: ${sale.date}* (Total: ${currencyFormatter.format(sale.total)})${sale.enviado ? ' - Enviado' : ''}\n`;
                    sale.items.forEach(item => {
                        message += `  - ${item.qty} x ${item.desc} ${item.color || ''} ${item.talla || ''}\n`;
                    });
                    message += "\n";
                    grandTotal += sale.total;
                });

                message += `*TOTAL GENERAL: ${currencyFormatter.format(grandTotal)}*\n\n`;
                message += "¡Gracias por tu preferencia! 🙌";

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${clientPhone}?text=${encodedMessage}`;
                
                hideModal();
                window.open(whatsappUrl, '_blank');

            } catch (error) {
                hideModal();
                showModal("Error", "No se pudo generar el resumen de ventas.");
            }
        }
        
        // --- AÑADE ESTA NUEVA FUNCIÓN ---
        function generateShipmentWhatsAppSummary(clientName, clientPhone, shipmentDate, items) {
            if (!clientName || !clientPhone || !items) {
                showModal("Error", "Faltan datos del cliente o del envío.");
                return;
            }

            let message = `¡Hola ${clientName}! 👋\n\nTe enviamos el detalle de tu *envío del ${shipmentDate}*:\n\n`;
            
            let totalEnvio = 0;
            items.forEach(item => {
                // 'item.description' ya viene formateado ("10 x gorra...")
                message += `  - ${item.description}\n`; 
                totalEnvio += item.total || 0; // Sumar el total del item
            });

            message += `\n*Total de este envío: ${currencyFormatter.format(totalEnvio)}*\n\n`;
            message += "¡Muchas gracias! 😊";

            const encodedMessage = encodeURIComponent(message);
            
            // Validar teléfono (simple)
            if (clientPhone.length < 8) {
                showModal("Error", `El número de teléfono "${clientPhone}" no parece válido.`);
                return;
            }
            const whatsappUrl = `https://wa.me/${clientPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        // --- FIN DE LA NUEVA FUNCIÓN ---

        // --- INICIALIZAR FECHAS ---
        document.getElementById('sale-date').valueAsDate = new Date();
        document.getElementById('shipment-date').valueAsDate = new Date();

    </script>
</body>
</html>
