<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latam5S — Organiza tus envíos con calma</title>
    <meta name="description" content="Organiza tus envíos sin direcciones confusas ni mensajes perdidos. Latam5S es la herramienta para emprendedores que buscan calma y eficiencia.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for Dark Mode Toggle -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Estilos base y para la fuente personalizada */
        body {
            font-family: "Quicksand", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        }
        [hidden] { display: none; }
        select:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        
        /* Estilo para cliente seleccionado */
        .client-item.selected {
            background-color: #f7e0d6; /* Ligero brand-accent */
            border-left-width: 4px;
            border-color: #D96B4F; /* brand-accent */
        }
        .dark .client-item.selected {
            background-color: #374151; /* gray-700 en dark mode */
            border-color: #FF8B6A; /* brand-accent-alt en dark mode */
        }

        /* Ocultar flechas en inputs de tipo número */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* --- NUEVO: Estilos para el Autocompletado --- */
        .autocomplete-results {
            position: absolute;
            width: 100%; /* El 100% de su contenedor padre */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            background-color: #ffffff;
            border-radius: 0 0 0.375rem 0.375rem; /* rounded-b-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .autocomplete-results {
            background-color: #1f2937; /* gray-800 */
            border-color: #4b5563; /* gray-600 */
        }
        .autocomplete-item {
            padding: 0.75rem 1rem; /* p-3 px-4 */
            cursor: pointer;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background-color: #f3f4f6; /* gray-100 */
        }
        .dark .autocomplete-item:hover, .dark .autocomplete-item.selected {
            background-color: #374151; /* gray-700 */
        }
        .autocomplete-item strong {
            color: #D96B4F; /* brand-accent */
        }
        .autocomplete-item .new-item {
            font-weight: 600;
            color: #D96B4F; /* brand-accent */
        }
        .dark .autocomplete-item .new-item {
            color: #FF8B6A; /* brand-accent-alt */
        }
        /* --- FIN NUEVO: Estilos Autocompletado --- */

    </style>

    <script>
        // Configuración personalizada para Tailwind CSS
        tailwind.config = {
            darkMode: 'class', // Habilitar modo oscuro basado en clase
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#fffaf6',
                        'brand-card': '#ffffff',
                        'brand-text': '#2b2b2b',
                        'brand-muted': '#6b6b6b',
                        'brand-accent': '#D96B4F', // Color principal para botones y acentos
                        'brand-accent-alt': '#FF8B6A', // Color de hover y acentos secundarios
                    },
                    fontFamily: {
                        'quicksand': ['Quicksand', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-bg font-quicksand antialiased text-brand-text dark:bg-gray-900 dark:text-brand-bg">

    <!-- NUEVO: Contenedor de Autenticación -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md">
            <!-- Vista de Login -->
            <div id="login-view">
                <form id="login-form" class="bg-brand-card dark:bg-gray-800 shadow-xl rounded-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-brand-text dark:text-brand-bg">Iniciar Sesión</h2>
                    <p class="text-center text-sm text-brand-muted dark:text-gray-400">Ingresa a tu panel de gestión.</p>
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Correo</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Contraseña</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                    </div>
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                        Ingresar
                    </button>
                    <p class="text-sm text-center">
                        <a href="#" id="forgot-password-link" class="font-medium text-brand-accent hover:text-brand-accent-alt">¿Olvidaste tu contraseña?</a>
                    </p>
                </form>
            </div>
        </div>
    </div>


    <!-- Contenedor principal de la APP (Ahora oculto por defecto) -->
    <div id="main-app" class="p-4 sm:p-6 lg:p-8 hidden">

        <!-- Encabezado -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-brand-text dark:text-brand-bg">Panel de Gestión Latam5S</h1>
            <!-- MODIFICADO: Muestra el email del usuario -->
            <p class="text-sm text-brand-muted dark:text-gray-400">Usuario: <span id="userIdDisplay" class="font-medium text-brand-text dark:text-brand-bg">Cargando...</span></p>
            
            <div class="flex space-x-4">
                <!-- Botón de Modo Oscuro -->
                <button id="darkModeToggle" class="mt-2 text-sm text-brand-muted dark:text-gray-400 hover:text-brand-accent dark:hover:text-brand-accent-alt transition duration-150">
                    <i data-feather="moon" class="w-5 h-5 inline-block align-middle dark:hidden"></i>
                    <i data-feather="sun" class="w-5 h-5 inline-block align-middle hidden dark:inline-block"></i>
                    Cambiar Tema
                </button>

                <!-- NUEVO: Botón de Cerrar Sesión -->
                <button id="logoutButton" class="mt-2 text-sm text-brand-muted dark:text-gray-400 hover:text-brand-accent dark:hover:text-brand-accent-alt transition duration-150">
                    <i data-feather="log-out" class="w-5 h-5 inline-block align-middle"></i>
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs" id="tabs">
                    <!-- Clientes y Envíos -->
                    <button data-tab="clients" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm text-brand-accent border-brand-accent dark:text-brand-accent-alt dark:border-brand-accent-alt">
                        Clientes y Envíos
                    </button>
                    <!-- Ventas -->
                    <button data-tab="sales" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-brand-muted border-transparent hover:text-brand-accent dark:hover:text-brand-accent-alt hover:border-brand-accent">
                        Ventas
                    </button>
                    <!-- Productos -->
                    <button data-tab="products" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-brand-muted border-transparent hover:text-brand-accent dark:hover:text-brand-accent-alt hover:border-brand-accent">
                        Productos
                    </button>
                </nav>
            </div>
        </div>

        <!-- Paneles de Contenido -->

        <!-- Panel de Clientes y Envíos -->
        <div id="clients-panel" class="tab-panel">
            <div class="flex justify-end mb-4">
                <!-- BOTÓN ELIMINADO - Ya no se agrega cliente desde aquí -->
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna 1: Lista de Clientes Seleccionable -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Lista de Clientes</h2>
                    <!-- NUEVO: Buscador de Clientes -->
                    <div class="mb-4">
                        <input type="text" id="client-list-search" placeholder="Buscar por teléfono..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                    </div>
                    <div id="clients-list-selectable" class="space-y-2">
                        <!-- Clientes se cargarán aquí -->
                        <p class="text-brand-muted dark:text-gray-400 text-sm">Cargando clientes...</p>
                    </div>
                </div>
                
                <!-- Columna 2: Detalle de Cliente y Envíos -->
                <div id="client-detail-panel" class="lg:col-span-2 space-y-6" hidden>
                    
                    <!-- Detalles del Cliente (Tarjeta eliminada por solicitud) -->
                    
                     <!-- Ventas Pendientes de Envío -->
                    <div class="bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Ventas Pendientes de Envío</h3>
                        <div id="pending-sales-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Ventas pendientes se cargarán aquí -->
                        </div>
                        <div class="mt-6 border-t pt-4 space-y-3 dark:border-gray-700">
                            <h4 class="text-md font-medium text-brand-text dark:text-brand-bg">Agrupar en nuevo envío</h4>
                            <div>
                                <label for="shipment-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Envío</label>
                                <input type="date" id="shipment-date" required class="mt-1 block w-full sm:w-1/2 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                            </div>
                            <button id="create-shipment-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:ring-green-500">
                                Crear Envío con Ventas Seleccionadas
                            </button>
                        </div>
                    </div>

                    <!-- Historial de Envíos -->
                    <div class="bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Historial de Envíos</h3>
                        <div id="shipment-history-list" class="space-y-3">
                            <!-- Historial se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Ventas -->
        <div id="sales-panel" class="tab-panel" hidden>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna 1: Formulario de Venta -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Registrar Nueva Venta</h2>
                    <form id="add-sale-form" class="space-y-4">
                        <div>
                            <!-- MODIFICADO: Buscador de Clientes con Autocompletado -->
                            <div class="relative">
                                <label for="client-search" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Buscar o Registrar Cliente</label>                                <input type="text" id="client-search" placeholder="Escribir teléfono..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                <input type="hidden" id="sale-client-id">
                                <!-- Contenedor de autocompletado -->
                                <div id="client-search-results" class="autocomplete-results hidden"></div>
                                <p class="text-xs text-brand-muted dark:text-gray-400 mt-1">Escriba un teléfono. Si no existe, se registrará al guardar.</p>
                            </div>
                        </div>    
                        
                        <!-- Sección de items modificada -->
                        <div class="border border-gray-200 dark:border-gray-600 rounded-md p-4 space-y-3">
                            <h3 class="text-md font-semibold text-brand-text dark:text-brand-bg">Items de la Venta</h3>
                            <div class="space-y-2">
                                <!-- MODIFICADO: Buscador de Productos (Venta) con Autocompletado -->
                                <div class="relative">
                                    <label for="sale-product-search" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Buscar Producto</label>
                                    <input type="text" id="sale-product-search" placeholder="Escribir nombre del producto..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                    <input type="hidden" id="sale-product-id">
                                    <!-- Contenedor de autocompletado -->
                                    <div id="sale-product-search-results" class="autocomplete-results hidden"></div>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="sale-item-qty" placeholder="Cantidad" min="1" value="1" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <!-- MODIFICADO: Placeholder -->
                                    <input type="number" id="sale-item-price" placeholder="Precio Total (por este lote)" min="0" step="0.01" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="sale-item-color" placeholder="Color (Opcional)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <input type="text" id="sale-item-talla" placeholder="Talla (Opcional)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                </div>
                                <button type="button" id="add-sale-item-btn" class="w-full text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt py-2 focus:ring-brand-accent">
                                    Agregar Item a la Venta
                                </button>
                            </div>
                            <ul id="current-sale-items" class="text-sm space-y-1 text-brand-text dark:text-brand-bg">
                                <!-- Items agregados temporalmente -->
                            </ul>
                            <div class="text-right font-bold text-lg text-brand-accent dark:text-brand-accent-alt">
                                Total Venta: S/ <span id="current-sale-total">0.00</span>
                            </div>
                        </div>
                        <!-- Fin del cambio -->

                        <!-- MODIFICADO: Agrupado en cuadrícula -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sale-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Venta</label>
                                <input type="date" id="sale-date" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                            </div>
                            <!-- NUEVO CAMPO: Medio de Pago -->
                            <div>
                                <label for="sale-payment-method" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Medio de Pago</label>
                                <select id="sale-payment-method" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                    <option value="">Seleccione...</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Yape">Yape</option>
                                    <option value="Plin">Plin</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                            Guardar Venta y Actualizar Stock
                        </button>
                    </form>
                </div>
                
                <!-- Columna 2: Historial de Ventas (MODIFICADO) -->
                <div class="lg:col-span-2 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Historial de Items Vendidos</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- CABECERA DE TABLA MODIFICADA -->
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cant.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Total Item</th>
                                    <!-- NUEVA COLUMNA -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Medio de Pago</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Items vendidos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Productos -->
        <div id="products-panel" class="tab-panel" hidden>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Columna 1: Formulario de Productos -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Agregar/Actualizar Inventario</h2>
                    <form id="add-product-form" class="space-y-4">
                        
                        <!-- MODIFICADO: Buscador de Productos (Inventario) con Autocompletado -->
                        <div class="relative">
                            <label for="product-search-inventory" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Buscar o Crear Producto</label>
                            <input type="text" id="product-search-inventory" placeholder="Escribir nombre..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                            <input type="hidden" id="product-inventory-id">
                            <!-- Contenedor de autocompletado -->
                            <div id="product-search-inventory-results" class="autocomplete-results hidden"></div>
                            <p class="text-xs text-brand-muted dark:text-gray-400 mt-1">Seleccione un producto para sumar stock, o escriba un nombre nuevo y guarde.</p>
                        </div>
                        
                        <div>
                            <!-- CAMBIO DE ETIQUETA -->
                            <label for="product-stock" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Stock (Cantidad a Agregar)</label>
                            <input type="number" id="product-stock" min="0" value="1" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        <div>
                            <!-- MODIFICADO: Costo (ObligatorGatorio) -->
                            <label for="product-cost" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Costo Total (por este lote)</label>

                            <input type="number" id="product-cost" required min="0" step="0.01" placeholder="Costo total del lote" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        
                        <!-- NUEVO CAMPO DE FECHA -->
                        <div>
                            <label for="product-purchase-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Compra</label>
                            <input type="date" id="product-purchase-date" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                            Guardar Producto
                        </button>
                    </form>
                </div>
                
                <!-- Columna 2: Inventario -->
                <div class="lg:col-span-2 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Inventario de Productos</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Costo (c/u)</th>
                                    <!-- NUEVA COLUMNA -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Última Compra</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="products-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Productos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin del cambio -->

    </div>

    <!-- Modal para mensajes -->
    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 dark:bg-gray-800 dark:bg-opacity-75" hidden>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-brand-card dark:bg-gray-700 rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-lg font-semibold text-brand-text dark:text-brand-bg">Cargando...</h3>
                <div class="mt-2">
                    <p id="modal-message" class="text-sm text-brand-muted dark:text-gray-300">Por favor, espere.</p>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-brand-accent hover:bg-brand-accent-alt border border-transparent rounded-md" hidden>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar Cliente (NUEVO) -->
    <!-- ESTE MODAL COMPLETO HA SIDO ELIMINADO -->
    


    <!-- Firebase SDKs -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // MODIFICADO: Importar funciones de autenticación
        import { 
            getAuth, 
            // ELIMINADO: signInAnonymously
            signInWithEmailAndPassword,
            sendPasswordResetEmail, // <-- AÑADIDO
            // ELIMINADO: createUserWithEmailAndPassword
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANEJO DE MODO OSCURO (DE LA CONFIGURACIÓN PROPORCIONADA) ---
        function setupDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }

            toggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isNowDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isNowDark);
                // Vuelve a renderizar los íconos de Feather para asegurar que se muestren correctamente
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });
            
            // Reemplazar íconos de Feather al cargar
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
        document.addEventListener('DOMContentLoaded', setupDarkMode);


        // --- VARIABLES GLOBALES ---
        let db, auth, app;
        let userId;
        let isAuthReady = false;
        
        // Colecciones de Firestore
        let clientsCollection, salesCollection, productsCollection, shipmentsCollection;
        let saleItemsCollection; // <-- NUEVO

        // Estado temporal
        let currentSaleItems = [];
        let currentSaleTotal = 0;
        let productsCache = {}; // Cache para stock y costos
        let selectedClientId = null; // Para panel de envíos
        let selectedClientName = null;
        let selectedClientPhone = null;
        
        // Listeners de OnSnapshot (para poder desvincularlos al cambiar de cliente)
        let pendingSalesListener = null;
        let shipmentHistoryListener = null;
        
        // --- MODIFICADO: Cache para los buscadores ---
        let allClientsCache = []; // { id, name, phone, normalizedText }
        let allProductsCache = []; // { id, name, stock, costo }

        // --- NUEVO: IDs DE ELEMENTOS DEL DOM (MOVIMOS TODO AQUÍ) ---
        
        // Elementos de Autenticación
        const authContainer = document.getElementById('auth-container');
        const loginView = document.getElementById('login-view');
        const loginForm = document.getElementById('login-form');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const mainApp = document.getElementById('main-app');
        const logoutButton = document.getElementById('logoutButton');
        
        // Elementos de Pestañas y Modal
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Elementos Pestaña Clientes
        const clientsListSelectable = document.getElementById('clients-list-selectable');
        const clientListSearchInput = document.getElementById('client-list-search');
        const clientDetailPanel = document.getElementById('client-detail-panel');
        const pendingSalesList = document.getElementById('pending-sales-list');
        const shipmentHistoryList = document.getElementById('shipment-history-list');
        const createShipmentBtn = document.getElementById('create-shipment-btn');

        // Elementos Pestaña Ventas
        const saleForm = document.getElementById('add-sale-form');
        const salesList = document.getElementById('sales-list');
        const addSaleItemBtn = document.getElementById('add-sale-item-btn');
        const currentSaleItemsList = document.getElementById('current-sale-items');
        const currentSaleTotalEl = document.getElementById('current-sale-total');
        const newClientFields = document.getElementById('new-client-fields');

        // Elementos Pestaña Productos
        const productForm = document.getElementById('add-product-form');
        const productsList = document.getElementById('products-list');

        // Elementos de Buscadores (Autocompletado)
        const clientSearchInput = document.getElementById('client-search');
        const clientSearchHiddenId = document.getElementById('sale-client-id');
        const clientSearchResults = document.getElementById('client-search-results');
        
        const saleProductSearchInput = document.getElementById('sale-product-search');
        const saleProductHiddenId = document.getElementById('sale-product-id');
        const saleProductSearchResults = document.getElementById('sale-product-search-results');
        
        const productInventorySearchInput = document.getElementById('product-search-inventory');
        const productInventoryHiddenId = document.getElementById('product-inventory-id');
        const productInventorySearchResults = document.getElementById('product-search-inventory-results');
        
        // --- FIN DE IDs DE ELEMENTOS ---

        // Configuración de tu proyecto
        const appId = 'mi-app-ventas'; // O cualquier nombre que quieras
        const firebaseConfig = {
            apiKey: "AIzaSyBe_H0VfS-8K-n3Ihu-Io2q4SYDZAwbKoQ",
            authDomain: "compliventas-fc79c.firebaseapp.com",
            projectId: "compliventas-fc79c",
            storageBucket: "compliventas-fc79c.firebasestorage.app",
            messagingSenderId: "734491005717",
            appId: "1:734491005717:web:85f0be05bc345cfd6bcf1c"
        };

        // --- INICIALIZACIÓN ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // --- LÓGICA DE AUTENTICACIÓN (MUY MODIFICADA) ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- USUARIO HA INICIADO SESIÓN ---
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = user.email; // Mostrar email
                    
                    // Ocultar auth, mostrar app
                    authContainer.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    
                    // Vuelve a renderizar los íconos de Feather para el botón de logout
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                    
                    // --- CORRECCIÓN: INICIALIZAR FECHAS AQUÍ ---
                    // Ahora que 'main-app' está visible, podemos encontrar los elementos
                    try {
                        document.getElementById('sale-date').valueAsDate = new Date();
                        document.getElementById('shipment-date').valueAsDate = new Date();
                        document.getElementById('product-purchase-date').valueAsDate = new Date();
                    } catch(e) {
                        console.warn("Error al inicializar fechas (ignorar si es la primera carga):", e.message);
                    }
                    // --- FIN DE LA CORRECCIÓN ---

                    // Definir rutas de las colecciones (dependientes del userId)
                    clientsCollection = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                    salesCollection = collection(db, `artifacts/${appId}/users/${userId}/sales`);
                    productsCollection = collection(db, `artifacts/${appId}/users/${userId}/products`);
                    shipmentsCollection = collection(db, `artifacts/${appId}/users/${userId}/shipments`);
                    saleItemsCollection = collection(db, `artifacts/${appId}/users/${userId}/saleItems`);

                    isAuthReady = true;
                    // Cargar datos iniciales
                    loadClients();
                    loadSales();
                    loadProducts();


                } else {
                    // --- USUARIO NO HA INICIADO SESIÓN ---
                    userId = null;
                    isAuthReady = false;
                    
                    // Mostrar auth, ocultar app
                    authContainer.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    
                    // Limpiar datos (si es necesario, aunque los listeners se cortarán)
                    if(clientsListSelectable) clientsListSelectable.innerHTML = '';
                    if(salesList) salesList.innerHTML = '';
                    if(productsList) productsList.innerHTML = '';
                    
                    // Desvincular listeners si existen
                    if (pendingSalesListener) pendingSalesListener();
                    if (shipmentHistoryListener) shipmentHistoryListener();
                }
            });

        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            showModal("Error de Conexión", "No se pudo conectar a Firebase. Verifique la configuración.");
        }
        
        // --- NUEVOS LISTENERS DE AUTENTICACIÓN ---
        
        // Formulario de Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            showModal("Iniciando Sesión", "Por favor, espere...", false);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged se encargará de ocultar el modal y mostrar la app
                hideModal();
            } catch (error) {
                console.error("Error de login:", error.code);
                hideModal();
                showModal("Error de Login", "Correo o contraseña incorrectos. Por favor, inténtelo de nuevo.");
            }
        });

        // Botón de Cerrar Sesión
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged se encargará de mostrar el login
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showModal("Error", "No se pudo cerrar sesión.");
            }
        });
        
        // --- NUEVO: LISTENER PARA RESTABLECER CONTRASEÑA ---
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            if (!email) {
                showModal("Correo Requerido", "Por favor, ingrese su correo en el campo 'Correo' para poder restablecer la contraseña.");
                return;
            }
            
            showModal("Procesando", "Enviando correo de restablecimiento...", false);
            try {
                await sendPasswordResetEmail(auth, email);
                hideModal();
                showModal("Correo Enviado", "Si su correo está registrado, recibirá un enlace para crear una nueva contraseña. Revise su bandeja de entrada (y spam).");
            } catch (error) {
                console.error("Error al enviar correo de restablecimiento:", error);
                hideModal();
                if (error.code === 'auth/invalid-email') {
                    showModal("Error", "El formato del correo no es válido.");
                } else {
                    showModal("Error", "No se pudo enviar el correo de restablecimiento. Intente de nuevo más tarde.");
                }
            }
        });

        // --- FIN DE LÓGICA DE AUTENTICACIÓN ---


        // --- MANEJO DE PESTAÑAS ---
        // ELIMINADO: const tabs = document.querySelectorAll('.tab-btn');
        // ELIMINADO: const panels = document.querySelectorAll('.tab-panel');

        // Función para resetear clases de tabs
        function resetTabStyles() {
            tabs.forEach(t => {
                t.classList.remove('text-brand-accent', 'border-brand-accent', 'dark:text-brand-accent-alt', 'dark:border-brand-accent-alt');
                t.classList.add('text-brand-muted', 'border-transparent', 'hover:text-brand-accent', 'dark:hover:text-brand-accent-alt', 'hover:border-brand-accent');
                t.classList.remove('font-semibold');
                t.classList.add('font-medium');
            });
        }
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                resetTabStyles();
                panels.forEach(p => p.setAttribute('hidden', true));
                
                // Aplicar estilos de pestaña activa
                tab.classList.remove('text-brand-muted', 'border-transparent', 'hover:text-brand-accent', 'dark:hover:text-brand-accent-alt', 'hover:border-brand-accent');
                tab.classList.add('text-brand-accent', 'border-brand-accent', 'dark:text-brand-accent-alt', 'dark:border-brand-accent-alt', 'font-semibold');

                const panelId = tab.getAttribute('data-tab') + '-panel';
                document.getElementById(panelId).removeAttribute('hidden');
            });
        });
        
        // Inicializar la primera pestaña como activa
        // (Ahora se hace cuando el usuario inicia sesión)
        


        // --- MANEJO DE MODAL (Mensajes) ---
        // ELIMINADO: const modal = document.getElementById('modal');
        // ELIMINADO: const modalTitle = document.getElementById('modal-title');
        // ELIMINADO: const modalMessage = document.getElementById('modal-message');
        // ELIMINADO: const modalCloseBtn = document.getElementById('modal-close-btn');

        modalCloseBtn.addEventListener('click', () => modal.setAttribute('hidden', true));

        function showModal(title, message, showClose = true) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCloseBtn.style.display = showClose ? 'inline-flex' : 'none';
            modal.removeAttribute('hidden');
        }

        function hideModal() {
            modal.setAttribute('hidden', true);
        }

        // --- MANEJO DE MODAL (Agregar Cliente) ---
        // ESTA SECCIÓN HA SIDO ELIMINADA

        // --- Formateador de moneda (ej. S/ para Soles) ---
        const currencyFormatter = new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN',
            minimumFractionDigits: 2
        });

        // --- NUEVA FUNCIÓN DE NORMALIZACIÓN ---
        function normalizeString(str) {
            if (!str) return '';
            return str
                .toUpperCase() // Convertir a mayúsculas
                .normalize("NFD") // Descomponer tildes
                .replace(/[\u0300-\u036f]/g, ""); // Eliminar tildes
        }
        // --- FIN DE LA NUEVA FUNCIÓN ---

        // --- NUEVA FUNCIÓN PROPER CASE ---
        function toProperCase(str) {
            if (!str) return '';
            // Convierte todo a minúsculas, luego pone en mayúscula la primera letra de cada palabra
            return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }
        // --- FIN DE LA NUEVA FUNCIÓN ---

    // --- NUEVO: LÓGICA DE AUTOCOMPLETADO ---

    let activeAutocomplete = null; // Para manejar el clic fuera

    // Función genérica para mostrar resultados
    function showAutocompleteResults(container, results) {
        container.innerHTML = '';
        if (results.length === 0) {
            container.classList.add('hidden');
            return;
        }

        results.forEach(item => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.innerHTML = item.html; // Usar HTML pre-formateado
            div.onclick = () => item.onClick();
            container.appendChild(div);
        });
        container.classList.remove('hidden');
        activeAutocomplete = container;
    }

    // Función genérica para ocultar todos los autocompletados
    function hideAllAutocomplete() {
        if (clientSearchResults) clientSearchResults.classList.add('hidden');
        if (saleProductSearchResults) saleProductSearchResults.classList.add('hidden');
        if (productInventorySearchResults) productInventorySearchResults.classList.add('hidden');
        activeAutocomplete = null;
    }

    // Clic fuera para cerrar autocompletados
    document.addEventListener('click', (e) => {
        if (activeAutocomplete) {
            // Si el clic NO es dentro del contenedor de autocompletado activo
            // Y NO es en el input asociado
            if (!activeAutocomplete.contains(e.target) && 
                e.target !== clientSearchInput &&
                e.target !== saleProductSearchInput &&
                e.target !== productInventorySearchInput) {
                hideAllAutocomplete();
            }
        }
    });

    // --- LÓGICA DEL BUSCADOR DE CLIENTES (VENTAS) ---
    clientSearchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length === 0) {
            hideAllAutocomplete();
            clientSearchHiddenId.value = ''; // Limpiar ID si se borra
            newClientFields.setAttribute('hidden', true); // Ocultar
            return;
        }

        const results = allClientsCache.filter(client => 
            client.phone.includes(query) // <-- Solo busca en el teléfono
        );

        const resultItems = results.map(client => ({
            html: `<strong>${client.phone}</strong>`, // <-- Solo muestra el teléfono
            onClick: () => selectClient(client.id, client.phone) // <-- Solo pasa el teléfono
        }));

        showAutocompleteResults(clientSearchResults, resultItems);
    });

        function selectClient(id, phone = '') {
            clientSearchInput.value = phone; // Rellenar buscador con el teléfono
            clientSearchHiddenId.value = id; // Guardar ID
            hideAllAutocomplete();
        }

    // --- LÓGICA DEL BUSCADOR DE PRODUCTOS (VENTAS) ---
    saleProductSearchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length === 0) {
            hideAllAutocomplete();
            saleProductHiddenId.value = ''; // Limpiar
            return;
        }

        const results = allProductsCache.filter(prod => 
            prod.name.toLowerCase().includes(query)
        );

        const resultItems = results.map(prod => ({
            html: `<strong>${prod.name}</strong> (Stock: ${prod.stock > 0 ? prod.stock : 'SIN STOCK'})`,
            onClick: () => selectSaleProduct(prod.id, prod.name, prod.stock)
        }));

        showAutocompleteResults(saleProductSearchResults, resultItems);
    });

    function selectSaleProduct(id, name, stock) {
        if (stock <= 0) {
            showModal("Sin Stock", `El producto "${name}" no tiene stock disponible.`);
            saleProductSearchInput.value = '';
            saleProductHiddenId.value = '';
            hideAllAutocomplete();
            return;
        }
        saleProductSearchInput.value = name;
        saleProductHiddenId.value = id;
        hideAllAutocomplete();
    }

    // --- LÓGICA DEL BUSCADOR DE PRODUCTOS (INVENTARIO) ---
    productInventorySearchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        // Limpiar ID oculto cada vez que se teclea
        // Se seteará solo si se hace clic en una sugerencia
        productInventoryHiddenId.value = ''; 

        if (query.length === 0) {
            hideAllAutocomplete();
            return;
        }

        const results = allProductsCache.filter(prod => 
            prod.name.toLowerCase().includes(query)
        );

        const resultItems = results.map(prod => ({
            html: `<strong>${prod.name}</strong>`,
            onClick: () => selectInventoryProduct(prod.id, prod.name)
        }));

        showAutocompleteResults(productInventorySearchResults, resultItems);
    });

    function selectInventoryProduct(id, name) {
        productInventorySearchInput.value = name; // Rellenar
        productInventoryHiddenId.value = id; // Guardar ID
        hideAllAutocomplete();
    }

        function loadClients() {
            if (!isAuthReady) return; // Salir si la autenticación no está lista

            // Activar la primera pestaña por defecto al cargar datos
            document.querySelector('.tab-btn[data-tab="clients"]').click();

            onSnapshot(clientsCollection, (snapshot) => {
                // clientsListSelectable.innerHTML = ''; // <-- ELIMINADO (renderClientList lo hace)
                allClientsCache = []; // Limpiar cache

                if (snapshot.empty) {
                    // clientsListSelectable.innerHTML = ... // <-- ELIMINADO
                }

                snapshot.forEach(doc => {
                    const client = doc.data();
                    const clientId = doc.id;

                    // ELIMINADO: Todo el bloque que creaba el 'div'

                    // Añadir al cache (Panel Ventas)
                    allClientsCache.push({
                        id: clientId,
                        phone: client.phone,
                        normalizedText: client.phone.toLowerCase() // Modificado para consistencia
                    });
                });

                // --- MODIFICADO: Llamar a la nueva función de renderizado ---
                // Pasa el valor actual del buscador para que la lista se mantenga filtrada
                renderClientList(clientListSearchInput.value);

                // ELIMINADO: Bloque 'if (selectedClientId) { ... }' (movido a renderClientList)

            }, (error) => {
                console.error("Error al cargar clientes:", error);
            });
        }
        
        // --- NUEVA FUNCIÓN PARA RENDERIZAR LA LISTA DE CLIENTES ---
        function renderClientList(filter = '') {
            const lowerFilter = filter.toLowerCase();
            clientsListSelectable.innerHTML = ''; // Limpiar la lista

            // Filtrar el caché
            const filteredClients = allClientsCache.filter(client => 
                client.phone.includes(lowerFilter)
            );

            if (filteredClients.length === 0) {
                if (filter) {
                    clientsListSelectable.innerHTML = '<p class="text-brand-muted dark:text-gray-500 text-sm">No se encontraron clientes.</p>';
                } else {
                    clientsListSelectable.innerHTML = '<p class="text-brand-muted dark:text-gray-500 text-sm">No hay clientes. ¡Agrega uno!</p>';
                }
                return;
            }

            filteredClients.forEach(client => {
                const clientId = client.id;
                const div = document.createElement('div');
                div.className = 'client-item p-3 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700';
                div.setAttribute('data-id', clientId);
                div.setAttribute('data-phone', client.phone);
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-medium text-brand-text dark:text-brand-bg">${client.phone}</p>
                        <button data-id="${clientId}" data-phone="${client.phone}" class="btn-delete-client text-red-500 hover:text-red-700 text-sm font-bold p-1 leading-none rounded-full hover:bg-red-100 dark:hover:bg-gray-700">X</button>
                    </div>
                `;
                div.addEventListener('click', () => handleClientSelect(clientId, client.phone));
                clientsListSelectable.appendChild(div);
            });

            // Re-seleccionar si el cliente activo sigue en la lista
            if (selectedClientId) {
                const clientElement = document.querySelector(`.client-item[data-id="${selectedClientId}"]`);
                if (clientElement) {
                    clientElement.classList.add('selected');
                }
            }
        }
        // --- FIN DE LA NUEVA FUNCIÓN ---

        // Manejador al seleccionar un cliente de la lista
        function handleClientSelect(clientId, phone) { // <-- 'name' eliminado
            selectedClientId = clientId; // Guardar ID globalmente
            selectedClientName = phone; // <-- Usar 'phone' como nombre
            selectedClientPhone = phone; // Guardar globalmente
            
            // Resaltar cliente seleccionado
            document.querySelectorAll('.client-item').forEach(item => item.classList.remove('selected'));
            document.querySelector(`.client-item[data-id="${clientId}"]`).classList.add('selected');
            
            // Mostrar panel de detalle
            clientDetailPanel.removeAttribute('hidden');
            // clientDetailName.textContent = name; // Eliminado
            // clientDetailPhone.textContent = phone; // Eliminado
            
            // Configurar botón de resumen WhatsApp
            // clientDetailSummaryBtn.removeAttribute('hidden'); // Eliminado
            // clientDetailSummaryBtn.setAttribute('data-id', clientId); // Eliminado
            // clientDetailSummaryBtn.setAttribute('data-name', name); // Eliminado
            // clientDetailSummaryBtn.setAttribute('data-phone', phone); // Eliminado
            
            // Cargar datos de ventas y envíos
            loadPendingSales(clientId);
            loadShipmentHistory(clientId);

        }

// --- NUEVA FUNCIÓN: LÓGICA PARA ELIMINAR CLIENTE ---
    async function handleDeleteClient(clientId, clientPhone) {
        if (!isAuthReady) return;

        // Paso 1: Verificar si el cliente tiene ventas.
        showModal("Verificando...", `Revisando historial de ${clientPhone}...`, false);
        try {
            const q = query(saleItemsCollection, where("clientId", "==", clientId));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                // NO SE PUEDE ELIMINAR
                hideModal();
                showModal("No se puede eliminar", `El cliente ${clientPhone} tiene (${querySnapshot.size}) ventas asociadas. No se puede eliminar para mantener la integridad de los datos.`);
                return;
            }

            // Paso 2: Si no tiene ventas, pedir confirmación.
            hideModal();
            // Usamos el 'confirm' nativo que ya usas para eliminar ventas/productos
            if (confirm(`¿Estás seguro de que deseas eliminar al cliente ${clientPhone}? Esta acción no se puede deshacer.`)) {

                // Paso 3: Eliminar.
                await deleteDoc(doc(clientsCollection, clientId));

                // Si el cliente eliminado era el que estaba seleccionado, limpiar el panel
                if (selectedClientId === clientId) {
                    clientDetailPanel.setAttribute('hidden', true);
                    selectedClientId = null;
                    selectedClientName = null;
                    selectedClientPhone = null;
                }

                showModal("Éxito", `Cliente ${clientPhone} eliminado.`);
                // El listener onSnapshot de loadClients() actualizará la lista.
            }

        } catch (error) {
            console.error("Error al verificar/eliminar cliente:", error);
            hideModal();
            showModal("Error", "Ocurrió un error al intentar eliminar el cliente.");
        }
    }
    // --- FIN DE LA NUEVA FUNCIÓN ---


// --- NUEVO: LISTENER PARA ELIMINAR CLIENTES (EN LA LISTA) ---
    clientsListSelectable.addEventListener('click', async (e) => {
        // Buscar si el clic fue en un botón de eliminar
        if (e.target.classList.contains('btn-delete-client')) {
            const button = e.target;
            const clientId = button.getAttribute('data-id');
            const clientPhone = button.getAttribute('data-phone');

            // Detener la acción de 'handleClientSelect'
            // para que no se seleccione el cliente al borrarlo
            e.stopPropagation(); 

            await handleDeleteClient(clientId, clientPhone);
        }
    });


            // --- NUEVO: LISTENER PARA EL BUSCADOR DE LA LISTA DE CLIENTES ---
            clientListSearchInput.addEventListener('input', (e) => {
                renderClientList(e.target.value);
            });
        
        // Cargar ventas pendientes para el cliente seleccionado
        // const pendingSalesList = document.getElementById('pending-sales-list'); // MOVIDO ARRIBA
        function loadPendingSales(clientId) {
            if (pendingSalesListener) pendingSalesListener(); // Desvincular listener anterior
            
            // MODIFICADO: Consultar 'saleItemsCollection' en lugar de 'salesCollection'
            const q = query(saleItemsCollection, where("clientId", "==", clientId), where("enviado", "==", false));
            
            pendingSalesListener = onSnapshot(q, (snapshot) => {
                pendingSalesList.innerHTML = '';
                if (snapshot.empty) {
                    pendingSalesList.innerHTML = '<p class="text-sm text-brand-muted dark:text-gray-500">Este cliente no tiene items pendientes de envío.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const itemId = doc.id;
                    
                    // MODIFICADO: Mostrar item individual en lugar de venta agrupada
                    const div = document.createElement('div');
                    div.className = 'border-b pb-3 dark:border-gray-700';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <input id="item-${itemId}" data-item-id="${itemId}" type="checkbox" class="h-4 w-4 text-brand-accent border-gray-300 dark:border-gray-600 rounded focus:ring-brand-accent">
                            <label for="item-${itemId}" class="ml-3 block text-sm font-medium text-brand-text dark:text-brand-bg">
                                ${item.qty} x ${item.desc} ${item.color ? `(${item.color})` : ''} ${item.talla ? `[${item.talla}]` : ''}
                            </label>
                        </div>
                        <p class="ml-7 text-xs text-brand-muted dark:text-gray-400">
                            (De la venta del ${item.date} - Total Item: ${currencyFormatter.format(item.total)})
                        </p>
                    `;
                    pendingSalesList.appendChild(div);
                });
            }, (error) => console.error("Error al cargar items pendientes:", error));
        }

        // Cargar historial de envíos para el cliente seleccionado
        // const shipmentHistoryList = document.getElementById('shipment-history-list'); // MOVIDO ARRIBA
        function loadShipmentHistory(clientId) {
            if (shipmentHistoryListener) shipmentHistoryListener(); // Desvincular listener
            
            const q = query(shipmentsCollection, where("clientId", "==", clientId));
            
            shipmentHistoryListener = onSnapshot(q, (snapshot) => {
                shipmentHistoryList.innerHTML = '';
                if (snapshot.empty) {
                    shipmentHistoryList.innerHTML = '<p class="text-sm text-brand-muted dark:text-gray-500">No hay historial de envíos para este cliente.</p>';
                    return;
                }
                
                // Capturar los detalles del cliente desde las variables globales
                const clientNameForButton = selectedClientName;
                const clientPhoneForButton = selectedClientPhone;

                snapshot.forEach(doc => {
                    const shipment = doc.data();
                    // Preparar datos para el botón
                    const itemsJson = JSON.stringify(shipment.items); 
                    
                    // MODIFICADO: Mapear 'items' en lugar de 'sales'
                    let itemsHtml = shipment.items.map(item => `
                        <li class="text-xs text-brand-muted dark:text-gray-400 ml-4">${item.description} (ID: ...${item.itemId.slice(-6)})</li>
                    `).join('');
                    
                    const div = document.createElement('div');
                    div.className = 'border-b pb-2 dark:border-gray-700';
                    // MODIFICADO: Añadir botón de WhatsApp con data-attributes
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-brand-text dark:text-brand-bg">Envío del ${shipment.fechaEnvio}</p>
                            <button 
                              class="btn-whatsapp-shipment text-xs text-green-600 dark:text-green-400 hover:text-green-800 font-medium"
                              data-shipment-date="${shipment.fechaEnvio}"
                              data-client-name="${clientNameForButton}"
                              data-client-phone="${clientPhoneForButton}"
                              data-items="${encodeURIComponent(itemsJson)}"
                            >
                              Resumen Wpp
                            </button>
                        </div>
                        <ul class="mt-1 list-disc list-inside">${itemsHtml}</ul>
                    `;
                    shipmentHistoryList.appendChild(div);
                });

            }, (error) => console.error("Error al cargar historial de envíos:", error));
        }

        // --- AÑADE ESTE NUEVO BLOQUE ---
        shipmentHistoryList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-whatsapp-shipment')) {
                const button = e.target;
                try {
                    const clientName = button.getAttribute('data-client-name');
                    const clientPhone = button.getAttribute('data-client-phone');
                    const shipmentDate = button.getAttribute('data-shipment-date');
                    const items = JSON.parse(decodeURIComponent(button.getAttribute('data-items')));
                    
                    generateShipmentWhatsAppSummary(clientName, clientPhone, shipmentDate, items);
                } catch (error) {
                    console.error("Error al parsear datos del envío:", error);
                    showModal("Error", "No se pudieron cargar los datos para el resumen.");
                }
            }
        });
        // --- FIN DEL NUEVO BLOQUE ---

        // Botón de Crear Envío
        // const createShipmentBtn = document.getElementById('create-shipment-btn'); // MOVIDO ARRIBA
        createShipmentBtn.addEventListener('click', async () => {
            if (!selectedClientId) return;
            
            const fechaEnvio = document.getElementById('shipment-date').value;
            if (!fechaEnvio) {
                showModal("Falta la fecha", "Por favor, seleccione una fecha de envío.");
                return;
            }
            
            // MODIFICADO: Seleccionar items individuales
            const selectedItemsCheckboxes = pendingSalesList.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedItemsCheckboxes.length === 0) {
                showModal("Sin items", "Seleccione al menos un item para incluir en el envío.");
                return;
            }
            
            showModal("Procesando Envío", "Creando envío y actualizando items...", false);
            
            try {
                // MODIFICADO: Listas para items y ventas padres
                const itemsToShip = []; // Para guardar en el doc de envío
                const itemRefsToUpdate = []; // Para actualizar los items
                const parentSaleIds = new Set(); // Para verificar si la venta padre se completó

                // Recolectar info de los items seleccionados
                for (const checkbox of selectedItemsCheckboxes) {
                    const itemId = checkbox.getAttribute('data-item-id');
                    const itemRef = doc(saleItemsCollection, itemId);
                    const itemDoc = await getDoc(itemRef);
                    if (itemDoc.exists()) {
                        const itemData = itemDoc.data();
                        itemsToShip.push({
                            itemId: itemId,
                            description: `${itemData.qty} x ${itemData.desc} ${itemData.color || ''} ${itemData.talla || ''}`,
                            total: itemData.total,
                            qty: itemData.qty
                        });
                        itemRefsToUpdate.push(itemRef);
                        parentSaleIds.add(itemData.saleId); // Guardar el ID de la venta padre
                    }
                }
                
                // 1. Crear el documento de Envío (con 'items' en lugar de 'sales')
                await addDoc(shipmentsCollection, {
                    clientId: selectedClientId,
                    clienteName: selectedClientName, // Usar variable global
                    fechaEnvio: fechaEnvio,
                    items: itemsToShip, // Array de objetos de items
                    createdAt: new Date().toISOString()
                });
                
                // 2. Actualizar todos los items a "enviado: true"
                for (const itemRef of itemRefsToUpdate) {
                    await updateDoc(itemRef, { enviado: true });
                }

                // 3. (NUEVO) Verificar y actualizar las ventas padre
                for (const saleId of parentSaleIds) {
                    const q = query(saleItemsCollection, where("saleId", "==", saleId), where("enviado", "==", false));
                    const remainingItemsSnap = await getDocs(q);
                    
                    // Si no quedan items pendientes, marcar la VENTA padre como enviada
                    if (remainingItemsSnap.empty) {
                        await updateDoc(doc(salesCollection, saleId), { enviado: true });
                    }
                }
                
                document.getElementById('shipment-date').value = '';
                hideModal();
                showModal("Éxito", "El envío se ha registrado y los items se han actualizado.");
                
            } catch (error) {
                console.error("Error al crear envío:", error);
                hideModal();
                showModal("Error", "No se pudo crear el envío. " + error.message);
            }
        });
        
        // Botón Resumen WhatsApp (ELIMINADO)
        // clientDetailSummaryBtn.addEventListener('click', (e) => { ... });




        // NUEVO: Referencia a los campos de nuevo cliente
        // const newClientFields = document.getElementById('new-client-fields'); // MOVIDO ARRIBA
        // ELIMINADO: Referencia a los campos de nuevo producto
        // const newProductFields = document.getElementById('new-product-fields');

        // NUEVO: Referencia a los campos del formulario de productos
        // const productSelectInventory = document.getElementById('product-select-inventory'); // <-- ELIMINADO
        // const newProductNameField = document.getElementById('new-product-name-field'); // <-- ELIMINADO



        // ELIMINADO: Listener para mostrar/ocultar los campos de nuevo producto
        /*
        saleProductSelect.addEventListener('change', () => {
            if (saleProductSelect.value === '--NEW-PRODUCT--') {
                newProductFields.removeAttribute('hidden');
            } else {
                newProductFields.setAttribute('hidden', true);
            }
        });
        */

        // const saleForm = document.getElementById('add-sale-form'); // MOVIDO ARRIBA
        // const salesList = document.getElementById('sales-list'); // MOVIDO ARRIBA
        // const addSaleItemBtn = document.getElementById('add-sale-item-btn'); // MOVIDO ARRIBA
        // const currentSaleItemsList = document.getElementById('current-sale-items'); // MOVIDO ARRIBA
        // const currentSaleTotalEl = document.getElementById('current-sale-total'); // MOVIDO ARRIBA

        function updateSaleTotal() {
            currentSaleTotal = currentSaleItems.reduce((acc, item) => acc + item.total, 0);
            currentSaleTotalEl.textContent = currentSaleTotal.toFixed(2);
        }

        function renderCurrentSaleItems() {
            currentSaleItemsList.innerHTML = '';
            currentSaleItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center text-xs";
                li.innerHTML = `
                    <span>${item.qty} x ${item.desc} ${item.color || ''} ${item.talla || ''} (S/ ${item.price.toFixed(2)} c/u)</span>
                    <button type="button" data-index="${index}" class="btn-remove-item text-red-500 font-bold px-1 hover:text-red-700">X</button>
                `;
                currentSaleItemsList.appendChild(li);
            });
            updateSaleTotal();
        }

        currentSaleItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove-item')) {
                const index = parseInt(e.target.getAttribute('data-index'), 10);
                currentSaleItems.splice(index, 1);
                renderCurrentSaleItems();
            }
        });

        addSaleItemBtn.addEventListener('click', async () => {
            const qty = parseInt(document.getElementById('sale-item-qty').value, 10);
            // MODIFICADO: Leemos el precio TOTAL del input
            const totalPrice = parseFloat(document.getElementById('sale-item-price').value);

            // Validamos que se pueda dividir
            if (!qty || qty <= 0) {
                 showModal("Datos incompletos", "La cantidad debe ser mayor a 0.");
                 return;
            }
            if (totalPrice === null || totalPrice < 0) { // Permitir 0
                 showModal("Datos incompletos", "Debe ingresar un precio total válido.");
                 return;
            }

            // Calculamos el precio unitario para guardarlo
            const unitPrice = (totalPrice === 0) ? 0 : (totalPrice / qty); // Permitir precio 0
            const color = document.getElementById('sale-item-color').value;
            const talla = document.getElementById('sale-item-talla').value;
            // const productId = saleProductHiddenId.value; // YA NO SE USA
            // const productName = saleProductSearchInput.value; // YA NO SE USA

            let productCost, productStock;
            let productId, productName; // <-- MOVIDAS AQUÍ

            // --- Lógica para manejar producto nuevo vs. existente ---
            // ELIMINADO: Bloque "if (selectedOption.value === '--NEW-PRODUCT--')"
            
            // MODIFICADO: Leer desde los inputs ocultos
            productId = saleProductHiddenId.value;
            productName = saleProductSearchInput.value;

            if (productId && productName) {
                // --- PRODUCTO EXISTENTE ---
                const product = productsCache[productId];
                productCost = product.cost;
                productStock = product.stock;

            } else {
                // No se seleccionó nada
                showModal("Datos incompletos", "Seleccione un producto, cantidad y un precio de venta válido.");
                return;
            }
            
            // ELIMINADO: Validación duplicada
            // if (qty <= 0 || !price || price <= 0) { ... }
            
            const existingItem = currentSaleItems.find(item => item.productId === productId && item.color === color && item.talla === talla);
            if(existingItem) {
                showModal("Item duplicado", "Ese producto (con mismo color y talla) ya está en la lista. Bórrelo para agregar una nueva cantidad.");
                return;
            }

            currentSaleItems.push({
                productId,
                desc: productName,
                qty,
                price: unitPrice, // Precio de venta (calculado)
                costo: productCost, // Costo (del producto)
                total: totalPrice, // Total (del input)
                totalCosto: qty * productCost,
                color: color || '',
                talla: talla || ''
            });
            renderCurrentSaleItems();

            // Limpiar inputs
            saleProductSearchInput.value = '';
            saleProductHiddenId.value = '';
            document.getElementById('sale-item-qty').value = '1';
            document.getElementById('sale-item-price').value = '';
            document.getElementById('sale-item-color').value = '';
            document.getElementById('sale-item-talla').value = '';

        });

        saleForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return;

        // --- CORRECCIÓN: Leer fecha y medio de pago aquí ---
        const date = document.getElementById('sale-date').value;
        const medioDePago = document.getElementById('sale-payment-method').value;
        // --- FIN DE LA CORRECCIÓN ---

        // --- NUEVA LÓGICA: BUSCAR O CREAR CLIENTE ---
        let finalClientId, clientName, clientPhone;

        const phoneQuery = clientSearchInput.value.trim();
        const selectedClientId = clientSearchHiddenId.value;

        if (!phoneQuery) {
            showModal("Venta incompleta", "Debe ingresar un teléfono de cliente.");
            return;
        }

        // Primero, verificar si el usuario seleccionó un cliente Y no cambió el texto
        const clientData = allClientsCache.find(c => c.id === selectedClientId);
        if (clientData && clientData.phone === phoneQuery) {
            // SCENARIO 1: Cliente seleccionado de la lista
            finalClientId = clientData.id;
            clientName = clientData.phone;
            clientPhone = clientData.phone;
        } else {
            // SCENARIO 2: Texto tipeado (nuevo o existente no seleccionado)
            // Buscar en Firestore por el teléfono tipeado
            showModal("Validando Cliente", "Buscando o registrando cliente...", false);
            try {
                const q = query(clientsCollection, where("phone", "==", phoneQuery));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // El cliente YA EXISTE
                    const existingClientDoc = querySnapshot.docs[0];
                    finalClientId = existingClientDoc.id;
                    clientName = phoneQuery;
                    clientPhone = phoneQuery;
                } else {
                    // El cliente ES NUEVO, hay que crearlo
                    const newClientRef = await addDoc(clientsCollection, {
                        phone: phoneQuery
                    });
                    finalClientId = newClientRef.id;
                    clientName = phoneQuery;
                    clientPhone = phoneQuery;
                }
                // hideModal(); // Se oculta al final del try/catch del submit
            } catch (error) {
                console.error("Error al buscar/crear cliente:", error);
                hideModal();
                showModal("Error", "No se pudo verificar el cliente.");
                return;
            }
        }
        // --- FIN NUEVA LÓGICA ---

            // --- VALIDACIÓN DE ITEMS Y FECHA ---
            // MODIFICADO: Se incluye !medioDePago
            if (currentSaleItems.length === 0 || !date || !medioDePago) {
                showModal("Venta incompleta", "Agregue al menos un item, elija una fecha y un medio de pago.");
                return;
            }
            
            const totalCostoVenta = currentSaleItems.reduce((acc, item) => acc + item.totalCosto, 0);

            showModal("Procesando Venta", "Guardando y actualizando stock...", false);

            try {
                // 1. Guardar la venta (AHORA CON EL ID CORRECTO)
                const newSaleRef = await addDoc(salesCollection, { // <-- Capturar la referencia
                    clientId: finalClientId, // Usar el ID final (nuevo o existente)
                    clientName,
                    clientPhone,
                    date,
                    medioDePago: medioDePago, // <-- AÑADIDO
                    items: currentSaleItems,
                    total: currentSaleTotal,
                    totalCosto: totalCostoVenta, // Guardamos el costo total
                    enviado: false // NUEVO
                });

                // --- NUEVO: 2. Generar registro único por producto ---
                for (const item of currentSaleItems) {
                    await addDoc(saleItemsCollection, {
                        saleId: newSaleRef.id, // Vínculo a la venta principal
                        clientId: finalClientId,
                        clientName: clientName,
                        date: date,
                        medioDePago: medioDePago, // <-- AÑADIDO
                        enviado: false, // Estado inicial
                        
                        // Datos del item
                        productId: item.productId,
                        desc: item.desc,
                        qty: item.qty,
                        price: item.price,
                        costo: item.costo,
                        total: item.total,
                        totalCosto: item.totalCosto,
                        color: item.color,
                        talla: item.talla
                    });
                }
                // --- FIN NUEVO ---

                // 3. Actualizar el stock (Antes era el 2)
                for (const item of currentSaleItems) {
                    const productRef = doc(productsCollection, item.productId);
                    const product = productsCache[item.productId];
                    if (product) {
                        const newStock = product.stock - item.qty;
                        await updateDoc(productRef, { stock: newStock });
                    }
                }

                // Resetear formulario
                saleForm.reset();
                currentSaleItems = [];
                renderCurrentSaleItems();
                document.getElementById('sale-date').valueAsDate = new Date();
                // --- AÑADIR ESTAS LÍNEAS ---
                clientSearchInput.value = '';
                clientSearchHiddenId.value = '';
                // --- FIN ---
                
                hideModal();
                showModal("Venta Exitosa", "La venta se guardó y el stock se actualizó.");
                
            } catch (error) {
                console.error("Error al guardar venta:", error);
                hideModal();
                showModal("Error", "No se pudo guardar la venta o actualizar el stock.");
            }
        });

        // --- LÓGICA DE VENTAS MODIFICADA ---
        function loadSales() {
            if (!isAuthReady) return;

            // MODIFICADO: Escuchar 'saleItemsCollection' en lugar de 'salesCollection'
            onSnapshot(saleItemsCollection, (snapshot) => {
                salesList.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = doc.data(); // Ahora 'item' es un item de venta individual
                    const tr = document.createElement('tr');
                    
                    // Definir estado
                    let estadoHtml = item.enviado 
                        ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-700 text-green-800 dark:text-green-200">Enviado</span>'
                        : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-200">Pendiente</span>';
                    
                    // Construir descripción del producto (con color y talla si existen)
                    let productDesc = item.desc;
                    if (item.color) productDesc += ` (${item.color})`;
                    if (item.talla) productDesc += ` [${item.talla}]`;

                    // MODIFICADO: Generar fila de tabla con datos del item
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${item.clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${productDesc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.qty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${currencyFormatter.format(item.total)}</td>
                        <!-- NUEVA CELDA -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.medioDePago || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${estadoHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <!-- MODIFICADO: El botón ahora usa 'data-sale-id' y elimina la VENTA COMPLETA -->
                            <button data-sale-id="${item.saleId}" class="btn-delete-sale text-red-600 hover:text-red-900">Eliminar Venta</button>
                        </td>
                    `;
                    salesList.appendChild(tr);
                });
            }, (error) => console.error("Error al cargar items de ventas:", error));
        }
        
        salesList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-delete-sale')) {
                // MODIFICADO: Obtener 'data-sale-id' en lugar de 'data-id'
                const saleId = e.target.getAttribute('data-sale-id');
                
                // TODO: Agregar lógica para restaurar stock si se borra una venta
                if (confirm("¿Estás seguro de que deseas eliminar la VENTA COMPLETA asociada a este item? (El stock NO se restaurará automáticamente). Esta acción eliminará todos los items de esa venta.")) {
                    try {
                        // 1. Eliminar la venta principal
                        await deleteDoc(doc(salesCollection, saleId)); // Usar saleId
                        
                        // --- 2. Eliminar los items de venta asociados (lógica existente es correcta) ---
                        const qItems = query(saleItemsCollection, where("saleId", "==", saleId)); // Usar saleId
                        const itemsSnapshot = await getDocs(qItems);
                        for (const itemDoc of itemsSnapshot.docs) {
                            await deleteDoc(itemDoc.ref);
                        }
                        // --- FIN ---
                        
                    } catch (error) {
                        showModal("Error", "No se pudo eliminar la venta.");
                    }
                }
            }
        });
        // --- FIN DE MODIFICACIÓN DE LÓGICA DE VENTAS ---




        // NUEVO: Función extraída para crear o actualizar productos (reutilizable)
        // MODIFICADO: Añadir purchaseDate
        async function createOrUpdateProduct(name, stockToAdd, newUnitCost, purchaseDate) {
            // MODIFICADO: Permitir newUnitCost 0
            if (stockToAdd <= 0 || newUnitCost < 0 || !name || !purchaseDate) {
                throw new Error("Datos de producto inválidos. Se requiere nombre, stock positivo, costo >= 0 y fecha.");
            }
            
            // 1. Buscar si el producto ya existe (por nombre exacto)
            const q = query(productsCollection, where("name", "==", name));
            const querySnapshot = await getDocs(q);

            let productId;

            if (querySnapshot.empty) {
                // --- PRODUCTO NUEVO ---
                // MODIFICADO: Añadir purchaseDate
                const newDocRef = await addDoc(productsCollection, { 
                    name: name, 
                    stock: stockToAdd, 
                    cost: newUnitCost, // Guardar costo unitario
                    purchaseDate: purchaseDate // <-- AÑADIDO
                });
                productId = newDocRef.id;

            } else {
                // --- PRODUCTO EXISTENTE ---
                const productDoc = querySnapshot.docs[0];
                const productRef = productDoc.ref;
                productId = productDoc.id;
                const productData = productDoc.data();

                const oldStock = productData.stock || 0;
                const oldCost = productData.cost || 0;

                // Calcular nuevo stock total
                const newTotalStock = oldStock + stockToAdd;

                // Calcular nuevo costo promedio ponderado
                let newAverageCost = newUnitCost; // Por defecto, el nuevo costo unitario
                if (newTotalStock > 0) { // Evitar división por cero
                    const oldTotalValue = oldStock * oldCost;
                    const newTotalValue = stockToAdd * newUnitCost; // Usar costo unitario
                    newAverageCost = (oldTotalValue + newTotalValue) / newTotalStock;
                }

                // Actualizar el documento
                // MODIFICADO: Añadir purchaseDate
                await updateDoc(productRef, {
                    stock: newTotalStock,
                    cost: newAverageCost,
                    purchaseDate: purchaseDate // <-- AÑADIDO
                });
            }
            return productId; // Devuelve el ID del producto creado o actualizado
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            
            // --- Lógica de Submit Modificada ---
            const name = normalizeString(productInventorySearchInput.value.trim());
            const stockToAdd = parseInt(document.getElementById('product-stock').value, 10);
            const totalCost = parseFloat(document.getElementById('product-cost').value);
            const purchaseDate = document.getElementById('product-purchase-date').value;

            // ... (el resto de la lectura de formulario: totalCost, purchaseDate, newUnitCost) ...
            
            // NUEVA VALIDACIÓN
            if (!purchaseDate) {
                showModal("Datos incompletos", "Debe seleccionar una fecha de compra.");
                return;
            }

            if (!name) {
                showModal("Datos incomchos", "Debe ingresar un nombre de producto.");
                return;
            }
            if (!stockToAdd || stockToAdd <= 0) {
                 showModal("Datos incompletos", "La cantidad a agregar debe ser mayor a 0.");
                 return;
            }
            if (totalCost === null || totalCost < 0) { // Permitir 0
                 showModal("Datos incompletos", "Debe ingresar un costo total válido.");
                 return;
            }

            const newUnitCost = (totalCost === 0) ? 0 : (totalCost / stockToAdd); // Permitir precio 0


            showModal("Actualizando Inventario", "Guardando producto...", false);

            try {
                // MODIFICADO: Pasar purchaseDate y el nuevo costo unitario
                await createOrUpdateProduct(name, stockToAdd, newUnitCost, purchaseDate);
                
                hideModal();
                showModal("Éxito", `Inventario de "${name}" actualizado.`);
                productForm.reset();
                // RE-INICIALIZAR FECHA A HOY
                document.getElementById('product-purchase-date').valueAsDate = new Date();
                productInventorySearchInput.value = '';
                productInventoryHiddenId.value = '';            

            } catch (error) {
                console.error("Error al guardar/actualizar producto:", error);
                hideModal();
                showModal("Error", "No se pudo actualizar el inventario. " + error.message);
            }
        });

        function loadProducts() {
            if (!isAuthReady) return;

            onSnapshot(productsCollection, (snapshot) => {
                productsList.innerHTML = '';
                // Limpiar caches
                allProductsCache = [];
                productsCache = {};

                snapshot.forEach(doc => {
                    const product = doc.data();
                    const productId = doc.id;
                    
                    productsCache[productId] = { ...product, id: productId }; // Llenar cache

                    // Llenar la tabla de productos
                    const tr = document.createElement('tr');
                    // MODIFICADO: Añadir <td> para purchaseDate
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${currencyFormatter.format(product.cost)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${product.purchaseDate || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${productId}" class="btn-delete-product text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    `;
                    productsList.appendChild(tr);

                    // Llenar el cache unificado de Productos
                    allProductsCache.push({
                        id: productId,
                        name: product.name,
                        stock: product.stock,
                        cost: product.cost
                    });
                });

                // Ya no se renderiza aquí, el 'input' lo hará

            }, (error) => {
                console.error("Error al cargar productos:", error);
                if (error.code === 'permission-denied' || error.code === 'failed-precondition') {
                    showModal("Error de Permisos", "No se pudieron cargar los productos. Asegúrese de que las reglas de seguridad de su proyecto Firestore estén configuradas correctamente para permitir lecturas en la ruta 'users/" + userId + "/products'.");
                }
            });
        }
        
        productsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-delete-product')) {
                const id = e.target.getAttribute('data-id');
                if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                    try {
                        await deleteDoc(doc(productsCollection, id));
                    } catch (error) {
                        showModal("Error", "No se pudo eliminar el producto.");
                    }
                }
            }
        });

        // --- LÓGICA DEL RESUMEN DE WHATSAPP (ELIMINADA) ---
        // async function generateWhatsAppSummary(clientId, clientName, clientPhone) { ... }
        
        // --- FUNCIÓN DE WHATSAPP POR ENVÍO (MODIFICADA) ---
        function generateShipmentWhatsAppSummary(clientName, clientPhone, shipmentDate, items) {
            if (!clientName || !clientPhone || !items) {
                showModal("Error", "Faltan datos del cliente o del envío.");
                return;
            }

            // --- INICIO DE MODIFICACIÓN: NUEVA PLANTILLA ---
            let message = `*Compras incluidas en tu envío 📦*\n\n`;
            
            let totalPrendas = 0;
            
            items.forEach(item => {
                // 'item.description' ya viene formateado ("2 x Enterizo...")
                message += `🌻 ${item.description}\n\n`; 
                
                // Sumar el total de prendas
                let cantidadItem = 0;
                if (item.qty && item.qty > 0) {
                    // Usamos la 'qty' que guardamos en el Paso 1
                    cantidadItem = item.qty;
                } else {
                    // Fallback para envíos antiguos (antes de este cambio)
                    // Intenta "adivinar" la cantidad desde la descripción (ej. "2 x Polo")
                    try {
                        const match = item.description.match(/^(\d+)\s*x/);
                        if (match && match[1]) {
                            cantidadItem = parseInt(match[1], 10);
                        }
                    } catch(e) { /* ignorar error si no puede 'adivinar' */ }
                }
                totalPrendas += cantidadItem;
            });

            message += `*✅ Total de prendas: ${totalPrendas}*\n\n`;
            message += `_Atte. CompliCompras 🛍️_`;
            // --- FIN DE MODIFICACIÓN ---

            const encodedMessage = encodeURIComponent(message);
            
            // Validar teléfono (simple)
            if (clientPhone.length < 8) {
                showModal("Error", `El número de teléfono "${clientPhone}" no parece válido.`);
                return;
            }
            const whatsappUrl = `https://wa.me/${clientPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        // --- FIN DE LA NUEVA FUNCIÓN ---
        
    </script>
</body>
</html>

