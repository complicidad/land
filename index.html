<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latam5S — Organiza tus envíos con calma</title>
    <meta name="description" content="Organiza tus envíos sin direcciones confusas ni mensajes perdidos. Latam5S es la herramienta para emprendedores que buscan calma y eficiencia.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons for Dark Mode Toggle -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Estilos base y para la fuente personalizada */
        body {
            font-family: "Quicksand", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        }
        [hidden] { display: none; }
        select:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        
        /* Ocultar flechas en inputs de tipo número */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* --- NUEVO: Estilos para el Autocompletado --- */
        .autocomplete-results {
            position: absolute;
            width: 100%; /* El 100% de su contenedor padre */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            background-color: #ffffff;
            border-radius: 0 0 0.375rem 0.375rem; /* rounded-b-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .autocomplete-results {
            background-color: #1f2937; /* gray-800 */
            border-color: #4b5563; /* gray-600 */
        }
        .autocomplete-item {
            padding: 0.75rem 1rem; /* p-3 px-4 */
            cursor: pointer;
        }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background-color: #f3f4f6; /* gray-100 */
        }
        .dark .autocomplete-item:hover, .dark .autocomplete-item.selected {
            background-color: #374151; /* gray-700 */
        }
        .autocomplete-item strong {
            color: #D96B4F; /* brand-accent */
        }
        .autocomplete-item .new-item {
            font-weight: 600;
            color: #D96B4F; /* brand-accent */
        }
        .dark .autocomplete-item .new-item {
            color: #FF8B6A; /* brand-accent-alt */
        }
        /* --- FIN NUEVO: Estilos Autocompletado --- */

    </style>

    <script>
        // Configuración personalizada para Tailwind CSS
        tailwind.config = {
            darkMode: 'class', // Habilitar modo oscuro basado en clase
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#fffaf6',
                        'brand-card': '#ffffff',
                        'brand-text': '#2b2b2b',
                        'brand-muted': '#6b6b6b',
                        'brand-accent': '#D96B4F', // Color principal para botones y acentos
                        'brand-accent-alt': '#FF8B6A', // Color de hover y acentos secundarios
                    },
                    fontFamily: {
                        'quicksand': ['Quicksand', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-bg font-quicksand antialiased text-brand-text dark:bg-gray-900 dark:text-brand-bg">

    <!-- NUEVO: Contenedor de Autenticación -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md">
            <!-- Vista de Login -->
            <div id="login-view">
                <form id="login-form" class="bg-brand-card dark:bg-gray-800 shadow-xl rounded-lg p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-brand-text dark:text-brand-bg">Iniciar Sesión</h2>
                    <p class="text-center text-sm text-brand-muted dark:text-gray-400">¡Hola Complicidad Boutique!</p>
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Correo</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Contraseña</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                    </div>
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                        Ingresar
                    </button>
                    <p class="text-sm text-center">
                        <a href="#" id="forgot-password-link" class="font-medium text-brand-accent hover:text-brand-accent-alt">¿Olvidaste tu contraseña?</a>
                    </p>
                </form>
            </div>
        </div>
    </div>


    <!-- Contenedor principal de la APP (Ahora oculto por defecto) -->
    <div id="main-app" class="p-4 sm:p-6 lg:p-8 hidden">

        <!-- Encabezado -->
        <header class="mb-6 flex justify-between items-center">
            
            <div> <!-- AÑADE ESTA LÍNEA -->
                <h1 class="text-3xl font-bold text-brand-text dark:text-brand-bg">Complicidad Boutique</h1>
                <!-- MODIFICADO: Muestra el email del usuario -->
                <p class="text-sm text-brand-muted dark:text-gray-400">Usuario: <span id="userIdDisplay" class="font-medium text-brand-text dark:text-brand-bg">Cargando...</span></p>
            </div> <!-- AÑADE ESTA LÍNEA -->

            <div class="flex space-x-4">
                <!-- Botón de Modo Oscuro -->
                <button id="darkModeToggle" class="mt-2 text-sm text-brand-muted dark:text-gray-400 hover:text-brand-accent dark:hover:text-brand-accent-alt transition duration-150">
                    <i data-feather="moon" class="w-5 h-5 inline-block align-middle dark:hidden"></i>
                    <i data-feather="sun" class="w-5 h-5 inline-block align-middle hidden dark:inline-block"></i>
                    Cambiar Tema
                </button>

                <!-- NUEVO: Botón de Cerrar Sesión -->
                <button id="logoutButton" class="mt-2 text-sm text-brand-muted dark:text-gray-400 hover:text-brand-accent dark:hover:text-brand-accent-alt transition duration-150">
                    <i data-feather="log-out" class="w-5 h-5 inline-block align-middle"></i>
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs" id="tabs">
                    <!-- Productos -->
                    <button data-tab="products" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-brand-muted border-transparent hover:text-brand-accent dark:hover:text-brand-accent-alt hover:border-brand-accent">
                        Productos
                    </button>
                    <!-- Ventas -->
                    <button data-tab="sales" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm text-brand-accent border-brand-accent dark:text-brand-accent-alt dark:border-brand-accent-alt">
                        Ventas
                    </button>
                    <!-- MODIFICADO: Pestaña Envíos -->
                    <button data-tab="shipping" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-brand-muted border-transparent hover:text-brand-accent dark:hover:text-brand-accent-alt hover:border-brand-accent">
                        Envíos (Logística)
                    </button>
                </nav>
            </div>
        </div>

        <!-- Paneles de Contenido -->

        <!-- Panel de Clientes y Envíos (ELIMINADO POR COMPLETO) -->

        <!-- Panel de Ventas -->
        <div id="sales-panel" class="tab-panel">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Columna 1: Formulario de Venta -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Registrar Nueva Venta</h2>
                    <form id="add-sale-form" class="space-y-4">
                        <div>
                            <!-- MODIFICADO: Buscador de Clientes con Autocompletado -->
                            <div class="relative">
                                <label for="client-search" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Buscar o Registrar Cliente</label>                                <input type="text" id="client-search" placeholder="Escribir teléfono..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                <input type="hidden" id="sale-client-id">
                                <!-- Contenedor de autocompletado -->
                                <div id="client-search-results" class="autocomplete-results hidden"></div>
                                <p class="text-xs text-brand-muted dark:text-gray-400 mt-1">Escriba un teléfono. Si no existe, se registrará al guardar.</p>
                            </div>
                        </div>    
                        
                        <!-- Sección de items modificada -->
                        <div class="border border-gray-200 dark:border-gray-600 rounded-md p-4 space-y-3">
                            <h3 class="text-md font-semibold text-brand-text dark:text-brand-bg">Items de la Venta</h3>
                            <div class="space-y-2">
                                <!-- MODIFICADO: Buscador de Productos (Venta) con Autocompletado -->
                                <div class="relative">
                                    <label for="sale-product-search" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Buscar Producto</label>
                                    <input type="text" id="sale-product-search" placeholder="Escribir nombre del producto..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                    <input type="hidden" id="sale-product-id">
                                    <!-- Contenedor de autocompletado -->
                                    <div id="sale-product-search-results" class="autocomplete-results hidden"></div>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="sale-item-qty" placeholder="Cantidad" min="1" value="1" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <!-- MODIFICADO: Placeholder -->
                                    <input type="number" id="sale-item-price" placeholder="Precio Total (por este lote)" min="0" step="0.01" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="sale-item-color" placeholder="Color (Opcional)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                    <input type="text" id="sale-item-talla" placeholder="Talla (Opcional)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm sm:text-sm">
                                </div>
                                <button type="button" id="add-sale-item-btn" class="w-full text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt py-2 focus:ring-brand-accent">
                                    Agregar Item a la Venta
                                </button>
                            </div>
                            <ul id="current-sale-items" class="text-sm space-y-1 text-brand-text dark:text-brand-bg">
                                <!-- Items agregados temporalmente -->
                            </ul>
                            <div class="text-right font-bold text-lg text-brand-accent dark:text-brand-accent-alt">
                                Total Venta: S/ <span id="current-sale-total">0.00</span>
                            </div>
                        </div>
                        <!-- Fin del cambio -->

                        <!-- MODIFICADO: Agrupado en cuadrícula -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="sale-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Venta</label>
                                <input type="date" id="sale-date" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                            </div>
                            <!-- NUEVO CAMPO: Medio de Pago -->
                            <div>
                                <label for="sale-payment-method" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Medio de Pago</label>
                                <select id="sale-payment-method" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                                    <option value="">Seleccione...</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Yape">Yape</option>
                                    <option value="Plin">Plin</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                            Guardar Venta y Actualizar Stock
                        </button>
                    </form>
                </div>
                
                <!-- Columna 2: Historial de Ventas (MODIFICADO) -->
                <div class="lg:col-span-3 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Historial de Items Vendidos</h2>

                    <!-- NUEVO: Contenedor de Filtros -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        
                        <!-- Filtro Cliente -->
                        <div class="relative">
                            <label for="client-sales-filter-search" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Filtrar por Cliente</label>
                            <input type="text" id="client-sales-filter-search" placeholder="Buscar teléfono..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-brand-bg shadow-sm sm:text-sm">
                            <input type="hidden" id="client-sales-filter-id">
                            <div id="client-sales-filter-results" class="autocomplete-results hidden"></div>
                        </div>

                        <!-- Filtro Producto -->
                        <div class="relative">
                            <label for="product-sales-filter-search" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Filtrar por Producto</label>
                            <input type="text" id="product-sales-filter-search" placeholder="Buscar producto..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-brand-bg shadow-sm sm:text-sm">
                            <input type="hidden" id="product-sales-filter-id">
                            <div id="product-sales-filter-results" class="autocomplete-results hidden"></div>
                        </div>

                        <!-- Filtro Fecha -->
                        <div>
                            <label for="date-sales-filter" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Filtrar por Fecha</label>
                            <input type="date" id="date-sales-filter" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-brand-bg shadow-sm sm:text-sm">
                        </div>
                        
                        <!-- Checkbox y Botones -->
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="pending-sales-filter-toggle" class="flex items-center">
                                    <input type="checkbox" id="pending-sales-filter-toggle" checked class="h-4 w-4 text-brand-accent rounded border-gray-300 dark:border-gray-600 focus:ring-brand-accent">
                                    <span class="ml-2 text-sm text-brand-muted dark:text-gray-400">Solo Pendientes</span>
                                </label>
                            </div>
                            <button id="clear-sales-filter-btn" title="Limpiar Filtros" class="p-2 bg-gray-300 dark:bg-gray-600 text-brand-text dark:text-brand-bg rounded-md hover:bg-gray-400">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                            <button id="apply-sales-filter-btn" class="p-2 bg-brand-accent text-white rounded-md hover:bg-brand-accent-alt">
                                <i data-feather="search" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <!-- FIN: Contenedor de Filtros -->  
                    
                    <!-- NUEVO: Contenedor de Acciones Masivas -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4 items-end">
                        <div class="w-full md:w-1/3">
                            <label for="mass-shipping-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">1. Fecha de Envío Masivo</label>
                            <input type="date" id="mass-shipping-date" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-brand-bg shadow-sm sm:text-sm">
                        </div>
                        <div class="w-full md:w-2/3">
                            <button id="mass-update-shipping-btn" class="w-full md:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:ring-green-500">
                                2. Actualizar Envío de Items Seleccionados
                            </button>
                            <p class="text-xs text-brand-muted dark:text-gray-400 mt-1">Seleccione items de la tabla de abajo para marcarlos como "Enviado" con esta fecha.</p>
                        </div>
                    </div>
                    <!-- FIN: Acciones Masivas -->
                      
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- CABECERA DE TABLA MODIFICADA -->
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <!-- NUEVO: Checkbox Seleccionar Todo -->
                                    <th class="px-2 py-3 text-center">
                                        <input type="checkbox" id="select-all-sales-checkbox" class="h-4 w-4 text-brand-accent rounded border-gray-300 dark:border-gray-600 focus:ring-brand-accent">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cant.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Total Item</th>
                                    <!-- NUEVA COLUMNA -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Medio de Pago</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Estado</th>
                                    <!-- NUEVO: Columna Fecha Envío -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Fecha Envío</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Items vendidos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Productos -->
        <div id="products-panel" class="tab-panel" hidden>
             <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Columna 1: Formulario de Productos -->
                <div class="lg:col-span-1 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Agregar/Actualizar Inventario</h2>
                    <form id="add-product-form" class="space-y-4">
                        
                        <!-- MODIFICADO: Buscador de Productos (Inventario) con Autocompletado -->
                        <div class="relative">
                            <label for="product-search-inventory" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Buscar o Crear Producto</label>
                            <input type="text" id="product-search-inventory" placeholder="Escribir nombre..." class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                            <input type="hidden" id="product-inventory-id">
                            <!-- Contenedor de autocompletado -->
                            <div id="product-search-inventory-results" class="autocomplete-results hidden"></div>
                            <p class="text-xs text-brand-muted dark:text-gray-400 mt-1">Seleccione un producto para sumar stock, o escriba un nombre nuevo y guarde.</p>
                        </div>
                        
                        <div>
                            <!-- CAMBIO DE ETIQUETA -->
                            <label for="product-stock" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Stock (Cantidad a Agregar)</label>
                            <input type="number" id="product-stock" min="0" value="1" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        <div>
                            <!-- MODIFICADO: Costo (ObligatorGatorio) -->
                            <label for="product-cost" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Costo Total (por este lote)</label>

                            <input type="number" id="product-cost" required min="0" step="0.01" placeholder="Costo total del lote" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        
                        <!-- NUEVO CAMPO DE FECHA -->
                        <div>
                            <label for="product-purchase-date" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Fecha de Compra</label>
                            <input type="date" id="product-purchase-date" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-brand-bg shadow-sm focus:border-brand-accent focus:ring-brand-accent sm:text-sm">
                        </div>
                        
                        <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-accent">
                            Guardar Producto
                        </button>
                    </form>
                </div>
                
                <!-- Columna 2: Inventario -->
                <div class="lg:col-span-3 bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Inventario de Productos</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Costo (c/u)</th>
                                    <!-- NUEVA COLUMNA -->
                                    <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Última Compra</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="products-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Productos se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin del cambio -->

        <!-- MODIFICADO: Panel de Envíos (Logística) -->
        <div id="shipping-panel" class="tab-panel" hidden>
            <div class="bg-brand-card dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-brand-text dark:text-brand-bg">Vista de Logística (Envíos por Fecha)</h2>

                <!-- Filtro de Fecha -->
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4 flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-grow">
                        <label for="shipping-date-filter" class="block text-sm font-medium text-brand-muted dark:text-gray-400">Filtrar por Fecha de Envío</label>
                        <input type="date" id="shipping-date-filter" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-brand-bg shadow-sm sm:text-sm">
                    </div>
                    <button id="shipping-search-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-brand-accent hover:bg-brand-accent-alt">
                        <i data-feather="search" class="w-5 h-5 mr-2"></i>
                        Buscar Envíos
                    </button>
                </div>

                <!-- Tabla de Todos los Envíos -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Cliente (Teléfono)</th>
                                <!-- MODIFICADO: Columna Detalle -->
                                <th class="px-6 py-3 text-left text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Detalle del Envío</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-brand-muted dark:text-gray-400 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="all-shipments-list" class="bg-brand-card dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <tr><td colspan="3" class="px-6 py-4 text-center text-brand-muted dark:text-gray-400">Seleccione una fecha y presione "Buscar".</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- FIN: Panel de Envíos -->

        <footer class="pt-10 pb-2 bg-bg-soft flex-shrink-0 flex justify-center items-center gap-2 text-gray-500 text-sm mt-auto">
            <span>Powered by</span>
                <svg height="20" viewBox="0 0 90 22" xmlns="http://www.w3.org/2000/svg">
                    <text x="0" y="18" style="font-family: Quicksand, sans-serif; font-size: 20px; font-weight: 700; fill: #D96B4F;">Latam5S</text>
                </svg>
        </footer>

    </div>

    <!-- Modal para mensajes -->
    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 dark:bg-gray-800 dark:bg-opacity-75" hidden>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-brand-card dark:bg-gray-700 rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-lg font-semibold text-brand-text dark:text-brand-bg">Cargando...</h3>
                <div class="mt-2">
                    <p id="modal-message" class="text-sm text-brand-muted dark:text-gray-300">Por favor, espere.</p>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-brand-accent hover:bg-brand-accent-alt border border-transparent rounded-md" hidden>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // MODIFICADO: Importar funciones de autenticación
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setLogLevel, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            orderBy,
            limit,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANEJO DE MODO OSCURO (DE LA CONFIGURACIÓN PROPORCIONADA) ---
        function setupDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }

            toggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isNowDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isNowDark);
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });
            
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
        document.addEventListener('DOMContentLoaded', setupDarkMode);


        // --- VARIABLES GLOBALES ---
        let db, auth, app;
        let userId;
        let isAuthReady = false;
        
        // Colecciones de Firestore
        let clientsCollection, salesCollection, productsCollection;
        let saleItemsCollection;
        // ELIMINADAS: shipmentsCollection, allShipmentsCollection

        // Estado temporal
        let currentSaleItems = [];
        let currentSaleTotal = 0;
        let productsCache = {}; // Cache para stock y costos
        
        // Listeners de OnSnapshot
        let salesListener = null;
        
        // --- MODIFICADO: Cache para los buscadores ---
        let allClientsCache = []; // { id, name, phone, normalizedText }
        let allProductsCache = []; // { id, name, stock, costo }

        // --- NUEVO: IDs DE ELEMENTOS DEL DOM (MOVIMOS TODO AQUÍ) ---
        
        // Elementos de Autenticación
        const authContainer = document.getElementById('auth-container');
        const loginView = document.getElementById('login-view');
        const loginForm = document.getElementById('login-form');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const mainApp = document.getElementById('main-app');
        const logoutButton = document.getElementById('logoutButton');
        
        // Elementos de Pestañas y Modal
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.tab-panel');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Elementos Pestaña Clientes (ELIMINADOS)

        // Elementos Pestaña Ventas
        const saleForm = document.getElementById('add-sale-form');
        const salesList = document.getElementById('sales-list');
        const addSaleItemBtn = document.getElementById('add-sale-item-btn');
        const currentSaleItemsList = document.getElementById('current-sale-items');
        const currentSaleTotalEl = document.getElementById('current-sale-total');
        // ELIMINADO: newClientFields

        // Elementos Pestaña Productos
        const productForm = document.getElementById('add-product-form');
        const productsList = document.getElementById('products-list');

        // --- NUEVO: Elementos Pestaña Envíos (Logística) ---
        const shippingPanel = document.getElementById('shipping-panel');
        const shippingDateFilter = document.getElementById('shipping-date-filter');
        const shippingSearchBtn = document.getElementById('shipping-search-btn');
        const allShipmentsList = document.getElementById('all-shipments-list');
        // --- FIN ---

        // --- NUEVO: Elementos Filtro Ventas ---
        const clientSalesFilterSearch = document.getElementById('client-sales-filter-search');
        const clientSalesFilterId = document.getElementById('client-sales-filter-id');
        const clientSalesFilterResults = document.getElementById('client-sales-filter-results');
        const productSalesFilterSearch = document.getElementById('product-sales-filter-search');
        const productSalesFilterId = document.getElementById('product-sales-filter-id');
        const productSalesFilterResults = document.getElementById('product-sales-filter-results');
        const dateSalesFilter = document.getElementById('date-sales-filter');
        const pendingSalesFilterToggle = document.getElementById('pending-sales-filter-toggle');
        const applySalesFilterBtn = document.getElementById('apply-sales-filter-btn');
        const clearSalesFilterBtn = document.getElementById('clear-sales-filter-btn');
        
        // --- NUEVO: Elementos Acciones Masivas Ventas ---
        const massShippingDateInput = document.getElementById('mass-shipping-date');
        const massUpdateShippingBtn = document.getElementById('mass-update-shipping-btn');
        const selectAllSalesCheckbox = document.getElementById('select-all-sales-checkbox');
        // --- FIN ---

        // Elementos de Buscadores (Autocompletado)
        const clientSearchInput = document.getElementById('client-search');
        const clientSearchHiddenId = document.getElementById('sale-client-id');
        const clientSearchResults = document.getElementById('client-search-results');
        
        const saleProductSearchInput = document.getElementById('sale-product-search');
        const saleProductHiddenId = document.getElementById('sale-product-id');
        const saleProductSearchResults = document.getElementById('sale-product-search-results');
        
        const productInventorySearchInput = document.getElementById('product-search-inventory');
        const productInventoryHiddenId = document.getElementById('product-inventory-id');
        const productInventorySearchResults = document.getElementById('product-search-inventory-results');
        
        // --- FIN DE IDs DE ELEMENTOS ---

        // Configuración de tu proyecto
        const appId = 'mi-app-ventas'; // O cualquier nombre que quieras
        const firebaseConfig = {
            apiKey: "AIzaSyBe_H0VfS-8K-n3Ihu-Io2q4SYDZAwbKoQ",
            authDomain: "compliventas-fc79c.firebaseapp.com",
            projectId: "compliventas-fc79c",
            storageBucket: "compliventas-fc79c.firebasestorage.app",
            messagingSenderId: "734491005717",
            appId: "1:734491005717:web:85f0be05bc345cfd6bcf1c"
        };

        // --- INICIALIZACIÓN ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // --- LÓGICA DE AUTENTICACIÓN (MUY MODIFICADA) ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- USUARIO HA INICIADO SESIÓN ---
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = user.email; // Mostrar email
                    
                    authContainer.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                    
                    try {
                        document.getElementById('sale-date').valueAsDate = new Date();
                        document.getElementById('product-purchase-date').valueAsDate = new Date();
                        document.getElementById('mass-shipping-date').valueAsDate = new Date();
                        document.getElementById('shipping-date-filter').valueAsDate = new Date();
                    } catch(e) {
                        console.warn("Error al inicializar fechas (ignorar si es la primera carga):", e.message);
                    }

                    // Definir rutas de las colecciones (dependientes del userId)
                    clientsCollection = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                    salesCollection = collection(db, `artifacts/${appId}/users/${userId}/sales`);
                    productsCollection = collection(db, `artifacts/${appId}/users/${userId}/products`);
                    saleItemsCollection = collection(db, `artifacts/${appId}/users/${userId}/saleItems`);
                    // ELIMINADAS: shipmentsCollection, allShipmentsCollection

                    isAuthReady = true;
                    // Cargar datos iniciales
                    loadClients(); // (Sigue cargando el caché en segundo plano)
                    loadSales();
                    loadProducts();


                } else {
                    // --- USUARIO NO HA INICIADO SESIÓN ---
                    userId = null;
                    isAuthReady = false;
                    
                    authContainer.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    
                    if(salesList) salesList.innerHTML = '';
                    if(productsList) productsList.innerHTML = '';
                    if(allShipmentsList) allShipmentsList.innerHTML = ''; 
                    
                    if (salesListener) salesListener(); 
                }
            });

        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
            showModal("Error de Conexión", "No se pudo conectar a Firebase. Verifique la configuración.");
        }
        
        // --- LISTENERS DE AUTENTICACIÓN ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            showModal("Iniciando Sesión", "Por favor, espere...", false);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideModal();
            } catch (error) {
                console.error("Error de login:", error.code);
                hideModal();
                showModal("Error de Login", "Correo o contraseña incorrectos. Por favor, inténtelo de nuevo.");
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showModal("Error", "No se pudo cerrar sesión.");
            }
        });
        
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            if (!email) {
                showModal("Correo Requerido", "Por favor, ingrese su correo en el campo 'Correo' para poder restablecer la contraseña.");
                return;
            }
            showModal("Procesando", "Enviando correo de restablecimiento...", false);
            try {
                await sendPasswordResetEmail(auth, email);
                hideModal();
                showModal("Correo Enviado", "Si su correo está registrado, recibirá un enlace para crear una nueva contraseña. Revise su bandeja de entrada (y spam).");
            } catch (error) {
                console.error("Error al enviar correo de restablecimiento:", error);
                hideModal();
                showModal("Error", "No se pudo enviar el correo de restablecimiento. Intente de nuevo más tarde.");
            }
        });
        // --- FIN DE LÓGICA DE AUTENTICACIÓN ---


        // --- MANEJO DE PESTAÑAS ---
        function resetTabStyles() {
            tabs.forEach(t => {
                t.classList.remove('text-brand-accent', 'border-brand-accent', 'dark:text-brand-accent-alt', 'dark:border-brand-accent-alt', 'font-semibold');
                t.classList.add('text-brand-muted', 'border-transparent', 'hover:text-brand-accent', 'dark:hover:text-brand-accent-alt', 'hover:border-brand-accent', 'font-medium');
            });
        }
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                resetTabStyles();
                panels.forEach(p => p.setAttribute('hidden', true));
                
                tab.classList.remove('text-brand-muted', 'border-transparent', 'hover:text-brand-accent', 'dark:hover:text-brand-accent-alt', 'hover:border-brand-accent');
                tab.classList.add('text-brand-accent', 'border-brand-accent', 'dark:text-brand-accent-alt', 'dark:border-brand-accent-alt', 'font-semibold');

                const panelId = tab.getAttribute('data-tab') + '-panel';
                document.getElementById(panelId).removeAttribute('hidden');
                
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });
        });
        
        // --- MANEJO DE MODAL (Mensajes) ---
        modalCloseBtn.addEventListener('click', () => modal.setAttribute('hidden', true));

        function showModal(title, message, showClose = true) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCloseBtn.style.display = showClose ? 'inline-flex' : 'none';
            modal.removeAttribute('hidden');
        }

        function hideModal() {
            modal.setAttribute('hidden', true);
        }

        // --- Formateador de moneda (ej. S/ para Soles) ---
        const currencyFormatter = new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN',
            minimumFractionDigits: 2
        });

        // --- NUEVA FUNCIÓN DE NORMALIZACIÓN ---
        function normalizeString(str) {
            if (!str) return '';
            return str
                .toUpperCase() // Convertir a mayúsculas
                .normalize("NFD") // Descomponer tildes
                .replace(/[\u0300-\u036f]/g, ""); // Eliminar tildes
        }

        // --- NUEVA FUNCIÓN PROPER CASE ---
        function toProperCase(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }

        // --- LÓGICA DE AUTOCOMPLETADO ---
        let activeAutocomplete = null; 

        function showAutocompleteResults(container, results) {
            container.innerHTML = '';
            if (results.length === 0) {
                container.classList.add('hidden');
                return;
            }
            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = item.html;
                div.onclick = () => item.onClick();
                container.appendChild(div);
            });
            container.classList.remove('hidden');
            activeAutocomplete = container;
        }

        function hideAllAutocomplete() {
            if (clientSearchResults) clientSearchResults.classList.add('hidden');
            if (saleProductSearchResults) saleProductSearchResults.classList.add('hidden');
            if (productInventorySearchResults) productInventorySearchResults.classList.add('hidden');
            if(clientSalesFilterResults) clientSalesFilterResults.classList.add('hidden');
            if(productSalesFilterResults) productSalesFilterResults.classList.add('hidden');
            activeAutocomplete = null;
        }
        
        // --- NUEVO: Función para copiar al portapapeles ---
        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Estilos para hacerlo invisible
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showModal("¡Copiado!", "Resumen copiado al portapapeles.");
            } catch (err) {
                console.error('Error al copiar:', err);
                showModal("Error", "No se pudo copiar el texto. Inténtelo manualmente.");
            }
            
            document.body.removeChild(textArea);
        }
        
        document.addEventListener('click', (e) => {
            if (activeAutocomplete) {
                if (!activeAutocomplete.contains(e.target) && 
                    e.target !== clientSearchInput &&
                    e.target !== saleProductSearchInput &&
                    e.target !== productInventorySearchInput &&
                    e.target !== clientSalesFilterSearch && 
                    e.target !== productSalesFilterSearch
                    ) {
                    hideAllAutocomplete();
                }
            }
        });

        // --- LÓGICA DEL BUSCADOR DE CLIENTES (VENTAS) ---
        clientSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length === 0) {
                hideAllAutocomplete();
                clientSearchHiddenId.value = '';
                return;
            }
            const results = allClientsCache.filter(client => 
                client.phone.includes(query)
            );
            const resultItems = results.map(client => ({
                html: `<strong>${client.phone}</strong>`,
                onClick: () => selectClient(client.id, client.phone)
            }));
            showAutocompleteResults(clientSearchResults, resultItems);
        });

        function selectClient(id, phone = '') {
            clientSearchInput.value = phone; 
            clientSearchHiddenId.value = id;
            hideAllAutocomplete();
        }

        // --- LÓGICA DEL BUSCADOR DE PRODUCTOS (VENTAS) ---
        saleProductSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length === 0) {
                hideAllAutocomplete();
                saleProductHiddenId.value = '';
                return;
            }
            const results = allProductsCache.filter(prod => 
                prod.name.toLowerCase().includes(query)
            );
            const resultItems = results.map(prod => ({
                html: `<strong>${prod.name}</strong> (Stock: ${prod.stock > 0 ? prod.stock : 'SIN STOCK'})`,
                onClick: () => selectSaleProduct(prod.id, prod.name, prod.stock)
            }));
            showAutocompleteResults(saleProductSearchResults, resultItems);
        });

        function selectSaleProduct(id, name, stock) {
            if (stock <= 0) {
                showModal("Sin Stock", `El producto "${name}" no tiene stock disponible.`);
                saleProductSearchInput.value = '';
                saleProductHiddenId.value = '';
                hideAllAutocomplete();
                return;
            }
            saleProductSearchInput.value = name;
            saleProductHiddenId.value = id;
            hideAllAutocomplete();
        }

        // --- LÓGICA DEL BUSCADOR DE PRODUCTOS (INVENTARIO) ---
        productInventorySearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            productInventoryHiddenId.value = ''; 
            if (query.length === 0) {
                hideAllAutocomplete();
                return;
            }
            const results = allProductsCache.filter(prod => 
                prod.name.toLowerCase().includes(query)
            );
            const resultItems = results.map(prod => ({
                html: `<strong>${prod.name}</strong>`,
                onClick: () => selectInventoryProduct(prod.id, prod.name)
            }));
            showAutocompleteResults(productInventorySearchResults, resultItems);
        });

        function selectInventoryProduct(id, name) {
            productInventorySearchInput.value = name;
            productInventoryHiddenId.value = id;
            hideAllAutocomplete();
        }

        // --- LÓGICA AUTOCOMPLETADO PARA FILTROS DE VENTAS ---
        clientSalesFilterSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length === 0) {
                clientSalesFilterResults.classList.add('hidden');
                clientSalesFilterId.value = '';
                return;
            }
            const results = allClientsCache.filter(client => client.phone.includes(query));
            const resultItems = results.map(client => ({
                html: `<strong>${client.phone}</strong>`,
                onClick: () => selectSalesFilterClient(client.id, client.phone)
            }));
            showAutocompleteResults(clientSalesFilterResults, resultItems);
        });

        function selectSalesFilterClient(id, phone) {
            clientSalesFilterSearch.value = phone;
            clientSalesFilterId.value = id;
            clientSalesFilterResults.classList.add('hidden');
        }

        productSalesFilterSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length === 0) {
                productSalesFilterResults.classList.add('hidden');
                productSalesFilterId.value = '';
                return;
            }
            const results = allProductsCache.filter(prod => prod.name.toLowerCase().includes(query));
            const resultItems = results.map(prod => ({
                html: `<strong>${prod.name}</strong> (Stock: ${prod.stock})`,
                onClick: () => selectSalesFilterProduct(prod.id, prod.name)
            }));
            showAutocompleteResults(productSalesFilterResults, resultItems);
        });

        function selectSalesFilterProduct(id, name) {
            productSalesFilterSearch.value = name;
            productSalesFilterId.value = id;
            productSalesFilterResults.classList.add('hidden');
        }
        // --- FIN LÓGICA AUTOCOMPLETADO FILTROS ---


        // --- LÓGICA DE CLIENTES (SOLO CARGA DE CACHÉ) ---
        function loadClients() {
            if (!isAuthReady) return; 

            // Activar la pestaña Ventas por defecto
            document.querySelector('.tab-btn[data-tab="sales"]').click();

            onSnapshot(clientsCollection, (snapshot) => {
                allClientsCache = []; // Limpiar cache
                snapshot.forEach(doc => {
                    const client = doc.data();
                    const clientId = doc.id;
                    allClientsCache.push({
                        id: clientId,
                        phone: client.phone,
                        normalizedText: client.phone.toLowerCase() 
                    });
                });
            }, (error) => {
                console.error("Error al cargar clientes:", error);
            });
        }
        // --- FIN LÓGICA CLIENTES ---
        

        // --- LÓGICA DE VENTAS (FORMULARIO) ---
        function updateSaleTotal() {
            currentSaleTotal = currentSaleItems.reduce((acc, item) => acc + item.total, 0);
            currentSaleTotalEl.textContent = currentSaleTotal.toFixed(2);
        }

        function renderCurrentSaleItems() {
            currentSaleItemsList.innerHTML = '';
            currentSaleItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center text-xs";
                li.innerHTML = `
                    <span>${item.qty} x ${toProperCase(item.desc)} ${item.color || ''} ${item.talla || ''} (S/ ${item.price.toFixed(2)} c/u)</span>
                    <button type="button" data-index="${index}" class="btn-remove-item text-red-500 font-bold px-1 hover:text-red-700">X</button>
                `;
                currentSaleItemsList.appendChild(li);
            });
            updateSaleTotal();
        }

        currentSaleItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove-item')) {
                const index = parseInt(e.target.getAttribute('data-index'), 10);
                currentSaleItems.splice(index, 1);
                renderCurrentSaleItems();
            }
        });

        addSaleItemBtn.addEventListener('click', async () => {
            const qty = parseInt(document.getElementById('sale-item-qty').value, 10);
            const totalPrice = parseFloat(document.getElementById('sale-item-price').value);

            if (!qty || qty <= 0) {
                 showModal("Datos incompletos", "La cantidad debe ser mayor a 0.");
                 return;
            }
            if (totalPrice === null || totalPrice < 0) {
                 showModal("Datos incompletos", "Debe ingresar un precio total válido.");
                 return;
            }

            const unitPrice = (totalPrice === 0) ? 0 : (totalPrice / qty); 
            const color = normalizeString(document.getElementById('sale-item-color').value.trim());
            const talla = normalizeString(document.getElementById('sale-item-talla').value.trim());
            let productCost, productStock;

            const productId = saleProductHiddenId.value;
            // MODIFICADO: Aplicar normalizeString al nombre del producto al seleccionarlo
            const productName = normalizeString(saleProductSearchInput.value);

            if (productId && productName) {
                const product = productsCache[productId];
                productCost = product.cost;
                productStock = product.stock;
            } else {
                showModal("Datos incompletos", "Seleccione un producto, cantidad y un precio de venta válido.");
                return;
            }
            
            const existingItem = currentSaleItems.find(item => item.productId === productId && item.color === color && item.talla === talla);
            if(existingItem) {
                showModal("Item duplicado", "Ese producto (con mismo color y talla) ya está en la lista. Bórrelo para agregar una nueva cantidad.");
                return;
            }

            currentSaleItems.push({
                productId,
                desc: productName,
                qty,
                price: unitPrice, 
                costo: productCost, 
                total: totalPrice, 
                totalCosto: qty * productCost,
                color: color || '',
                talla: talla || ''
            });
            renderCurrentSaleItems();

            saleProductSearchInput.value = '';
            saleProductHiddenId.value = '';
            document.getElementById('sale-item-qty').value = '1';
            document.getElementById('sale-item-price').value = '';
            document.getElementById('sale-item-color').value = '';
            document.getElementById('sale-item-talla').value = '';
        });

        saleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;

            const date = document.getElementById('sale-date').value;
            const medioDePago = document.getElementById('sale-payment-method').value;

            // --- NUEVA LÓGICA: BUSCAR O CREAR CLIENTE ---
            let finalClientId, clientName, clientPhone;
            
            const phoneQuery = clientSearchInput.value.trim();
            const selectedClientId = clientSearchHiddenId.value;

            if (!phoneQuery) {
                showModal("Venta incompleta", "Debe ingresar un teléfono de cliente.");
                return;
            }
            
            const clientData = allClientsCache.find(c => c.id === selectedClientId);
            if (clientData && clientData.phone === phoneQuery) {
                finalClientId = clientData.id;
                clientName = clientData.phone;
                clientPhone = clientData.phone;
            } else {
                showModal("Validando Cliente", "Buscando o registrando cliente...", false);
                try {
                    const q = query(clientsCollection, where("phone", "==", phoneQuery));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const existingClientDoc = querySnapshot.docs[0];
                        finalClientId = existingClientDoc.id;
                        clientName = phoneQuery;
                        clientPhone = phoneQuery;
                    } else {
                        const newClientRef = await addDoc(clientsCollection, {
                            phone: phoneQuery
                        });
                        finalClientId = newClientRef.id;
                        clientName = phoneQuery;
                        clientPhone = phoneQuery;
                    }
                } catch (error) {
                    console.error("Error al buscar/crear cliente:", error);
                    hideModal();
                    showModal("Error", "No se pudo verificar el cliente.");
                    return;
                }
            }
            // --- FIN NUEVA LÓGICA ---

            if (currentSaleItems.length === 0 || !date || !medioDePago) {
                showModal("Venta incompleta", "Agregue al menos un item, elija una fecha y un medio de pago.");
                return;
            }
            
            const totalCostoVenta = currentSaleItems.reduce((acc, item) => acc + item.totalCosto, 0);

            showModal("Procesando Venta", "Guardando y actualizando stock...", false);

            try {
                const newSaleRef = await addDoc(salesCollection, { 
                    clientId: finalClientId, 
                    clientName,
                    clientPhone,
                    date,
                    medioDePago: medioDePago, 
                    items: currentSaleItems,
                    total: currentSaleTotal,
                    totalCosto: totalCostoVenta, 
                    enviado: false 
                });

                for (const item of currentSaleItems) {
                    await addDoc(saleItemsCollection, {
                        saleId: newSaleRef.id, 
                        clientId: finalClientId,
                        clientName: clientName,
                        date: date,
                        medioDePago: medioDePago, 
                        enviado: false, 
                        fechaEnvio: '', // Importante inicializarlo
                        productId: item.productId,
                        desc: item.desc,
                        qty: item.qty,
                        price: item.price,
                        costo: item.costo,
                        total: item.total,
                        totalCosto: item.totalCosto,
                        color: item.color,
                        talla: item.talla
                    });
                }

                for (const item of currentSaleItems) {
                    const productRef = doc(productsCollection, item.productId);
                    const product = productsCache[item.productId];
                    if (product) {
                        const newStock = product.stock - item.qty;
                        await updateDoc(productRef, { stock: newStock });
                    }
                }

                saleForm.reset();
                currentSaleItems = [];
                renderCurrentSaleItems();
                document.getElementById('sale-date').valueAsDate = new Date();
                clientSearchInput.value = '';
                clientSearchHiddenId.value = '';
                
                hideModal();
                showModal("Venta Exitosa", "La venta se guardó y el stock se actualizó.");
                
            } catch (error) {
                console.error("Error al guardar venta:", error);
                hideModal();
                showModal("Error", "No se pudo guardar la venta o actualizar el stock.");
            }
        });

        // --- LÓGICA DE VENTAS (HISTORIAL Y FILTROS) ---
        function loadSales() {
            if (!isAuthReady) return;
            if (salesListener) salesListener();

            const filtroCliente = clientSalesFilterId.value;
            const filtroProducto = productSalesFilterId.value;
            const filtroFecha = dateSalesFilter.value;
            const soloPendientes = pendingSalesFilterToggle.checked;
            
            let q = query(saleItemsCollection, orderBy("date", "desc"));

            const isFiltering = filtroCliente || filtroProducto || filtroFecha;

            if (filtroCliente) q = query(q, where("clientId", "==", filtroCliente));
            if (filtroProducto) q = query(q, where("productId", "==", filtroProducto));
            if (filtroFecha) q = query(q, where("date", "==", filtroFecha));
            if (soloPendientes || !isFiltering) q = query(q, where("enviado", "==", false));
            
            salesListener = onSnapshot(q, (snapshot) => {
                salesList.innerHTML = '';
                if (snapshot.empty) {
                    salesList.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-brand-muted dark:text-gray-400">No se encontraron items con esos filtros.</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const item = doc.data(); 
                    const tr = document.createElement('tr');
                    
                    let estadoHtml = item.enviado 
                        ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-700 text-green-800 dark:text-green-200">Enviado</span>'
                        : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-200">Pendiente</span>';
                    
                    let productDesc = toProperCase(item.desc);
                    if (item.color) productDesc += ` (${toProperCase(item.color)})`;
                    if (item.talla) productDesc += ` [${item.talla}]`;

                    tr.innerHTML = `
                        <td class="px-2 py-4 text-center">
                            <input type="checkbox" class="sale-item-checkbox" data-item-id="${doc.id}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${item.clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${productDesc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.qty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${currencyFormatter.format(item.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.medioDePago || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${estadoHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${item.fechaEnvio || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-item-id="${doc.id}" class="btn-delete-sale-item text-red-600 hover:text-red-900">Eliminar Item</button>
                        </td>
                    `;
                    salesList.appendChild(tr);
                });
            }, (error) => {
                console.error("Error al cargar items de ventas (¡REVISA SI NECESITAS UN ÍNDICE!):", error);
                salesList.innerHTML = `<tr><td colspan="10" class="px-6 py-4 text-center text-red-500">Error: ${error.message}. Es probable que necesites crear un índice en Firestore. Revisa la consola (F12).</td></tr>`;
            });
        }
        
        salesList.addEventListener('click', async (e) => {
            // MODIFICADO: Ahora busca la nueva clase 'btn-delete-sale-item'
            if (e.target.classList.contains('btn-delete-sale-item')) {
                
                // MODIFICADO: Obtiene el ID del ITEM, no de la venta
                const itemId = e.target.getAttribute('data-item-id');
                
                // MODIFICADO: Nuevo texto de confirmación
                if (confirm("¿Estás seguro de que deseas eliminar ESTE ITEM? (El total de la venta original no se recalculará y el stock no se restaurará).")) {
                    try {
                        // MODIFICADO: Lógica de eliminación simple
                        await deleteDoc(doc(saleItemsCollection, itemId));
                        showModal("Éxito", "Item eliminado.");
                        // El listener onSnapshot de loadSales() refrescará la tabla.
                        
                    } catch (error) {
                        console.error("Error al eliminar item:", error);
                        showModal("Error", "No se pudo eliminar el item.");
                    }
                }
            }
        });

        // Listeners para los botones de filtro
        applySalesFilterBtn.addEventListener('click', () => loadSales());
        
        clearSalesFilterBtn.addEventListener('click', () => {
            clientSalesFilterSearch.value = '';
            clientSalesFilterId.value = '';
            productSalesFilterSearch.value = '';
            productSalesFilterId.value = '';
            dateSalesFilter.value = '';
            pendingSalesFilterToggle.checked = true;
            loadSales();
        });
        
        // Listenlers para Acciones Masivas
        selectAllSalesCheckbox.addEventListener('change', () => {
            const isChecked = selectAllSalesCheckbox.checked;
            const itemCheckboxes = salesList.querySelectorAll('.sale-item-checkbox');
            itemCheckboxes.forEach(checkbox => checkbox.checked = isChecked);
        });

        massUpdateShippingBtn.addEventListener('click', async () => {
            if (!isAuthReady) return;
            
            const newShippingDate = massShippingDateInput.value;
            const selectedItemsCheckboxes = salesList.querySelectorAll('.sale-item-checkbox:checked');
            
            if (selectedItemsCheckboxes.length === 0) {
                showModal("Error", "No ha seleccionado ningún item de la lista.");
                return;
            }
            if (!newShippingDate) {
                showModal("Error", "Por favor, seleccione una Fecha de Envío válida.");
                return;
            }
            if (!confirm(`¿Está seguro de que desea marcar ${selectedItemsCheckboxes.length} items como "Enviado" con fecha ${newShippingDate}?`)) {
                return;
            }

            showModal("Actualización Masiva", `Actualizando ${selectedItemsCheckboxes.length} items...`, false);
            
            try {
                const batch = writeBatch(db);
                selectedItemsCheckboxes.forEach(checkbox => {
                    const itemId = checkbox.getAttribute('data-item-id');
                    const itemRef = doc(saleItemsCollection, itemId);
                    batch.update(itemRef, {
                        enviado: true,
                        fechaEnvio: newShippingDate
                    });
                });
                await batch.commit();
                
                hideModal();
                showModal("Éxito", "Items actualizados masivamente.");
                selectAllSalesCheckbox.checked = false;
                massShippingDateInput.value = '';
            } catch (error) {
                console.error("Error en actualización masiva:", error);
                hideModal();
                showModal("Error", "No se pudieron actualizar los items. " + error.message);
            }
        });
        // --- FIN Listeners Acciones Masivas ---


        // --- LÓGICA DE PRODUCTOS (INVENTARIO) ---
        async function createOrUpdateProduct(name, stockToAdd, newUnitCost, purchaseDate) {
            if (stockToAdd <= 0 || newUnitCost < 0 || !name || !purchaseDate) {
                throw new Error("Datos de producto inválidos. Se requiere nombre, stock positivo, costo >= 0 y fecha.");
            }
            
            const q = query(productsCollection, where("name", "==", name));
            const querySnapshot = await getDocs(q);
            let productId;

            if (querySnapshot.empty) {
                const newDocRef = await addDoc(productsCollection, { 
                    name: name, 
                    stock: stockToAdd, 
                    cost: newUnitCost,
                    purchaseDate: purchaseDate
                });
                productId = newDocRef.id;
            } else {
                const productDoc = querySnapshot.docs[0];
                const productRef = productDoc.ref;
                productId = productDoc.id;
                const productData = productDoc.data();

                const oldStock = productData.stock || 0;
                const oldCost = productData.cost || 0;
                const newTotalStock = oldStock + stockToAdd;

                let newAverageCost = newUnitCost; 
                if (newTotalStock > 0) { 
                    const oldTotalValue = oldStock * oldCost;
                    const newTotalValue = stockToAdd * newUnitCost; 
                    newAverageCost = (oldTotalValue + newTotalValue) / newTotalStock;
                }
                await updateDoc(productRef, {
                    stock: newTotalStock,
                    cost: newAverageCost,
                    purchaseDate: purchaseDate
                });
            }
            return productId;
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            
            const name = normalizeString(productInventorySearchInput.value.trim());
            const stockToAdd = parseInt(document.getElementById('product-stock').value, 10);
            const totalCost = parseFloat(document.getElementById('product-cost').value);
            const purchaseDate = document.getElementById('product-purchase-date').value;
            
            if (!purchaseDate) {
                showModal("Datos incompletos", "Debe seleccionar una fecha de compra.");
                return;
            }
            if (!name) {
                showModal("Datos incompletos", "Debe ingresar un nombre de producto.");
                return;
            }
            if (!stockToAdd || stockToAdd <= 0) {
                 showModal("Datos incompletos", "La cantidad a agregar debe ser mayor a 0.");
                 return;
            }
            if (totalCost === null || totalCost < 0) {
                 showModal("Datos incompletos", "Debe ingresar un costo total válido.");
                 return;
            }

            const newUnitCost = (totalCost === 0) ? 0 : (totalCost / stockToAdd);
            showModal("Actualizando Inventario", "Guardando producto...", false);

            try {
                await createOrUpdateProduct(name, stockToAdd, newUnitCost, purchaseDate);
                hideModal();
                showModal("Éxito", `Inventario de "${name}" actualizado.`);
                productForm.reset();
                document.getElementById('product-purchase-date').valueAsDate = new Date();
                productInventorySearchInput.value = '';
                productInventoryHiddenId.value = '';            
            } catch (error) {
                console.error("Error al guardar/actualizar producto:", error);
                hideModal();
                showModal("Error", "No se pudo actualizar el inventario. " + error.message);
            }
        });

        function loadProducts() {
            if (!isAuthReady) return;

            onSnapshot(productsCollection, (snapshot) => {
                productsList.innerHTML = '';
                allProductsCache = [];
                productsCache = {};

                snapshot.forEach(doc => {
                    const product = doc.data();
                    const productId = doc.id;
                    productsCache[productId] = { ...product, id: productId }; 

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${toProperCase(product.name)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${currencyFormatter.format(product.cost)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">${product.purchaseDate || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${productId}" class="btn-delete-product text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    `;
                    productsList.appendChild(tr);

                    allProductsCache.push({
                        id: productId,
                        name: product.name,
                        stock: product.stock,
                        cost: product.cost
                    });
                });
            }, (error) => {
                console.error("Error al cargar productos:", error);
                if (error.code === 'permission-denied' || error.code === 'failed-precondition') {
                    showModal("Error de Permisos", "No se pudieron cargar los productos. Asegúrese de que las reglas de seguridad de su proyecto Firestore estén configuradas correctamente para permitir lecturas en la ruta 'users/" + userId + "/products'.");
                }
            });
        }
        
        productsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-delete-product')) {
                const id = e.target.getAttribute('data-id');
                // MODIFICACIÓN: Lógica de eliminación segura de productos
                showModal("Verificando...", "Revisando historial de ventas...", false);
                try {
                    const q = query(saleItemsCollection, where("productId", "==", id), limit(1));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        hideModal();
                        showModal("No se puede eliminar", "Este producto tiene ventas asociadas y no puede ser eliminado.");
                        return;
                    }

                    hideModal();
                    if (confirm("¿Estás seguro de que deseas eliminar este producto? No tiene ventas asociadas.")) {
                        await deleteDoc(doc(productsCollection, id));
                        showModal("Éxito", "Producto eliminado.");
                    }
                } catch (error) {
                    hideModal();
                    showModal("Error", "No se pudo verificar o eliminar el producto.");
                }
            }
        });


        // --- LÓGICA DE LA PESTAÑA DE ENVÍOS (LOGÍSTICA) ---
        // MODIFICADO: Leer de 'saleItems' en lugar de 'allShipments'
        shippingSearchBtn.addEventListener('click', () => {
            loadAllShipments();
        });

        async function loadAllShipments() {
            if (!isAuthReady) return;

            const filterDate = shippingDateFilter.value;
            if (!filterDate) {
                showModal("Error", "Por favor, seleccione una fecha para buscar.");
                return;
            }

            allShipmentsList.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-brand-muted dark:text-gray-400">Buscando envíos...</td></tr>';
            
            try {
                // 1. Crear la consulta a saleItems (¡Necesitará índice!)
                const q = query(saleItemsCollection, 
                                where("enviado", "==", true), 
                                where("fechaEnvio", "==", filterDate),
                                orderBy("clientName") // Ordenar por cliente
                            );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    allShipmentsList.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-brand-muted dark:text-gray-400">No se encontraron envíos para esta fecha.</td></tr>';
                    return;
                }
                
                // 2. Agrupar los items por cliente en el navegador
                const shipmentsByClient = new Map();
                querySnapshot.forEach(doc => {
                    const item = doc.data();
                    const clientId = item.clientId;

                    if (!shipmentsByClient.has(clientId)) {
                        shipmentsByClient.set(clientId, {
                            clienteName: item.clientName,
                            fechaEnvio: item.fechaEnvio,
                            items: []
                        });
                    }
                    // Añadir el item (en el formato que espera Wpp)
                    shipmentsByClient.get(clientId).items.push({
                        desc: item.desc,
                        qty: item.qty,
                        color: item.color,
                        talla: item.talla,
                        description: `${item.qty} x ${item.desc} ${item.color || ''} ${item.talla || ''}`
                    });
                });

                // 3. Renderizar la tabla con los datos agrupados
                allShipmentsList.innerHTML = ''; 
                
                shipmentsByClient.forEach((shipment, clientId) => {
                    
                    // --- NUEVO: Ordenar los items alfabéticamente ---
                    shipment.items.sort((a, b) => {
                        const descA = a.desc || a.description || '';
                        const descB = b.desc || b.description || '';
                        return descA.localeCompare(descB);
                    });
                    // --- FIN NUEVO ---

                    const itemsJson = JSON.stringify(shipment.items);
                    
                    // --- NUEVO: Lógica de agrupación y formato para la tabla ---
                    const groupedItems = new Map();
                    let totalPrendas = 0; // (No se usa aquí, pero se mantiene para la lógica de parseo)

                    // 1. Parsear y Agrupar items (lógica copiada de generateShipmentWhatsAppSummary)
                    shipment.items.forEach(item => {
                        let qty = 0;
                        let desc = '';
                        let color = '';
                        let talla = '';
                        let isGroupable = false;

                        if (item.desc) {
                            qty = item.qty || 0;
                            desc = item.desc;
                            color = item.color || '';
                            talla = item.talla || '';
                            isGroupable = true;
                        } else { 
                            const match = item.description.match(/^(\d+)\s*x\s*(.*?)(?:\(|\s|$)/i);
                            if (match && match[1] && match[2]) {
                                qty = parseInt(match[1], 10);
                                desc = match[2].trim();
                                color = '';
                                talla = '';
                                isGroupable = true;
                            } else {
                                isGroupable = false;
                                const key = item.description;
                                if (groupedItems.has(key)) {
                                    groupedItems.get(key).qty += 1;
                                } else {
                                    groupedItems.set(key, { isOld: true, description: item.description, qty: 1 });
                                }
                                qty = 1;
                            }
                        }
                        totalPrendas += qty;

                        if (isGroupable) {
                            const normalizedDesc = normalizeString(desc);
                            const normalizedColor = normalizeString(color);
                            const normalizedTalla = normalizeString(talla);
                            const key = `${normalizedDesc}::${normalizedColor}::${normalizedTalla}`;
                            const existing = groupedItems.get(key);
                            
                            if (existing) {
                                existing.qty += qty;
                            } else {
                                groupedItems.set(key, { 
                                    isOld: false, 
                                    desc: desc,
                                    qty: qty, 
                                    color: color, 
                                    talla: talla 
                                });
                            }
                        }
                    });

                    // 2. Convertir a Array y Ordenar
                    const itemsArray = Array.from(groupedItems.values());
                    itemsArray.sort((a, b) => {
                        const descA = a.desc || a.description || '';
                        const descB = b.desc || b.description || '';
                        return descA.localeCompare(descB);
                    });

                    // 3. Construir el HTML
                    let itemsHtml = '';
                    for (const item of itemsArray) {
                        if (item.isOld) {
                            itemsHtml += `<li class="text-xs">🌻 ${toProperCase(item.description)}</li>`;
                        } else {
                            let mainDesc = `<strong class="text-brand-text dark:text-brand-bg">${item.qty} x ${toProperCase(item.desc)}</strong>`;
                            let attributes = [];
                            if (item.color) {
                                attributes.push(`color: ${item.color.toLowerCase()}`);
                            }
                            if (item.talla) {
                                attributes.push(`talla: ${item.talla}`);
                            }
                            
                            itemsHtml += `<li class="text-xs">🌻 ${mainDesc}`;
                            if (attributes.length > 0) {
                                itemsHtml += ` <em class="text-brand-muted dark:text-gray-400">(${attributes.join(', ')})</em>`;
                            }
                            itemsHtml += `</li>`;
                        }
                    }
                    // --- FIN DE LA NUEVA LÓGICA ---

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-brand-text dark:text-brand-bg">${shipment.clienteName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-brand-muted dark:text-gray-400">
                            <ul class="list-none space-y-1">${itemsHtml}</ul>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <!-- MODIFICADO: Botones con iconos -->
                            <button 
                              class="btn-copy-shipment p-2 inline-flex items-center justify-center rounded-md bg-blue-500 hover:bg-blue-600 text-white"
                              title="Copiar Resumen"
                              data-shipment-date="${shipment.fechaEnvio}"
                              data-client-name="${shipment.clienteName}"
                              data-items="${encodeURIComponent(itemsJson)}"
                            >
                              <i data-feather="copy" class="w-4 h-4"></i>
                            </button>
                            <button 
                              class="btn-whatsapp-shipment p-2 inline-flex items-center justify-center rounded-md bg-green-500 hover:bg-green-600 text-white"
                              title="Enviar por WhatsApp"
                              data-shipment-date="${shipment.fechaEnvio}"
                              data-client-name="${shipment.clienteName}"
                              data-client-phone="${shipment.clienteName}" 
                              data-items="${encodeURIComponent(itemsJson)}"
                            >
                              <i data-feather="send" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    allShipmentsList.appendChild(tr);
                });

            } catch(error) {
                console.error("Error al cargar envíos (¡REVISA SI NECESITAS UN ÍNDICE!):", error);
                allShipmentsList.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error: ${error.message}. Es probable que necesites crear un índice en Firestore. Revisa la consola (F12).</td></tr>`;
            }
        }

        allShipmentsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-whatsapp-shipment')) {
                const button = e.target;
                try {
                    const clientName = button.getAttribute('data-client-name');
                    const clientPhone = button.getAttribute('data-client-phone');
                    const shipmentDate = button.getAttribute('data-shipment-date');
                    const items = JSON.parse(decodeURIComponent(button.getAttribute('data-items')));
                    
                    generateShipmentWhatsAppSummary(clientName, clientPhone, shipmentDate, items);
                } catch (error) {
                    console.error("Error al parsear datos del envío:", error);
                    showModal("Error", "No se pudieron cargar los datos para el resumen.");
                }
            }
            
            // --- NUEVO: Listener para el botón de Copiar ---
            if (e.target.classList.contains('btn-copy-shipment')) {
                const button = e.target;
                try {
                    const clientName = button.getAttribute('data-client-name');
                    const shipmentDate = button.getAttribute('data-shipment-date');
                    const items = JSON.parse(decodeURIComponent(button.getAttribute('data-items')));
                    
                    // 1. Construir el mensaje
                    const message = buildShipmentMessage(clientName, shipmentDate, items);
                    // 2. Copiar al portapapeles
                    copyTextToClipboard(message);

                } catch (error) {
                    console.error("Error al parsear datos para copiar:", error);
                    showModal("Error", "No se pudieron cargar los datos para copiar.");
                }
            }
        });
        // --- FIN DE LÓGICA DE PESTAÑA DE ENVÍOS ---


        // --- NUEVA FUNCIÓN: Construye el texto del mensaje ---
        function buildShipmentMessage(clientName, shipmentDate, items) {
            
            let message = `*Compras incluidas en tu envío* 📦\n\n`; // Emoji 📦 eliminado
            let totalPrendas = 0;
            const groupedItems = new Map();

            // --- PASO 1: Parsear y Agrupar items ---
            items.forEach(item => {
                
                let qty = 0;
                let desc = '';
                let color = '';
                let talla = '';
                let isGroupable = false;

                // Verificar si es un item "nuevo" (con campos separados)
                if (item.desc) {
                    qty = item.qty || 0;
                    desc = item.desc;
                    color = item.color || '';
                    talla = item.talla || '';
                    isGroupable = true;
                } else { 
                    // Es un item "antiguo" (solo 'description')
                    const match = item.description.match(/^(\d+)\s*x\s*(.*?)(?:\(|\s|$)/i);
                    if (match && match[1] && match[2]) {
                        qty = parseInt(match[1], 10);
                        desc = match[2].trim();
                        color = '';
                        talla = '';
                        isGroupable = true;
                    } else {
                        isGroupable = false;
                        const key = item.description;
                        if (groupedItems.has(key)) {
                             groupedItems.get(key).qty += 1;
                        } else {
                             groupedItems.set(key, { isOld: true, description: item.description, qty: 1 });
                        }
                        qty = 1;
                    }
                }
                totalPrendas += qty;

                if (isGroupable) {
                    const normalizedDesc = normalizeString(desc);
                    const normalizedColor = normalizeString(color);
                    const normalizedTalla = normalizeString(talla);
                    const key = `${normalizedDesc}::${normalizedColor}::${normalizedTalla}`;
                    const existing = groupedItems.get(key);
                    
                    if (existing) {
                        existing.qty += qty;
                    } else {
                        groupedItems.set(key, { 
                            isOld: false, 
                            desc: desc, 
                            qty: qty, 
                            color: color, 
                            talla: talla 
                        });
                    }
                }
            });

            // --- PASO 2: Construir el mensaje a partir de los items agrupados ---
            const itemsArray = Array.from(groupedItems.values());
            itemsArray.sort((a, b) => {
                const descA = a.desc || a.description || '';
                const descB = b.desc || b.description || '';
                return descA.localeCompare(descB);
            });

            for (const item of itemsArray) {
                if (item.isOld) {
                    message += `🌻 ${toProperCase(item.description)}\n\n`; // Emoji 🌻 eliminado
                } else {
                    let mainDesc = `*${item.qty} x ${toProperCase(item.desc)}*`;
                    let attributes = [];
                    if (item.color) {
                        attributes.push(`color: ${item.color.toLowerCase()}`);
                    }
                    if (item.talla) {
                        attributes.push(`talla: ${item.talla}`);
                    }
                    
                    message += `🌻 ${mainDesc}`; // Emoji 🌻 eliminado
                    if (attributes.length > 0) {
                        message += ` _(${attributes.join(', ')})_`;
                    }
                    message += `\n\n`;
                }
            }

            message += `✅ *Total de prendas: ${totalPrendas}*\n\n`; // Emoji ✅ eliminado
            message += `_Atte. CompliCompras_ 🛍️`; // Emoji 🛍️ eliminado

            return message;
        }

        // --- FUNCIÓN DE WHATSAPP POR ENVÍO (AHORA REFACTORIZADA) ---
        function generateShipmentWhatsAppSummary(clientName, clientPhone, shipmentDate, items) {
            if (!clientName || !clientPhone || !items) {
                showModal("Error", "Faltan datos del cliente o del envío.");
                return;
            }

            // 1. Construir el mensaje
            const message = buildShipmentMessage(clientName, shipmentDate, items).normalize("NFC");

            // 2. Encodear y enviar
            const encodedMessage = encodeURIComponent(message);
            
            if (clientPhone.length < 8) {
                showModal("Error", `El número de teléfono "${clientPhone}" no parece válido.`);
                return;
            }
            const whatsappUrl = `https://wa.me/${clientPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        
    </script>
</body>
</html>
